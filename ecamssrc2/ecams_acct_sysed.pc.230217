/*-----------------------------------------------------------------
 ┌──────┬───────────────────────┐
 │ 프로그램명 │ ecams_acct_sysed.pc                          │
 ├──────┼───────────────────────┤
 │ 기      능 │ 운영서버 배포처리                            │
 ├──────┼───────────────────────┤
 │ 작  성  일 │ 2011. 07. 19                                 │
 ├──────┼───────────────────────┤
 │ 작  성  자 │ 최   병   남                                 │
 └──────┴───────────────────────┘
-----------------------------------------------------------------*/

/*---------------------------------------------------------------*/
/*		HEADER  FILE  INCLUDE                                    */
/*---------------------------------------------------------------*/
#include	<ecamsapi.h>
#include 	<ecams_util.h>

EXEC SQL INCLUDE "ecams_acct.h";



/*---------------------------------------------------------------*/
/*       USER  PROCEDURE  DEFINE                                 */
/*---------------------------------------------------------------*/
int 	DeclareSysedRsrcCursor		(char *pAcptNo, char *pPrcSys);
int 	RunSysedRsrcScript			(char *pAcptNo, char *pPrcSys, char *pRstCond);
int 	RunSysedRsrc_MCI_Script 	(char *pAcptNo, char *pPrcSys, char *pRstCond);
int 	UploadSysedRsrc				(char *pAcptNo, char *pPrcSys, char *pRstCond);
int 	UploadSysed60Rsrc			(char *pAcptNo, char *pPrcSys, char *pRstCond);



/*---------------------------------------------------------------*/
/*		USER WORK DEFINE                                         */
/*---------------------------------------------------------------*/
#define DEBUG 1
char    gSpoolGB    [2];



/*---------------------------------------------------------------*/
/*	Function  : DeclareSysedRsrcCursor                           */
/*	Action    : 배포 대상 목록 작성                              */
/*	Parameter :	pAcptNo   : 신청번호                             */
/*	            pPrcSys   : 처리단계                             */
/*	Return    : 0 : 정상, 1 : 처리대상없슴                       */
/*---------------------------------------------------------------*/
int 	DeclareSysedRsrcCursor	( char *pAcptNo
								, char *pPrcSys
								)
{
char	szSysCD                [dfSysCD];
char	szDsnCD                [dfDsnCD];
char	szRsrcName          [dfRsrcName];
char	szRsrcCD              [dfRsrcCD];
int		szVersion                       ;
int		szBefVer                        ;
char	szEditor              [dfEditor];
int		szSerNo                         ;
char	szSrcChg                   [1+1];
int		szPri                           ;
char	szAplyDate                [14+1];
char	szItemID              [dfItemID];
char	szReqCD                [dfReqCD];
char	szConfNo              [dfAcptNo];
char	szBaseItem            [dfItemID];
char	szQryCD                [dfReqCD];
char	szSysGB                    [1+1];
char	szSvrIP                [dfSvrIP];
int		szPortNo                        ;
char	szSvrCD                [dfSvrCD];
char	szSvrName              [dfSvrNM];
char	szDir                    [dfDir];
char	szVolPath                [dfDir];
char	szSysOS                [dfSysOS];
int		szSvrSeq                        ;
char	szInfo                  [dfInfo];
char	szDirPath                [dfDir];
char	szJobCD                [dfJobCD];
char	szSvrInfo            [dfSvrInfo];
int 	checkCnt                        ;
int 	tag                             ;
int		szSysStep                       ;


	EXEC SQL DECLARE SYSED_Rsrc1 CURSOR FOR
		SELECT  DISTINCT
		        A.CR_SYSCD
		      , A.CR_DSNCD
		      , A.CR_RSRCCD
		      , A.CR_RSRCNAME
		      , A.CR_JOBCD
		      , A.CR_VERSION
		      , A.CR_BEFVER
		      , A.CR_EDITOR
		      , A.CR_SERNO
		      , A.CR_PRIORITY
		      , A.CR_SRCCHG
		      , NVL(A.CR_APLYDATE, '0')
		      , A.CR_ITEMID
		      , A.CR_QRYCD
		      , A.CR_CONFNO
		      , A.CR_BASEITEM
		      , B.CR_QRYCD
		      , B.CR_SYSGB
		      , C.CM_SVRIP
		      , C.CM_PORTNO
		      , C.CM_SVRCD
		      , C.CM_SVRNAME
		      , C.CM_DIR
		      , C.CM_VOLPATH
		      , C.CM_SYSOS
		      , C.CM_SEQNO
		      , C.CM_SVRUSE
		      , D.CM_INFO
		      , F.CM_DIRPATH
		  FROM  CMR1000 B
		      , CMR1010 A
		      , CMM0031 C
		      , CMM0036 D
		      , CMM0038 E
		      , CMM0070 F
		 WHERE  A.CR_ACPTNO = :pAcptNo
		   AND  A.CR_PRCDATE IS NULL
		   AND  B.CR_ACPTNO = A.CR_ACPTNO
		   AND  A.CR_SYSCD  = C.CM_SYSCD
		   AND  (    (     B.CR_QRYCD IN ('04','16')
		              AND  C.CM_SVRCD  = DECODE(:pPrcSys, 'SYSTS', '35'
		              	                                         , '05'
		              	                       )
		   	         )
		         OR  (     B.CR_QRYCD  = '03'
		              AND  C.CM_SVRCD  = '15'
		   	         )
		         OR  (     B.CR_QRYCD  = '06'
		              AND  C.CM_SVRCD  = DECODE(:pPrcSys, 'SYSTS', '35'
		              	                                         , '05'
		              	                       )
		   	         )
		        )
		   AND  NVL(A.CR_APLYDATE,TO_CHAR(SYSDATE,'YYYYMMDDHH24MI')) <= TO_CHAR(SYSDATE,'YYYYMMDDHH24MI')
		   AND  C.CM_CLOSEDT    IS NULL
		   AND  C.CM_SVRSTOP = 'N'
		   AND  D.CM_CLOSEDT    IS NULL
		   AND  A.CR_SYSCD   = D.CM_SYSCD
		   AND  A.CR_RSRCCD  = D.CM_RSRCCD
		   AND  SUBSTR(D.CM_INFO,11,1) = '1'
		   AND  A.CR_SYSCD   = E.CM_SYSCD
		   AND  A.CR_RSRCCD  = E.CM_RSRCCD
		   AND  C.CM_SVRCD   = E.CM_SVRCD
		   AND  C.CM_SEQNO   = E.CM_SEQNO
		   AND  A.CR_SYSCD   = F.CM_SYSCD
		   AND  A.CR_DSNCD   = F.CM_DSNCD
		   AND  (    (     :pPrcSys     = 'SYSTS'
		   	          AND  A.CR_DEPLOYT = 'Y'
		   	         )
		   	     OR  (     :pPrcSys     = 'SYSED'
		   	     	  AND  A.CR_DEPLOY  = 'Y'
		   	     	 )
		   	    );

	szSysStep = 0;
	checkCnt  = 0;
	tag	      = 0;

	EXEC SQL open  SYSED_Rsrc1;
    while (1) {
		EXEC SQL fetch SYSED_Rsrc1
			INTO  :szSysCD
			    , :szDsnCD
			    , :szRsrcCD
			    , :szRsrcName
			    , :szJobCD
			    , :szVersion
			    , :szBefVer
			    , :szEditor
			    , :szSerNo
			    , :szPri
			    , :szSrcChg
			    , :szAplyDate
			    , :szItemID
			    , :szReqCD
			    , :szConfNo
			    , :szBaseItem
			    , :szQryCD
			    , :szSysGB
			    , :szSvrIP
			    , :szPortNo
			    , :szSvrCD
			    , :szSvrName
			    , :szDir
			    , :szVolPath
			    , :szSysOS
			    , :szSvrSeq
			    , :szSvrInfo
			    , :szInfo
			    , :szDirPath;

		if (checkCnt == 0 && sqlca.sqlcode == 1403) {
			checkCnt++;
			tag = 0;
			break;
		}
		else {
			tag = 1;
			break;
		}
	}
	EXEC SQL close SYSED_Rsrc1;

	if (tag == 0 ) return 0;
	return 1;
}




/*---------------------------------------------------------------*/
/*	Function  : DeclareSysed60RsrcCursor                         */
/*	Action    : 배포 대상 목록 작성                              */
/*	Parameter :	pAcptNo   : 신청번호                             */
/*	            pPrcSys   : 처리단계                             */
/*	Return    : 0 : 정상, 1 : 처리대상없슴                       */
/*---------------------------------------------------------------*/
int 	DeclareSysed60RsrcCursor	( char *pAcptNo
									, char *pPrcSys
									)
{
char	szSysCD                [dfSysCD];
char	szDsnCD                [dfDsnCD];
char	szRsrcName          [dfRsrcName];
char	szRsrcCD              [dfRsrcCD];
int		szVersion                       ;
int		szBefVer                        ;
char	szEditor              [dfEditor];
int		szSerNo                         ;
char	szSrcChg                   [1+1];
int		szPri                           ;
char	szAplyDate                [14+1];
char	szItemID              [dfItemID];
char	szReqCD                [dfReqCD];
char	szConfNo              [dfAcptNo];
char	szBaseItem            [dfItemID];
char	szQryCD                [dfReqCD];
char	szSysGB                    [1+1];
char	szSvrIP                [dfSvrIP];
int		szPortNo                        ;
char	szSvrCD                [dfSvrCD];
char	szSvrName              [dfSvrNM];
char	szDir                    [dfDir];
char	szVolPath                [dfDir];
char	szSysOS                [dfSysOS];
int		szSvrSeq                        ;
char	szInfo                  [dfInfo];
char	szDirPath                [dfDir];
char	szJobCD                [dfJobCD];
char	szSvrInfo            [dfSvrInfo];
int 	checkCnt                        ;
int 	tag                             ;
int		szSysStep                       ;


	EXEC SQL DECLARE SYSED60_Rsrc1 CURSOR FOR
		SELECT  DISTINCT
		        A.CR_SYSCD
		      , A.CR_DSNCD
		      , A.CR_RSRCCD
		      , A.CR_RSRCNAME
		      , A.CR_JOBCD
		      , A.CR_VERSION
		      , A.CR_BEFVER
		      , A.CR_EDITOR
		      , A.CR_SERNO
		      , A.CR_PRIORITY
		      , A.CR_SRCCHG
		      , NVL(A.CR_APLYDATE, '0')
		      , A.CR_ITEMID
		      , A.CR_QRYCD
		      , A.CR_CONFNO
		      , A.CR_BASEITEM
		      , B.CR_QRYCD
		      , B.CR_SYSGB
		      , C.CM_SVRIP
		      , C.CM_PORTNO
		      , C.CM_SVRCD
		      , C.CM_SVRNAME
		      , C.CM_DIR
		      , C.CM_VOLPATH
		      , C.CM_SYSOS
		      , C.CM_SEQNO
		      , C.CM_SVRUSE
		      , D.CM_INFO
		      , A.CR_DSNCD2
		  FROM  CMR1000 B
		      , CMR1010 A
		      , CMM0031 C
		      , CMM0036 D
		      , CMM0038 E
		 WHERE  A.CR_ACPTNO = :pAcptNo
		   AND  A.CR_PRCDATE IS NULL
		   AND  B.CR_ACPTNO = A.CR_ACPTNO
		   AND  A.CR_SYSCD  = C.CM_SYSCD
		   AND  A.CR_QRYCD  = '60'
		   AND  C.CM_SVRCD  = DECODE(:pPrcSys, 'SYSTS', '35'
		   	                                          , '05'
		   	                        )
		   AND  NVL(A.CR_APLYDATE,TO_CHAR(SYSDATE,'YYYYMMDDHH24MI')) <= TO_CHAR(SYSDATE,'YYYYMMDDHH24MI')
		   AND  C.CM_CLOSEDT    IS NULL
		   AND  C.CM_SVRSTOP = 'N'
		   AND  D.CM_CLOSEDT    IS NULL
		   AND  A.CR_SYSCD  = D.CM_SYSCD
		   AND  A.CR_RSRCCD = D.CM_RSRCCD
		   AND  SUBSTR(D.CM_INFO,11,1) = '1'
		   AND  A.CR_SYSCD  = E.CM_SYSCD
		   AND  A.CR_RSRCCD = E.CM_RSRCCD
		   AND  C.CM_SVRCD  = E.CM_SVRCD
		   AND  C.CM_SEQNO  = E.CM_SEQNO;

	szSysStep = 0;
	checkCnt  = 0;
	tag	      = 0;

	EXEC SQL open  SYSED60_Rsrc1;
    while (1) {
		EXEC SQL fetch SYSED60_Rsrc1
			INTO  :szSysCD
			    , :szDsnCD
			    , :szRsrcCD
			    , :szRsrcName
			    , :szJobCD
			    , :szVersion
			    , :szBefVer
			    , :szEditor
			    , :szSerNo
			    , :szPri
			    , :szSrcChg
			    , :szAplyDate
			    , :szItemID
			    , :szReqCD
			    , :szConfNo
			    , :szBaseItem
			    , :szQryCD
			    , :szSysGB
			    , :szSvrIP
			    , :szPortNo
			    , :szSvrCD
			    , :szSvrName
			    , :szDir
			    , :szVolPath
			    , :szSysOS
			    , :szSvrSeq
			    , :szSvrInfo
			    , :szInfo
			    , :szDirPath;

		if (checkCnt == 0 && sqlca.sqlcode == 1403) {
			checkCnt++;
			tag = 0;
			break;
		}
		else {
			tag = 1;
			break;
		}
	}
	EXEC SQL close SYSED60_Rsrc1;

	if (tag == 0 ) return 0;
	return 1;
}


/*---------------------------------------------------------------*/
/*	Function  : Process_SYSED                                    */
/*	Action    : 운영서버 배포처리 MAIN                           */
/*	Parameter :	pAcptNo   : 신청번호                             */
/*	            pPrcSys   : 처리단계                             */
/*	            pRstCond  : 처리결과                             */
/*	Return    : NONE                                             */
/*---------------------------------------------------------------*/
void	Process_SYSED	( char *pAcptNo
						, char *pPrcSys
						, char *pRstCond
						)
{
int		errRtCode                       ;


	sprintf(gSpoolGB, "%s", "1");
	memset(pRstCond, 0x00, sizeof(pRstCond));

	/*LOG*/sprintf(gszLogMsg,"[%s]<%s>처리시작",pAcptNo,pPrcSys);
	eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);

	/*-----------------------------------------------------------*/
	/*	자동배포 자원인 경우 적용배포 Flag Set                   */
	/*-----------------------------------------------------------*/
	EXEC SQL
		UPDATE  CMR1010 A
		   SET  CR_DEPLOY = 'Y'
		 WHERE  CR_ACPTNO = :pAcptNo
		   AND  NVL(CR_DEPLOY, 'N') = 'N'
		   AND  EXISTS (SELECT  'X'
		                  FROM  CMM0036
		                 WHERE  CM_SYSCD  = A.CR_SYSCD
		                   AND  CM_RSRCCD = A.CR_RSRCCD
		                   AND  SUBSTR(CM_INFO, 54, 1) = '1'
		               );

	EXEC SQL COMMIT;

	/*-----------------------------------------------------------*/
	/* SYSCOM 작업에 필요한 자원 정보 조회 쿼리 선언	         */
	/*-----------------------------------------------------------*/
	errRtCode = 0;
	if (strcmp(pPrcSys, "SYSMCI") != 0) {
		/*LOG*/sprintf(gszLogMsg,"[%s][%s] DeclareSysedRsrcCursor Start",pAcptNo, pPrcSys);
		eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);

		errRtCode = DeclareSysedRsrcCursor(pAcptNo, pPrcSys);

		/*LOG*/sprintf(gszLogMsg,"[%s][%s] DeclareSysedRsrcCursor returned[%d]", pAcptNo, pPrcSys, errRtCode);
		eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);

		if (errRtCode == 0) {
			strcpy(pRstCond, "9999");
			return ;
		}
	}

	/*-----------------------------------------------------------*/
	/*   신청 자원을 생성하여 대상 Server에 Upload 하고 오류가   */
	/*   있을 경우 오류건수를 리턴                               */
	/*-----------------------------------------------------------*/
	errRtCode = 0;
	if (strcmp(pPrcSys, "SYSMCI") != 0) {
		/*LOG*/sprintf(gszLogMsg,"[%s][%s] UploadSysedRsrc  start",pAcptNo, pPrcSys);
		eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);

		errRtCode = UploadSysedRsrc(pAcptNo,pPrcSys,pRstCond );

		/*LOG*/sprintf(gszLogMsg,"[%s][%s] UploadSysedRsrc returned [%s][%d]",pAcptNo, pPrcSys,pRstCond,errRtCode);
		eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);
	}
	
	if (errRtCode != 0) {
		strcpy(pRstCond, "EROR");
		return ;
	}

	/*-----------------------------------------------------------*/
	/* 대상 서버에 올라간 자원에 대한 script 실행	  	         */
	/*-----------------------------------------------------------*/
	if (strcmp(pPrcSys, "SYSMCI") != 0) {
		/*LOG*/sprintf(gszLogMsg,"[%s][%s] RunSysedRsrcScript  start",pAcptNo, pPrcSys);
		eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);

		errRtCode = 0;
		errRtCode = RunSysedRsrcScript(pAcptNo,pPrcSys,pRstCond);

		/*LOG*/sprintf(gszLogMsg,"[%s][%s] RunSysedRsrcScript returned [%s][%d]",pAcptNo, pPrcSys,pRstCond,errRtCode);
		eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);
	}
	
	if (errRtCode != 0 ) {
		strcpy(pRstCond, "EROR");
		return ;
	}

	/*-----------------------------------------------------------*/
	/* 대상 서버에 올라간 자원에 대한 script 실행	  	         */
	/*-----------------------------------------------------------*/
	/*LOG*/sprintf(gszLogMsg,"[%s][%s] RunSysedRsrc_MCI_Script  start",pAcptNo, pPrcSys);
	eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);

	errRtCode = 0;
	errRtCode = RunSysedRsrc_MCI_Script(pAcptNo,pPrcSys,pRstCond);

	/*LOG*/sprintf(gszLogMsg,"[%s][%s] RunSysedRsrc_MCI_Script returned [%s][%d]",pAcptNo, pPrcSys,pRstCond,errRtCode);
	eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);

	if (errRtCode != 0 ) {
		strcpy(pRstCond, "EROR");
		return ;
	}

	/*LOG*/sprintf(gszLogMsg,"[%s][%s] 처리완료  [%s]",pAcptNo, pPrcSys,pRstCond);
	eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);
}




/*---------------------------------------------------------------*/
/*	Function  : Process_SYSED60                                  */
/*	Action    : 운영서버 배포처리 MAIN                           */
/*	Parameter :	pAcptNo   : 신청번호                             */
/*	            pPrcSys   : 처리단계                             */
/*	            pRstCond  : 처리결과                             */
/*	Return    : NONE                                             */
/*---------------------------------------------------------------*/
void	Process_SYSED60	( char *pAcptNo
						, char *pPrcSys
						, char *pRstCond
						)
{
int		errRtCode                       ;


	sprintf(gSpoolGB, "%s", "1");
	memset(pRstCond, 0x00, sizeof(pRstCond));

	/*LOG*/sprintf(gszLogMsg,"[%s]<%s>처리시작",pAcptNo,pPrcSys);
	eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);

	/*-----------------------------------------------------------*/
	/* SYSCOM 작업에 필요한 자원 정보 조회 쿼리 선언	         */
	/*-----------------------------------------------------------*/
	/*LOG*/sprintf(gszLogMsg,"[%s][%s] DeclareSysed60RsrcCursor Start",pAcptNo, pPrcSys);
	eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);

	errRtCode = 0;
	errRtCode = DeclareSysed60RsrcCursor(pAcptNo, pPrcSys);

	/*LOG*/sprintf(gszLogMsg,"[%s][%s] DeclareSysed60RsrcCursor returned[%d]",pAcptNo, pPrcSys,errRtCode);
	eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);

	/*-----------------------------------------------------------*/
	/*   신청 자원을 생성하여 대상 Server에 Upload 하고 오류가   */
	/*   있을 경우 오류건수를 리턴                               */
	/*-----------------------------------------------------------*/
	/*LOG*/sprintf(gszLogMsg,"[%s][%s] UploadSysed60Rsrc  start",pAcptNo, pPrcSys);
	eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);

	errRtCode = 0;
	errRtCode = UploadSysed60Rsrc(pAcptNo,pPrcSys,pRstCond );

	/*LOG*/sprintf(gszLogMsg,"[%s][%s] UploadSysed60Rsrc returned [%s][%d]",pAcptNo, pPrcSys,pRstCond,errRtCode);
	eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);

	if (errRtCode != 0) {
		strcpy(pRstCond, "EROR");
		return ;
	}

	/*LOG*/sprintf(gszLogMsg,"[%s][%s] 처리완료  [%s]",pAcptNo, pPrcSys,pRstCond);
	eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);
}



/*---------------------------------------------------------------*/
/*	Function  : UploadSysedRsrc                                  */
/*	Action    : 서버로 파일 전송                                 */
/*	Parameter :	pAcptNo   : 신청번호                             */
/*	            pPrcSys   : 처리단계                             */
/*	            pRstCond  : 처리결과                             */
/*	Return    : 오류건수                                         */
/*---------------------------------------------------------------*/
int 	UploadSysedRsrc	( char *pAcptNo
						, char *pPrcSys
						, char *pRstCond
						)
{
char	szSysCD                [dfSysCD];
char	szDsnCD                [dfDsnCD];
char	szRsrcName          [dfRsrcName];
char	szRsrcCD              [dfRsrcCD];
int		szVersion                       ;
int		szBefVer                        ;
char	szEditor              [dfEditor];
int		szSerNo                         ;
char	szSrcChg                   [1+1];
int		szPri                           ;
char	szAplyDate                [14+1];
char	szItemID              [dfItemID];
char	szReqCD                [dfReqCD];
char	szConfNo              [dfAcptNo];
char	szBaseItem            [dfItemID];
char	szQryCD                [dfReqCD];
char	szSysGB                    [1+1];
char	szSvrIP                [dfSvrIP];
int		szPortNo                        ;
char	szSvrCD                [dfSvrCD];
char	szSvrName              [dfSvrNM];
char	szDir                    [dfDir];
char	szVolPath                [dfDir];
char	szSysOS                [dfSysOS];
int		szSvrSeq                        ;
char	szInfo                  [dfInfo];
char	szDirPath                [dfDir];
char	szJobCD                [dfJobCD];
char	szSvrInfo            [dfSvrInfo];
char	szchmod                      [6];
char	szchown                     [21];
char	szchgrp                     [21];
char	szReqPath                [dfDir];
char	szRstFile           [dfFullPath];
char	szBKRsrcName        [dfRsrcName];
char	szChangDirPath           [dfDir];
char	szChangDirPathTmp         [dfDir];
char	szRemoteFileName    [dfFullPath];
char	szLocalFileName     [dfFullPath];
char	szBackFileName      [dfFullPath];
char	szRemote            [dfFullPath];
char	szLocal             [dfFullPath];
char	szCommand           [dfFullPath];
char	idxFileName         [dfFullPath];
char	szFileDate                [14+1];
int		idxcnt                          ;
int		nRst                            ;
int		nPutErrCnt                      ;
int		szSysStep                       ;
char	szBasePgm           [dfRsrcName];
char	szBasePgmTmp        [dfRsrcName];
struct 	stat f_st                       ;
long	lFileSize                       ;
int		nRet                            ;
char	szBackDir1               [dfDir];
char	szBackDir2               [dfDir];
char	szBackYYYY                 [4+1];
char	szBackMM                   [2+1];
char	szIBBackDir              [dfDir];
char	szScriptFile        [dfFullPath];
char	szAcptNo06            [dfAcptNo];
FILE	*SrcPtr                         ;
CMD_INFO	CmdInfo                     ;


	memset(szReqPath, 0x00, sizeof(szReqPath));

	/*-----------------------------------------------------------*/
	/*	파일 생성시 파일이 저장될 경로 설정및 생성               */
	/*-----------------------------------------------------------*/
	SetTempDir("77",szReqPath);
	strcat(szReqPath,pAcptNo);
	if (access(szReqPath,F_OK) != 0)
		Local_Dir_Make(szReqPath);

	/*-----------------------------------------------------------*/
	/*	소켓 명령 변수 초기화                                    */
	/*-----------------------------------------------------------*/
	InitCmdInfo(&CmdInfo);
	strcpy(CmdInfo.szAcptNo,pAcptNo);
	sprintf(CmdInfo.szLogFile,"%sTransList.%s",gszLogPath,gszLogFile);

	/*-----------------------------------------------------------*/
	/*	Tar Index 파일 생성 초기화                               */
	/*-----------------------------------------------------------*/
	tar_index_init(pAcptNo,szReqPath);
	idxcnt    = 0 ;
	szSysStep = 0;

	/*-----------------------------------------------------------*/
	/*	배포대상목록에 대하여 tar index 파일 생성                */
	/*-----------------------------------------------------------*/
	EXEC SQL open  SYSED_Rsrc1;
    while (1) {
		EXEC SQL fetch SYSED_Rsrc1
			INTO  :szSysCD
 			    , :szDsnCD
 			    , :szRsrcCD
 			    , :szRsrcName
 			    , :szJobCD
 			    , :szVersion
 			    , :szBefVer
 			    , :szEditor
 			    , :szSerNo
 			    , :szPri
 			    , :szSrcChg
 			    , :szAplyDate
 			    , :szItemID
 			    , :szReqCD
 			    , :szConfNo
 			    , :szBaseItem
 			    , :szQryCD
 			    , :szSysGB
 			    , :szSvrIP
 			    , :szPortNo
 			    , :szSvrCD
 			    , :szSvrName
 			    , :szDir
 			    , :szVolPath
 			    , :szSysOS
 			    , :szSvrSeq
 			    , :szSvrInfo
 			    , :szInfo
 			    , :szDirPath;

		if (sqlca.sqlcode == 1403)	break;
		if (sqlca.sqlcode != 0 && sqlca.sqlcode != -1405) {
			sprintf(gszLogMsg,"UploadSysedRsrc DB FETCH ERROR : [%s] [%d] [%d] [%s]", pAcptNo, szSerNo, sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
			eCAMS_Log(gszLogPath, gszLogFile, gszLogMsg);
			break;
		}

		NotUseDataTruncate (szSysCD   ,	0x20);
		NotUseDataTruncate (szDsnCD   ,	0x20);
		NotUseDataTruncate (szRsrcCD  ,	0x20);
		NotUseDataTruncate (szJobCD   ,	0x20);
		NotUseDataTruncate (szEditor  ,	0x20);
		NotUseDataTruncate (szSrcChg  ,	0x20);
		NotUseDataTruncate (szAplyDate,	0x20);
		NotUseDataTruncate (szItemID  ,	0x20);
		NotUseDataTruncate (szReqCD   ,	0x20);
		NotUseDataTruncate (szConfNo  ,	0x20);
		NotUseDataTruncate (szBaseItem,	0x20);
		NotUseDataTruncate (szQryCD   , 0x20);
		NotUseDataTruncate (szSysGB   , 0x20);
		NotUseDataTruncate (szSvrIP   , 0x20);
		NotUseDataTruncate (szSvrCD   , 0x20);
		NotUseDataTruncate (szSvrName , 0x20);
		NotUseDataTruncate (szDir     , 0x20);
		NotUseDataTruncate (szVolPath , 0x20);
		NotUseDataTruncate (szSysOS   , 0x20);
		NotUseDataTruncate (szInfo    , 0x20);
		NotUseDataTruncate (szSvrInfo , 0x20);

		sprintf(szRsrcName, "%s", trunc_char(szRsrcName));
		sprintf(szDirPath , "%s", trunc_char(szDirPath));
		strcpy(szBKRsrcName,szRsrcName);

		/*-------------------------------------------------------*/
		/*	릴리즈시 홈디렉토리 배포인경우 처리                  */
		/*-------------------------------------------------------*/
		if (cmp_mid_char(szInfo,37,1,"1") == 0) {
			EXEC SQL
				SELECT  CM_VOLPATH
				  INTO  :szChangDirPathTmp
				  FROM  CMM0038 b
				 WHERE  CM_SYSCD = :szSysCD
				   AND  CM_SVRCD = :szSvrCD
				   AND  CM_SEQNO = :szSvrSeq
				   AND  CM_RSRCCD = :szRsrcCD;

			if (sqlca.sqlcode != 0) {
				/*LOG*/sprintf(gszLogMsg,"[%s][%d][%s] 기준디렉토리 없음 (CMM0038 CM_VOLPATH) [%s][%s][%d][%s] ",pAcptNo,szSerNo,pPrcSys,szSysCD,szSvrCD,szSvrSeq,szRsrcCD);
				eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);
				strcpy(pRstCond,"SIER");

				/*---------------------------------------------------*/
				/* 자원 전송 결과 작성  	                         */
				/*---------------------------------------------------*/
				Result_Make(szRstFile,"기준디렉토리 없음 (CMM0038 CM_VOLPATH)",szSvrIP, pPrcSys,pRstCond);
				CMR1011_Make (szSysCD, szSvrIP, pAcptNo, szSerNo, szRstFile, szSysStep, pRstCond, szSvrName, pPrcSys, szSvrCD,szSvrSeq);
				continue;
			}
			NotUseDataTruncate (szChangDirPathTmp, 0x20);
		}
		else {
			ChangeVolPath_NEW(pAcptNo, szSysCD , szSvrCD, szRsrcCD, szSvrSeq, szDirPath, szChangDirPathTmp);
		}

		if (cmp_right_char(szChangDirPathTmp, 1, "/") == 0) {
			sprintf(szChangDirPathTmp, "%s", left_char(szChangDirPathTmp, strlen(szChangDirPathTmp) - 1));
		}


		/*-------------------------------------------------------*/
		/*	릴리즈시 temp 저장인 경우 처리                       */
		/*-------------------------------------------------------*/
		if (cmp_mid_char(szInfo,23,1,"1") == 0) {
			memset(szChangDirPath   , 0x00, sizeof(szChangDirPath));
			sprintf(szChangDirPath  , "%s/%s", szChangDirPathTmp,"temp");
			memset(szChangDirPathTmp, 0x00   , sizeof(szChangDirPathTmp));
			strcpy(szChangDirPathTmp, szChangDirPath);
		}

		/*-------------------------------------------------------*/
		/*	OS가 윈도우인경우 디렉토리 변환                      */
		/*-------------------------------------------------------*/
		Convert_WinDirPath (szSysOS, szChangDirPathTmp, szChangDirPath);

		/*-------------------------------------------------------*/
		/*	결과파일명                                           */
		/*-------------------------------------------------------*/
		sprintf(szRstFile,"%s/%s.%d.%s.%d.result", gszTempPath, pAcptNo, szSerNo,szSvrIP,szSvrSeq);

		/*-------------------------------------------------------*/
		/*	인터넷뱅킹 백업이면 백업처리                         */
		/*	/prod/srcebkup/년도/월/신청번호/                     */
		/*	/sw/srcebkup/년도/월/신청번호/                       */
		/*-------------------------------------------------------*/
		if (cmp_mid_char(szInfo, 65, 1, "1") == 0) {
			if (strcmp(szQryCD, "04") == 0 ||
				strcmp(szQryCD, "06") == 0 ) {
				/*-----------------------------------------------*/
				/*	백업 디렉토리                                */
				/*-----------------------------------------------*/
				if (Conv_IBBackDir	(pAcptNo, szSysOS, szDirPath, szIBBackDir) != 0) {
					sprintf(gszLogMsg, "[%s] 백업디렉토리 변환 실패 [%s]", pAcptNo, szChangDirPathTmp);
					eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);

					strcpy(pRstCond,"EROR");
					Result_Make(szRstFile,"백업디렉토리 변환 실패",szSvrIP,pPrcSys,pRstCond);
					CMR1011_Make (szSysCD, szSvrIP, pAcptNo, szSerNo, szRstFile, 0, pRstCond, szSvrName, pPrcSys,szSvrCD,szSvrSeq);
					continue;
				}

				/*-----------------------------------------------*/
				/*	소켓 버퍼사이즈 SET                          */
				/*-----------------------------------------------*/
				if (Server_Buff_Size(szSysCD, szSvrCD, szSvrSeq) == FALSE) {
					sprintf(gszLogMsg, "[%s] 서버 버퍼사이즈 조회실패 : [%s] [%s] [%d]", pAcptNo, szSysCD, szSvrCD, szSvrSeq);
					eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);
					exit (1);
				}

				/*-----------------------------------------------*/
				/*	파일배포전 백업                              */
				/*-----------------------------------------------*/
				sprintf(CmdInfo.szServerIP,"%s",szSvrIP);
				CmdInfo.nPort = szPortNo;
				strcpy(CmdInfo.szJobGub, "I");
				sprintf(CmdInfo.szCommand, "%s/%s", szChangDirPath, szRsrcName);
				Server_Cmd_JOB(&CmdInfo);
				if (strcmp(CmdInfo.szRstCond, "0000") != 0) {
					sprintf(gszLogMsg, "[%s] 백업대상 파일 없음 : [%s]", pAcptNo, CmdInfo.szCommand);
					eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);
				}
				else {
					/*-------------------------------------------*/
					/*	백업 디렉토리  작성                      */
					/*-------------------------------------------*/
					strcpy(CmdInfo.szJobGub, "I");
					sprintf(CmdInfo.szCommand, "%s", szIBBackDir);
					Server_Cmd_JOB(&CmdInfo);

					if (strcmp(CmdInfo.szRstCond, "0000") != 0) {
						strcpy(CmdInfo.szJobGub, "S");
						sprintf(CmdInfo.szCommand, "mkdir -p %s", szIBBackDir);
						Server_Cmd_JOB(&CmdInfo);

						sprintf(gszLogMsg, "[%s] 백업디렉토리 작성 : [%s]", pAcptNo, szIBBackDir);
						eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);

						if (strcmp(CmdInfo.szRstCond, "0000") != 0) {
							sprintf(gszLogMsg, "[%s] 백업디렉토리 작성 실패 [%s]", pAcptNo, szIBBackDir);
							eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);

							strcpy(pRstCond, CmdInfo.szRstCond);
							Result_Make(szRstFile, gszLogMsg, szSvrIP,pPrcSys,pRstCond);
							CMR1011_Make (szSysCD, szSvrIP, pAcptNo, szSerNo, szRstFile, 0, pRstCond, szSvrName, pPrcSys,szSvrCD,szSvrSeq);
							continue;
						}
					}

					/*-------------------------------------------*/
					/*	파일배포전 백업                          */
					/*-------------------------------------------*/
					strcpy(CmdInfo.szJobGub, "I");
					sprintf(CmdInfo.szCommand, "%s/%s", szIBBackDir, szRsrcName);
					Server_Cmd_JOB(&CmdInfo);

					if (strcmp(CmdInfo.szRstCond, "0000") == 0) {
						sprintf(gszLogMsg, "[%s] 백업파일존재 SKIP : [%s/%s]", pAcptNo, szIBBackDir, szRsrcName);
						eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);

						strcpy(pRstCond, CmdInfo.szRstCond);
						sprintf(gszLogMsg, "백업파일존재 SKIP : [%s/%s]", szIBBackDir, szRsrcName);
						Result_Make(szRstFile, gszLogMsg, szSvrIP,pPrcSys,pRstCond);
						CMR1011_Make (szSysCD, szSvrIP, pAcptNo, szSerNo, szRstFile, 0, pRstCond, szSvrName, pPrcSys,szSvrCD,szSvrSeq);
					}
					else {
						sprintf(gszLogMsg, "[%s] 백업 : [%s/%s] [%s/%s]", pAcptNo, szChangDirPath, szRsrcName, szIBBackDir, szRsrcName);
						eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);


						sprintf(szScriptFile, "%s/%s_BackUp.sh", gszTempPath, pAcptNo);
					    SrcPtr = fopen (szScriptFile, "w");
					    if (SrcPtr == (FILE *)NULL) {
							sprintf(gszLogMsg, "[%s] 백업Script 작성 실패: [%s]", pAcptNo, szScriptFile);
							eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);

							strcpy(pRstCond, "EROR");
							sprintf(gszLogMsg, "백업Script 작성 실패 [%s]", CmdInfo.szCommand);
							Result_Make(szRstFile, gszLogMsg, szSvrIP, pPrcSys, pRstCond);
							CMR1011_Make (szSysCD, szSvrIP, pAcptNo, szSerNo, szRstFile, 0, pRstCond, szSvrName, pPrcSys,szSvrCD,szSvrSeq);
							continue;
					    }
					    fprintf (SrcPtr, "cp -p '%s/%s' '%s/%s'\n", szChangDirPath, szRsrcName, szIBBackDir, szRsrcName);
					    fprintf (SrcPtr, "exit $?\n");
					    fclose  (SrcPtr);
					    fflush  (SrcPtr);


						strcpy(CmdInfo.szJobGub , "F");
						sprintf(CmdInfo.szLocal , "%s/%s_BackUp.sh", gszTempPath, pAcptNo);
						sprintf(CmdInfo.szRemote, "%s/%s_BackUp.sh", szDir     , pAcptNo);
						Server_Cmd_JOB(&CmdInfo);
						remove (CmdInfo.szLocal);

						if (strcmp(CmdInfo.szRstCond, "0000") != 0) {
							sprintf(gszLogMsg, "[%s] 백업Script 전송 실패: [%s]", pAcptNo, CmdInfo.szRemote);
							eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);

							strcpy(pRstCond, "EROR");
							sprintf(gszLogMsg, "백업Script 전송 실패 [%s]", CmdInfo.szRemote);
							Result_Make(szRstFile, gszLogMsg, szSvrIP, pPrcSys, pRstCond);
							CMR1011_Make (szSysCD, szSvrIP, pAcptNo, szSerNo, szRstFile, 0, pRstCond, szSvrName, pPrcSys,szSvrCD,szSvrSeq);
							continue;
						}

						strcpy(CmdInfo.szJobGub, "S");
						sprintf(CmdInfo.szCommand, "chmod 777 %s", CmdInfo.szRemote);
						Server_Cmd_JOB(&CmdInfo);


						strcpy(CmdInfo.szJobGub, "S");
						sprintf(CmdInfo.szCommand, "%s", CmdInfo.szRemote);
						Server_Cmd_JOB(&CmdInfo);
						strcpy(pRstCond, CmdInfo.szRstCond);

						strcpy(CmdInfo.szJobGub, "S");
						sprintf(CmdInfo.szCommand, "rm -f %s", CmdInfo.szRemote);
						Server_Cmd_JOB(&CmdInfo);

						sprintf(CmdInfo.szCommand, "cp -p '%s/%s' '%s/%s'", szChangDirPath, szRsrcName, szIBBackDir, szRsrcName);
						if (strcmp(pRstCond, "0000") != 0) {
							sprintf(gszLogMsg, "[%s] 백업실패 [%s]", pAcptNo, CmdInfo.szCommand);
							eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);

							sprintf(gszLogMsg, "백업실패 [%s]", CmdInfo.szCommand);
							Result_Make(szRstFile, gszLogMsg, szSvrIP, pPrcSys, pRstCond);
							CMR1011_Make (szSysCD, szSvrIP, pAcptNo, szSerNo, szRstFile, 0, pRstCond, szSvrName, pPrcSys,szSvrCD,szSvrSeq);
							continue;
						}
						else {
							sprintf(gszLogMsg, "[%s] 백업성공 [%s]", pAcptNo, CmdInfo.szCommand);
							eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);

							sprintf(gszLogMsg, "백업성공 [%s]", CmdInfo.szCommand);
							Result_Make(szRstFile, gszLogMsg, szSvrIP, pPrcSys, pRstCond);
							CMR1011_Make (szSysCD, szSvrIP, pAcptNo, szSerNo, szRstFile, 0, pRstCond, szSvrName, pPrcSys,szSvrCD,szSvrSeq);
						}


						sprintf(gszLogMsg, "[%s] 백업결과 작성 : [%s/%s] [%s/%s]", pAcptNo, szChangDirPath, szRsrcName, szIBBackDir, szRsrcName);
						eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);


						sprintf(szScriptFile, "%s/%s_BackUp.sh", gszTempPath, pAcptNo);
					    SrcPtr = fopen (szScriptFile, "w");
					    if (SrcPtr == (FILE *)NULL) {
							sprintf(gszLogMsg, "[%s] 백업Script 작성 실패: [%s]", pAcptNo, szScriptFile);
							eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);

							strcpy(pRstCond, "EROR");
							sprintf(gszLogMsg, "백업Script 작성 실패 [%s]", CmdInfo.szCommand);
							Result_Make(szRstFile, gszLogMsg, szSvrIP, pPrcSys, pRstCond);
							CMR1011_Make (szSysCD, szSvrIP, pAcptNo, szSerNo, szRstFile, 0, pRstCond, szSvrName, pPrcSys,szSvrCD,szSvrSeq);
							continue;
					    }
					    fprintf (SrcPtr, "ls -l '%s/%s' '%s/%s' 1>%s/%s.lsf 2>/dev/null\n", szChangDirPath, szRsrcName, szIBBackDir, szRsrcName, szDir, pAcptNo);
					    fclose  (SrcPtr);
					    fflush  (SrcPtr);


						strcpy(CmdInfo.szJobGub , "F");
						sprintf(CmdInfo.szLocal , "%s/%s_BackUp.sh", gszTempPath, pAcptNo);
						sprintf(CmdInfo.szRemote, "%s/%s_BackUp.sh", szDir     , pAcptNo);
						Server_Cmd_JOB(&CmdInfo);
						remove (CmdInfo.szLocal);

						if (strcmp(CmdInfo.szRstCond, "0000") != 0) {
							sprintf(gszLogMsg, "[%s] 백업Script 전송 실패: [%s]", pAcptNo, CmdInfo.szRemote);
							eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);

							strcpy(pRstCond, "EROR");
							sprintf(gszLogMsg, "백업Script 전송 실패 [%s]", CmdInfo.szRemote);
							Result_Make(szRstFile, gszLogMsg, szSvrIP, pPrcSys, pRstCond);
							CMR1011_Make (szSysCD, szSvrIP, pAcptNo, szSerNo, szRstFile, 0, pRstCond, szSvrName, pPrcSys,szSvrCD,szSvrSeq);
							continue;
						}

						strcpy(CmdInfo.szJobGub, "S");
						sprintf(CmdInfo.szCommand, "chmod 777 %s", CmdInfo.szRemote);
						Server_Cmd_JOB(&CmdInfo);


						strcpy(CmdInfo.szJobGub, "S");
						sprintf(CmdInfo.szCommand, "%s", CmdInfo.szRemote);
						Server_Cmd_JOB(&CmdInfo);
						strcpy(pRstCond, CmdInfo.szRstCond);

						strcpy(CmdInfo.szJobGub, "S");
						sprintf(CmdInfo.szCommand, "rm -f %s", CmdInfo.szRemote);
						Server_Cmd_JOB(&CmdInfo);

						strcpy(CmdInfo.szJobGub , "G");
						sprintf(CmdInfo.szRemote, "%s/%s.lsf", szDir, pAcptNo);
						sprintf(CmdInfo.szLocal , "%s/%s.lsf", gszTempPath, pAcptNo);
						Server_Cmd_JOB(&CmdInfo);
						File_Encoding(CmdInfo.szLocal);
						strcpy(pRstCond, CmdInfo.szRstCond);
											
						strcpy(CmdInfo.szJobGub, "S");
						sprintf(CmdInfo.szCommand, "rm -f %s", CmdInfo.szRemote);
						Server_Cmd_JOB(&CmdInfo);

						if (strcmp(pRstCond, "0000") != 0) {
							sprintf(gszLogMsg, "[%s] 백업결과 수신 실패 [%s]", pAcptNo, CmdInfo.szRemote);
							eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);

							sprintf(gszLogMsg, "백업결과 수신 실패 [%s]", CmdInfo.szCommand);
							Result_Make(szRstFile, gszLogMsg, szSvrIP, pPrcSys, pRstCond);
							CMR1011_Make (szSysCD, szSvrIP, pAcptNo, szSerNo, szRstFile, 0, pRstCond, szSvrName, pPrcSys,szSvrCD,szSvrSeq);

							remove (CmdInfo.szLocal);
							continue;
						}
						else {
							sprintf(gszLogMsg, "[%s] 백업결과 수신 정상 [%s]", pAcptNo, CmdInfo.szRemote);
							eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);

							File_Merge(szRstFile, CmdInfo.szLocal, szSvrIP, "백업결과", 1);
							CMR1011_Make (szSysCD, szSvrIP, pAcptNo, szSerNo, szRstFile, 0, pRstCond, szSvrName, pPrcSys,szSvrCD,szSvrSeq);
						}
						remove (CmdInfo.szLocal);
					}
				}
			}

			if (strcmp(szQryCD, "06") == 0) {
				/*-----------------------------------------------*/
				/*	이전버전의 다음 적용신청번호 찿기            */
				/*-----------------------------------------------*/
				EXEC SQL
					SELECT  CR_ACPTNO
					  INTO  :szAcptNo06
					  FROM  CMR0021
					 WHERE  CR_ITEMID = :szItemID
					   AND  CR_VER    = :szBefVer
					   AND  SUBSTR(CR_ACPTNO, 5, 2) != '06';

				if (sqlca.sqlcode != 0) {
					/*LOG*/sprintf(gszLogMsg,"[%s] [%s][%s] 롤백버전의 신청번호 조회 실패 [%d]", pAcptNo,szRsrcName,szItemID,sqlca.sqlcode);
					eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);
					strcpy(pRstCond,"EROR");

					/*LOG*/sprintf(gszLogMsg,"[%s][%s] 롤백버전의 신청번호 조회 실패 [%d]", szRsrcName,szItemID,sqlca.sqlcode);
					Result_Make(szRstFile,gszLogMsg,szSvrIP,pPrcSys,pRstCond);
					CMR1011_Make (szSysCD, szSvrIP, pAcptNo, szSerNo, szRstFile, 0, pRstCond, szSvrName, pPrcSys,szSvrCD,szSvrSeq);
					continue;
				}
				NotUseDataTruncate (szAcptNo06, 0x20);


				/*-----------------------------------------------*/
				/*	백업 디렉토리                                */
				/*-----------------------------------------------*/
				if (Conv_IBBackDir	(szAcptNo06, szSysOS, szDirPath, szIBBackDir) != 0) {
					sprintf(gszLogMsg, "[%s] 백업디렉토리 변환 실패 [%s]", pAcptNo, szChangDirPathTmp);
					eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);

					strcpy(pRstCond,"EROR");
					Result_Make(szRstFile,"백업디렉토리 변환 실패",szSvrIP,pPrcSys,pRstCond);
					CMR1011_Make (szSysCD, szSvrIP, pAcptNo, szSerNo, szRstFile, 0, pRstCond, szSvrName, pPrcSys,szSvrCD,szSvrSeq);
					continue;
				}

				/*-----------------------------------------------*/
				/*	소켓 버퍼사이즈 SET                          */
				/*-----------------------------------------------*/
				if (Server_Buff_Size(szSysCD, szSvrCD, szSvrSeq) == FALSE) {
					sprintf(gszLogMsg, "[%s] 서버 버퍼사이즈 조회실패 : [%s] [%s] [%d]", pAcptNo, szSysCD, szSvrCD, szSvrSeq);
					eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);
					exit (1);
				}

				/*-----------------------------------------------*/
				/*	파일 원복 처리                               */
				/*-----------------------------------------------*/
				sprintf(CmdInfo.szServerIP,"%s",szSvrIP);
				CmdInfo.nPort = szPortNo;
				strcpy(CmdInfo.szJobGub, "I");
				sprintf(CmdInfo.szCommand, "%s/%s", szIBBackDir, szRsrcName);
				Server_Cmd_JOB(&CmdInfo);
				if (strcmp(CmdInfo.szRstCond, "0000") != 0) {
					sprintf(gszLogMsg, "[%s] 백업 파일 없음 : [%s]", pAcptNo, CmdInfo.szCommand);
					eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);

					strcpy(pRstCond, CmdInfo.szRstCond);
					sprintf(gszLogMsg, "백업 파일 없음 : [%s]", CmdInfo.szCommand);
					Result_Make(szRstFile, gszLogMsg, szSvrIP,pPrcSys,pRstCond);
					CMR1011_Make (szSysCD, szSvrIP, pAcptNo, szSerNo, szRstFile, 0, pRstCond, szSvrName, pPrcSys,szSvrCD,szSvrSeq);
					continue;				
				}
				else {
					/*-------------------------------------------*/
					/*	배포 디렉토리  작성                      */
					/*-------------------------------------------*/
					strcpy(CmdInfo.szJobGub, "I");
					sprintf(CmdInfo.szCommand, "%s", szChangDirPath);
					Server_Cmd_JOB(&CmdInfo);

					if (strcmp(CmdInfo.szRstCond, "0000") != 0) {
						strcpy(CmdInfo.szJobGub, "S");
						sprintf(CmdInfo.szCommand, "mkdir -p %s", szChangDirPath);
						Server_Cmd_JOB(&CmdInfo);

						sprintf(gszLogMsg, "[%s] 배포디렉토리 작성 : [%s]", pAcptNo, szChangDirPath);
						eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);

						if (strcmp(CmdInfo.szRstCond, "0000") != 0) {
							sprintf(gszLogMsg, "[%s] 배포디렉토리 작성 실패 [%s]", pAcptNo, szChangDirPath);
							eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);

							strcpy(pRstCond, CmdInfo.szRstCond);
							sprintf(gszLogMsg, "배포디렉토리 작성 실패 [%s]", szChangDirPath);
							Result_Make(szRstFile, gszLogMsg, szSvrIP,pPrcSys,pRstCond);
							CMR1011_Make (szSysCD, szSvrIP, pAcptNo, szSerNo, szRstFile, 0, pRstCond, szSvrName, pPrcSys,szSvrCD,szSvrSeq);
							continue;
						}
					}

					/*-------------------------------------------*/
					/*	파일 원복 처리                           */
					/*-------------------------------------------*/
					sprintf(gszLogMsg, "[%s] 원복 : [%s/%s] [%s/%s]", pAcptNo, szIBBackDir, szRsrcName, szChangDirPath, szRsrcName);
					eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);

					sprintf(szScriptFile, "%s/%s_BackUp.sh", gszTempPath, pAcptNo);
				    SrcPtr = fopen (szScriptFile, "w");
				    if (SrcPtr == (FILE *)NULL) {
						sprintf(gszLogMsg, "[%s] 원복Script 작성 실패: [%s]", pAcptNo, szScriptFile);
						eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);

						strcpy(pRstCond, "EROR");
						sprintf(gszLogMsg, "원복Script 작성 실패 [%s]", CmdInfo.szCommand);
						Result_Make(szRstFile, gszLogMsg, szSvrIP, pPrcSys, pRstCond);
						CMR1011_Make (szSysCD, szSvrIP, pAcptNo, szSerNo, szRstFile, 0, pRstCond, szSvrName, pPrcSys,szSvrCD,szSvrSeq);
						continue;
				    }
				    fprintf (SrcPtr, "cp '%s/%s' '%s/%s'\n", szIBBackDir, szRsrcName, szChangDirPath, szRsrcName);
				    fprintf (SrcPtr, "exit $?\n");
				    fclose  (SrcPtr);
				    fflush  (SrcPtr);

					strcpy(CmdInfo.szJobGub , "F");
					sprintf(CmdInfo.szLocal , "%s/%s_BackUp.sh", gszTempPath, pAcptNo);
					sprintf(CmdInfo.szRemote, "%s/%s_BackUp.sh", szDir     , pAcptNo);
					Server_Cmd_JOB(&CmdInfo);
					remove (CmdInfo.szLocal);

					if (strcmp(CmdInfo.szRstCond, "0000") != 0) {
						sprintf(gszLogMsg, "[%s] 원복Script 전송 실패: [%s]", pAcptNo, CmdInfo.szRemote);
						eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);

						strcpy(pRstCond, "EROR");
						sprintf(gszLogMsg, "원복Script 전송 실패 [%s]", CmdInfo.szRemote);
						Result_Make(szRstFile, gszLogMsg, szSvrIP, pPrcSys, pRstCond);
						CMR1011_Make (szSysCD, szSvrIP, pAcptNo, szSerNo, szRstFile, 0, pRstCond, szSvrName, pPrcSys,szSvrCD,szSvrSeq);
						continue;
					}

					strcpy(CmdInfo.szJobGub, "S");
					sprintf(CmdInfo.szCommand, "chmod 777 %s", CmdInfo.szRemote);
					Server_Cmd_JOB(&CmdInfo);


					strcpy(CmdInfo.szJobGub, "S");
					sprintf(CmdInfo.szCommand, "%s", CmdInfo.szRemote);
					Server_Cmd_JOB(&CmdInfo);
					strcpy(pRstCond, CmdInfo.szRstCond);

					strcpy(CmdInfo.szJobGub, "S");
					sprintf(CmdInfo.szCommand, "rm -f %s", CmdInfo.szRemote);
					Server_Cmd_JOB(&CmdInfo);

					sprintf(CmdInfo.szCommand, "cp '%s/%s' '%s/%s'", szIBBackDir, szRsrcName, szChangDirPath, szRsrcName);
					if (strcmp(pRstCond, "0000") != 0) {
						sprintf(gszLogMsg, "[%s] 원복실패 [%s]", pAcptNo, CmdInfo.szCommand);
						eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);

						sprintf(gszLogMsg, "원복실패 [%s]", CmdInfo.szCommand);
						Result_Make(szRstFile, gszLogMsg, szSvrIP, pPrcSys, pRstCond);
						CMR1011_Make (szSysCD, szSvrIP, pAcptNo, szSerNo, szRstFile, 0, pRstCond, szSvrName, pPrcSys,szSvrCD,szSvrSeq);
						continue;
					}
					else {
						sprintf(gszLogMsg, "[%s] 원복성공 [%s]", pAcptNo, CmdInfo.szCommand);
						eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);

						sprintf(gszLogMsg, "원복성공 [%s]", CmdInfo.szCommand);
						Result_Make(szRstFile, gszLogMsg, szSvrIP, pPrcSys, pRstCond);
						CMR1011_Make (szSysCD, szSvrIP, pAcptNo, szSerNo, szRstFile, 0, pRstCond, szSvrName, pPrcSys,szSvrCD,szSvrSeq);
					}

					sprintf(gszLogMsg, "[%s] 원복결과 작성 : [%s/%s] [%s/%s]", pAcptNo, szChangDirPath, szRsrcName, szIBBackDir, szRsrcName);
					eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);


					sprintf(szScriptFile, "%s/%s_BackUp.sh", gszTempPath, pAcptNo);
				    SrcPtr = fopen (szScriptFile, "w");
				    if (SrcPtr == (FILE *)NULL) {
						sprintf(gszLogMsg, "[%s] 원복Script 작성 실패: [%s]", pAcptNo, szScriptFile);
						eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);

						strcpy(pRstCond, "EROR");
						sprintf(gszLogMsg, "원복Script 작성 실패 [%s]", CmdInfo.szCommand);
						Result_Make(szRstFile, gszLogMsg, szSvrIP, pPrcSys, pRstCond);
						CMR1011_Make (szSysCD, szSvrIP, pAcptNo, szSerNo, szRstFile, 0, pRstCond, szSvrName, pPrcSys,szSvrCD,szSvrSeq);
						continue;
				    }
				    fprintf (SrcPtr, "ls -l '%s/%s' '%s/%s' 1>%s/%s.lsf 2>/dev/null\n", szIBBackDir, szRsrcName, szChangDirPath, szRsrcName, szDir, pAcptNo);
				    fclose  (SrcPtr);
				    fflush  (SrcPtr);


					strcpy(CmdInfo.szJobGub , "F");
					sprintf(CmdInfo.szLocal , "%s/%s_BackUp.sh", gszTempPath, pAcptNo);
					sprintf(CmdInfo.szRemote, "%s/%s_BackUp.sh", szDir     , pAcptNo);
					Server_Cmd_JOB(&CmdInfo);
					remove (CmdInfo.szLocal);

					if (strcmp(CmdInfo.szRstCond, "0000") != 0) {
						sprintf(gszLogMsg, "[%s] 원복Script 전송 실패: [%s]", pAcptNo, CmdInfo.szRemote);
						eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);

						strcpy(pRstCond, "EROR");
						sprintf(gszLogMsg, "원복Script 전송 실패 [%s]", CmdInfo.szRemote);
						Result_Make(szRstFile, gszLogMsg, szSvrIP, pPrcSys, pRstCond);
						CMR1011_Make (szSysCD, szSvrIP, pAcptNo, szSerNo, szRstFile, 0, pRstCond, szSvrName, pPrcSys,szSvrCD,szSvrSeq);
						continue;
					}

					strcpy(CmdInfo.szJobGub, "S");
					sprintf(CmdInfo.szCommand, "chmod 777 %s", CmdInfo.szRemote);
					Server_Cmd_JOB(&CmdInfo);


					strcpy(CmdInfo.szJobGub, "S");
					sprintf(CmdInfo.szCommand, "%s", CmdInfo.szRemote);
					Server_Cmd_JOB(&CmdInfo);
					strcpy(pRstCond, CmdInfo.szRstCond);

					strcpy(CmdInfo.szJobGub, "S");
					sprintf(CmdInfo.szCommand, "rm -f %s", CmdInfo.szRemote);
					Server_Cmd_JOB(&CmdInfo);

					strcpy(CmdInfo.szJobGub , "G");
					sprintf(CmdInfo.szRemote, "%s/%s.lsf", szDir, pAcptNo);
					sprintf(CmdInfo.szLocal , "%s/%s.lsf", gszTempPath, pAcptNo);
					Server_Cmd_JOB(&CmdInfo);
					File_Encoding(CmdInfo.szLocal);
					strcpy(pRstCond, CmdInfo.szRstCond);
					
					strcpy(CmdInfo.szJobGub, "S");
					sprintf(CmdInfo.szCommand, "rm -f %s", CmdInfo.szRemote);
					Server_Cmd_JOB(&CmdInfo);

					if (strcmp(pRstCond, "0000") != 0) {
						sprintf(gszLogMsg, "[%s] 원복결과 수신 실패 [%s]", pAcptNo, CmdInfo.szRemote);
						eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);

						sprintf(gszLogMsg, "원복결과 수신 실패 [%s]", CmdInfo.szCommand);
						Result_Make(szRstFile, gszLogMsg, szSvrIP, pPrcSys, pRstCond);
						CMR1011_Make (szSysCD, szSvrIP, pAcptNo, szSerNo, szRstFile, 0, pRstCond, szSvrName, pPrcSys,szSvrCD,szSvrSeq);

						remove (CmdInfo.szLocal);
						continue;
					}
					else {
						sprintf(gszLogMsg, "[%s] 원복결과 수신 정상 [%s]", pAcptNo, CmdInfo.szRemote);
						eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);

						File_Merge(szRstFile, CmdInfo.szLocal, szSvrIP, "원복결과", 1);
						CMR1011_Make (szSysCD, szSvrIP, pAcptNo, szSerNo, szRstFile, 0, CmdInfo.szRstCond, szSvrName, pPrcSys,szSvrCD,szSvrSeq);
					}
					remove (CmdInfo.szLocal);
				}
				continue;
			}
		}


		/*-------------------------------------------------------*/
		/*	개발서버에 파일저장 경로+파일명                      */
		/*-------------------------------------------------------*/
		strcpy(szRemoteFileName, szRsrcName);
		sprintf(szLocalFileName,"%s.%s.%d",szRsrcName, pAcptNo, szSerNo);

		if (strcmp(szSysOS, dfWINDOWS) != 0 ) {
			if (cmp_mid_char(szInfo, 50, 1, "1") == 0) {
				nRet = Right_Char_Check(szChangDirPath, '/');
				if (nRet > 0) {
					sprintf(szBackFileName, "old%s/%s.%s", right_char(szChangDirPath, strlen(szChangDirPath) - nRet), szRsrcName, "`date +%Y%m%d.%H%M%S`");
				}
			}
		}
		sprintf(szLocal,"%s/%s",szReqPath,szLocalFileName);

		if (strncmp(szReqCD,"05",2) == 0) {
			/*LOG*/sprintf(gszLogMsg,"[%s][%d][%s]ECAMS_ACCT1 폐기/배포안함 : 자원생성 SKIP [%s]", pAcptNo,szSerNo,pPrcSys,szRsrcName);
	    	eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);

			strcpy(pRstCond,"0000");
			Result_Make(szRstFile,"폐기 작업-자원생성 처리안함",szSvrIP,pPrcSys,pRstCond);
			CMR1011_Make (szSysCD, szSvrIP, pAcptNo, szSerNo, szRstFile, 0, pRstCond, szSvrName, pPrcSys,szSvrCD,szSvrSeq);
			continue;
		}

		if (access(szLocal, F_OK) != 0) {
			sprintf(szCommand, "procck FileRead_cmr0027");
			while (1) {
				nRst = system(szCommand) / 256;
				if (nRst <= 20)	break;
				usleep (300000);
			}

			sprintf(szCommand,"FileRead_cmr0027 '%s' '%s' '%s' ",pAcptNo, szItemID ,szLocal);
			nRst = system(szCommand) / 256;
			if (nRst != 0) {
				/*LOG*/sprintf(gszLogMsg,"[%s][%d]ECAMS_ACCT1 Server로 전송할 파일 생성 실패 FileRead_cmr0027 [%s]",pAcptNo,szSerNo,szCommand);
				eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);

				strcpy(pRstCond,"FMER");
				Result_Make(szRstFile,"Server로 전송할 파일 생성 실패",szSvrIP,pPrcSys,pRstCond);
				CMR1011_Make (szSysCD, szSvrIP, pAcptNo, szSerNo, szRstFile, 0, pRstCond, szSvrName, pPrcSys,szSvrCD,szSvrSeq);
				continue;
			}
		}
		else {
			stat(szLocal, &f_st);
			lFileSize = f_st.st_size;

			if (lFileSize <= 0){
				sprintf(szCommand, "procck FileRead_cmr0027");
				while (1) {
					nRst = system(szCommand) / 256;
					if (nRst <= 20)	break;
					usleep (300000);
				}

				sprintf(szCommand,"FileRead_cmr0027 '%s' '%s' '%s' ",pAcptNo, szItemID ,szLocal);
				nRst = system(szCommand) / 256;
				if (nRst != 0) {
					/*LOG*/sprintf(gszLogMsg,"[%s][%d]ECAMS_ACCT1 Server로 전송할 파일 생성 실패 FileRead_cmr0027 [%s]",pAcptNo,szSerNo,szCommand);
					eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);

					strcpy(pRstCond,"FMER");
					Result_Make(szRstFile,"Server로 전송할 파일 생성 실패",szSvrIP,pPrcSys,pRstCond);
					CMR1011_Make (szSysCD, szSvrIP, pAcptNo, szSerNo, szRstFile, 0, pRstCond, szSvrName, pPrcSys,szSvrCD,szSvrSeq);
					continue;
				}
			}
		}
		stat(szLocal, &f_st);
		lFileSize = f_st.st_size;

		/*LOG*/sprintf(gszLogMsg,"[%s][%d][%s] ECAMS_ACCT1	Server로 전송할 파일 생성[%s] 사이즈[%ld]",pAcptNo,szSerNo,pPrcSys,szLocal,lFileSize);
		eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);

		memset(szchmod,0x00,sizeof(szchmod));
		memset(szchown,0x00,sizeof(szchown));
		memset(szchgrp,0x00,sizeof(szchgrp));

		/*-------------------------------------------------------*/
		/*	서버처리속성이 파일속성변경이면 속성정보 조회        */
		/*-------------------------------------------------------*/
		if (memcmp(szSvrInfo,"1",1) == 0) {
			EXEC SQL
				SELECT  a.CM_OWNER
				      , a.CM_GRPID
				      , a.CM_PERMISSION
				  INTO  :szchown
				  	  , :szchgrp
				  	  , :szchmod
				  FROM  CMM0035 a
				      , CMM0030 b
				 WHERE  a.CM_SYSCD = :szSysCD
				   AND  a.CM_SVRCD = :szSvrCD
				   AND  a.CM_SEQNO = :szSvrSeq
				   AND  a.CM_SYSCD = b.CM_SYSCD
				   AND  a.CM_JOBCD = DECODE(SUBSTR(b.CM_SYSINFO, 9, 1), '1', :szJobCD, '****');

			if (sqlca.sqlcode != 0) {
				/*LOG*/sprintf(gszLogMsg,"[%s][%d][%s] 서버 정보 없음 (USER,GROUP,PERMISSION) [%s][%s][%d][%s] ",pAcptNo,szSerNo,pPrcSys,szSysCD,szSvrCD,szSvrSeq,szJobCD);
				eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);
				strcpy(pRstCond,"SIER");

				/*-----------------------------------------------*/
				/*	자원 전송 결과 작성  	                     */
				/*-----------------------------------------------*/
				Result_Make(szRstFile,"서버 정보 없음 (USER,GROUP,PERMISSION)",szSvrIP,pPrcSys,pRstCond);
				CMR1011_Make (szSysCD, szSvrIP, pAcptNo, szSerNo, szRstFile, szSysStep, pRstCond, szSvrName, pPrcSys,szSvrCD,szSvrSeq);
				continue;
			}
			NotUseDataTruncate (szchmod, 0x20);
			NotUseDataTruncate (szchown, 0x20);
			NotUseDataTruncate (szchgrp, 0x20);
		}
		nRst = tar_index_insert_Z(pAcptNo,szReqPath,szSvrIP,szSvrSeq,szLocalFileName,szRemoteFileName,szChangDirPath,szchmod,szchown,szchgrp,"",szBackFileName);

		if (nRst != 0) {
			/*LOG*/sprintf(gszLogMsg,"[%s][%d] 파일 생성 후 Tar Idx 추가 실패 szLocal [%s]",pAcptNo,szSerNo,szLocal);
			eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);

			strcpy(pRstCond,"TARE");
			Result_Make(szRstFile,"파일 생성 후 Tar Idx 추가 실패",szSvrIP,pPrcSys,pRstCond);
			CMR1011_Make (szSysCD, szSvrIP, pAcptNo, szSerNo, szRstFile, 0, pRstCond, szSvrName, pPrcSys,szSvrCD,szSvrSeq);
			continue;
		}

		idxcnt++;
		/*LOG*/sprintf(gszLogMsg,"[%s][%d][%s] 파일생성 및 Tar 파일 Idx 추가 \n",pAcptNo,szSerNo,pPrcSys);
		eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);
	}
    EXEC SQL close SYSED_Rsrc1;

	nPutErrCnt = 0;
	/*-----------------------------------------------------------*/
	/*	오류건수 조회                                            */
	/*-----------------------------------------------------------*/
	EXEC SQL
		SELECT  COUNT(a.CR_SEQNO)
		  INTO  :nPutErrCnt
		  FROM  CMR1011 a
		      , CMR1010 b
		 WHERE  a.CR_ACPTNO  = :pAcptNo
		   AND  b.CR_PRCDATE IS NULL
		   AND  a.CR_ACPTNO  = b.CR_ACPTNO
		   AND  a.CR_SERNO   = b.CR_SERNO
		   AND  b.CR_STATUS != '3'
		   AND  a.CR_PRCSYS  = :pPrcSys
		   AND  NVL(a.CR_PUTCODE, 'N/A') != '0000';

	/*-----------------------------------------------------------*/
	/*	처리단계 및 처리결과 변경                                */
	/*-----------------------------------------------------------*/
	EXEC SQL
		UPDATE  CMR1010
		   SET  CR_SYSSTEP = DECODE(NVL(CR_PUTCODE, '0000'), '0000', 1   , 0         )
		      , CR_PUTCODE = DECODE(NVL(CR_PUTCODE, '0000'), '0000', NULL, CR_PUTCODE)
		 WHERE  CR_ACPTNO = :pAcptNo
		   AND  CR_PRCDATE IS NULL
		   AND  NVL(CR_SYSSTEP, 0) <= 0;

	if (sqlca.sqlcode != 0 && sqlca.sqlcode != 1403) {
		sprintf(gszLogMsg,"Step Update Err!!! : [%s] [%d] [%s]", pAcptNo, sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
		eCAMS_Log(gszLogPath, gszLogFile, gszLogMsg);
		strcpy(pRstCond,"EROR");
		return sqlca.sqlcode;
	}

	EXEC SQL EXECUTE
    	BEGIN
	        UPDATE_1000STEP(:pAcptNo,:szSysStep);
        END;
    END-EXEC;

	if (sqlca.sqlcode != 0) {
		/*LOG*/sprintf(gszLogMsg,"[%s] CMR1000 SYSSTEP UPDATE ERROR [%d] [%s]", pAcptNo,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);
		strcpy(pRstCond,"EROR");
		return sqlca.sqlcode;
	}
	EXEC SQL COMMIT;

	if (nPutErrCnt != 0) {
		strcpy(pRstCond,"EROR");
		return nPutErrCnt;
	}
	strcpy(pRstCond,"0000");

	szSysStep = 1;
	/*-----------------------------------------------------------*/
	/*	대상 서버로 전송                                         */
	/*-----------------------------------------------------------*/
	if (idxcnt> 0){
		EXEC SQL declare SYSED_Rsrc2 cursor for
			SELECT  DISTINCT
			        B.CM_SYSCD
			      , B.CM_SVRCD
			      , B.CM_SVRNAME
			      , B.CM_SVRIP
			      , B.CM_PORTNO
			      , B.CM_DIR
			      , B.CM_SEQNO
			  FROM  CMR1010 A
			      , CMM0031 B
			      , CMM0036 C
			      , CMM0038 D
			      , CMR1000 E
			 WHERE  A.CR_ACPTNO = :pAcptNo
			   AND  A.CR_PRCDATE IS NULL
			   AND  E.CR_ACPTNO = A.CR_ACPTNO
			   AND  SUBSTR(C.CM_INFO,11,1) = '1'
			   AND  (    (     E.CR_QRYCD IN ('04','16')
			              AND  B.CM_SVRCD  = DECODE(:pPrcSys, 'SYSTS', '35'
			              	                                         , '05'
			              	                       )
			   	         )
			         OR  (     E.CR_QRYCD  = '03'
			              AND  B.CM_SVRCD  = '15'
			   	         )
			         OR  (     E.CR_QRYCD  = '06'
			              AND  B.CM_SVRCD  = DECODE(:pPrcSys, 'SYSTS', '35'
			              	                                         , '05'
			              	                       )
			   	         )
			        )
			   AND  B.CM_CLOSEDT IS NULL
			   AND  B.CM_SVRSTOP = 'N'
			   AND  A.CR_SYSCD	= B.CM_SYSCD
			   AND  A.CR_SYSCD  = C.CM_SYSCD
			   AND  A.CR_RSRCCD = C.CM_RSRCCD
			   AND  A.CR_SYSCD  = D.CM_SYSCD
			   AND  A.CR_RSRCCD	= D.CM_RSRCCD
			   AND  B.CM_SVRCD	= D.CM_SVRCD
			   AND  B.CM_SEQNO	= D.CM_SEQNO
			   AND  (    (     :pPrcSys = 'SYSTS'
			   	          AND  A.CR_DEPLOYT = 'Y'
			   	         )
			   	     OR  (     :pPrcSys = 'SYSED'
			   	     	  AND  A.CR_DEPLOY  = 'Y'
			   	     	 )
			   	    )
			   AND  NVL(A.CR_APLYDATE,TO_CHAR(SYSDATE,'YYYYMMDDHH24MI')) <= TO_CHAR(SYSDATE,'YYYYMMDDHH24MI');

		EXEC SQL open  SYSED_Rsrc2;
		while(1) {
			EXEC SQL fetch SYSED_Rsrc2
				INTO  :szSysCD
					, :szSvrCD
					, :szSvrName
					, :szSvrIP
					, :szPortNo
					, :szDir
					, :szSvrSeq;

			if (sqlca.sqlcode == 1403)	break;
			if (sqlca.sqlcode != 0 && sqlca.sqlcode != -1405) {
				sprintf(gszLogMsg,"SYSED_Rsrc2 DB FETCH ERROR : [%s] [%d] [%s]",pAcptNo, sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
				eCAMS_Log(gszLogPath, gszLogFile, gszLogMsg);
				break;
			}

			NotUseDataTruncate (szSysCD  , 0x20);
			NotUseDataTruncate (szSvrCD  , 0x20);
			NotUseDataTruncate (szSvrName, 0x20);
			NotUseDataTruncate (szSvrIP  , 0x20);
			NotUseDataTruncate (szDir    , 0x20);

			eCAMS_ACComp_Fork ("SYSTPT", pAcptNo, 1, szSvrIP, szSysCD, "", "", "1","", pPrcSys, "", "", szPortNo, "", szSvrCD , szSvrSeq,0);
		}
		EXEC SQL close SYSED_Rsrc2;
	}

	/*-----------------------------------------------------------*/
	/*	처리완료 여부 체크 및 대기 처리                          */
	/*-----------------------------------------------------------*/
	wait_Accomp_Fork("SYSTPT",pAcptNo);


    nPutErrCnt = 0;
 	/*-----------------------------------------------------------*/
	/*	오류건수 조회                                            */
	/*-----------------------------------------------------------*/
	EXEC SQL
		SELECT  COUNT(a.CR_SEQNO)
		  INTO  :nPutErrCnt
		  FROM  CMR1011 a
		      , CMR1010 b
		 WHERE  a.CR_ACPTNO  = :pAcptNo
		   AND  b.CR_PRCDATE IS NULL
		   AND  a.CR_ACPTNO  = b.CR_ACPTNO
		   and  a.CR_SERNO   = b.CR_SERNO
		   and  b.CR_STATUS != '3'
		   AND  a.CR_PRCSYS = :pPrcSys
		   And  NVL(a.CR_PUTCODE, 'N/A') != '0000';

	/*-----------------------------------------------------------*/
	/*	처리단계 및 처리결과 변경                                */
	/*-----------------------------------------------------------*/
	EXEC SQL
		UPDATE  CMR1010
		   SET  CR_SYSSTEP = DECODE(NVL(CR_PUTCODE, '0000'), '0000', 2
		                                                           , 0
		                           )
		      , CR_PUTCODE = DECODE(NVL(CR_PUTCODE, '0000'), '0000', NULL
		                                                           , CR_PUTCODE
		                           )
		 WHERE  CR_ACPTNO = :pAcptNo
		   AND  CR_PRCDATE IS NULL
		   AND  NVL(CR_SYSSTEP,1) <= 1;

	if (sqlca.sqlcode != 0 && sqlca.sqlcode != 1403) {
		sprintf(gszLogMsg,"Step Update Err!!! : [%s] [%d] [%s]", pAcptNo, sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
		eCAMS_Log(gszLogPath, gszLogFile, gszLogMsg);

		strcpy(pRstCond,"EROR");
		return sqlca.sqlcode;
	}

	EXEC SQL EXECUTE
    	BEGIN
	        UPDATE_1000STEP(:pAcptNo,:szSysStep);
        END;
    END-EXEC;

	if (sqlca.sqlcode != 0) {
		/*LOG*/sprintf(gszLogMsg,"[%s] CMR1000 SYSSTEP UPDATE ERROR [%d] [%s]", pAcptNo,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);

		strcpy(pRstCond,"EROR");
		return sqlca.sqlcode;
	}
	EXEC SQL COMMIT;

	if (nPutErrCnt != 0) {
		strcpy(pRstCond,"EROR");
		return nPutErrCnt;
	}
	strcpy(pRstCond,"0000");

	return nPutErrCnt;
}






/*---------------------------------------------------------------*/
/*	Function  : UploadSysed60Rsrc                                */
/*	Action    : 서버로 파일 전송                                 */
/*	Parameter :	pAcptNo   : 신청번호                             */
/*	            pPrcSys   : 처리단계                             */
/*	            pRstCond  : 처리결과                             */
/*	Return    : 오류건수                                         */
/*---------------------------------------------------------------*/
int 	UploadSysed60Rsrc	( char *pAcptNo
							, char *pPrcSys
							, char *pRstCond
							)
{
char	szSysCD                [dfSysCD];
char	szDsnCD                [dfDsnCD];
char	szRsrcName          [dfRsrcName];
char	szRsrcCD              [dfRsrcCD];
int		szVersion                       ;
int		szBefVer                        ;
char	szEditor              [dfEditor];
int		szSerNo                         ;
char	szSrcChg                   [1+1];
int		szPri                           ;
char	szAplyDate                [14+1];
char	szItemID              [dfItemID];
char	szReqCD                [dfReqCD];
char	szConfNo              [dfAcptNo];
char	szBaseItem            [dfItemID];
char	szQryCD                [dfReqCD];
char	szSysGB                    [1+1];
char	szSvrIP                [dfSvrIP];
int		szPortNo                        ;
char	szSvrCD                [dfSvrCD];
char	szSvrName              [dfSvrNM];
char	szDir                    [dfDir];
char	szVolPath                [dfDir];
char	szSysOS                [dfSysOS];
int		szSvrSeq                        ;
char	szInfo                  [dfInfo];
char	szDirPath                [dfDir];
char	szJobCD                [dfJobCD];
char	szSvrInfo            [dfSvrInfo];
char	szchmod                      [6];
char	szchown                     [21];
char	szchgrp                     [21];
char	szReqPath                [dfDir];
char	szRstFile           [dfFullPath];
char	szBKRsrcName        [dfRsrcName];
char	szChangDirPath           [dfDir];
char	szChangDirPathTmp         [dfDir];
char	szRemoteFileName    [dfFullPath];
char	szLocalFileName     [dfFullPath];
char	szBackFileName      [dfFullPath];
char	szRemote            [dfFullPath];
char	szLocal             [dfFullPath];
char	szCommand           [dfFullPath];
char	idxFileName         [dfFullPath];
char	szFileDate                [14+1];
int		idxcnt                          ;
int		nRst                            ;
int		nPutErrCnt                      ;
int		szSysStep                       ;
char	szBasePgm           [dfRsrcName];
char	szBasePgmTmp        [dfRsrcName];
struct 	stat f_st                       ;
long	lFileSize                       ;
int		nRet                            ;
CMD_INFO	CmdInfo                     ;


	memset(szReqPath, 0x00, sizeof(szReqPath));

	/*-----------------------------------------------------------*/
	/*	파일 생성시 파일이 저장될 경로 설정및 생성               */
	/*-----------------------------------------------------------*/
	SetTempDir("77",szReqPath);
	strcat(szReqPath,pAcptNo);
	if (access(szReqPath,F_OK) != 0)
		Local_Dir_Make(szReqPath);

	/*-----------------------------------------------------------*/
	/*	소켓 명령 변수 초기화                                    */
	/*-----------------------------------------------------------*/
	InitCmdInfo(&CmdInfo);
	strcpy(CmdInfo.szAcptNo,pAcptNo);
	sprintf(CmdInfo.szLogFile,"%sTransList.%s",gszLogPath,gszLogFile);

	/*-----------------------------------------------------------*/
	/*	Tar Index 파일 생성 초기화                               */
	/*-----------------------------------------------------------*/
	tar_index_init(pAcptNo,szReqPath);
	idxcnt    = 0 ;
	szSysStep = 0;

	/*-----------------------------------------------------------*/
	/*	배포대상목록에 대하여 tar index 파일 생성                */
	/*-----------------------------------------------------------*/
	EXEC SQL open  SYSED60_Rsrc1;
    while (1) {
		EXEC SQL fetch SYSED60_Rsrc1
			INTO  :szSysCD
 			    , :szDsnCD
 			    , :szRsrcCD
 			    , :szRsrcName
 			    , :szJobCD
 			    , :szVersion
 			    , :szBefVer
 			    , :szEditor
 			    , :szSerNo
 			    , :szPri
 			    , :szSrcChg
 			    , :szAplyDate
 			    , :szItemID
 			    , :szReqCD
 			    , :szConfNo
 			    , :szBaseItem
 			    , :szQryCD
 			    , :szSysGB
 			    , :szSvrIP
 			    , :szPortNo
 			    , :szSvrCD
 			    , :szSvrName
 			    , :szDir
 			    , :szVolPath
 			    , :szSysOS
 			    , :szSvrSeq
 			    , :szSvrInfo
 			    , :szInfo
 			    , :szDirPath;

		if (sqlca.sqlcode == 1403)	break;
		if (sqlca.sqlcode != 0 && sqlca.sqlcode != -1405) {
			sprintf(gszLogMsg,"UploadSysedRsrc DB FETCH ERROR : [%s] [%d] [%d] [%s]", pAcptNo, szSerNo, sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
			eCAMS_Log(gszLogPath, gszLogFile, gszLogMsg);
			break;
		}

		NotUseDataTruncate (szSysCD   ,	0x20);
		NotUseDataTruncate (szDsnCD   ,	0x20);
		NotUseDataTruncate (szRsrcCD  ,	0x20);
		NotUseDataTruncate (szJobCD   ,	0x20);
		NotUseDataTruncate (szEditor  ,	0x20);
		NotUseDataTruncate (szSrcChg  ,	0x20);
		NotUseDataTruncate (szAplyDate,	0x20);
		NotUseDataTruncate (szItemID  ,	0x20);
		NotUseDataTruncate (szReqCD   ,	0x20);
		NotUseDataTruncate (szConfNo  ,	0x20);
		NotUseDataTruncate (szBaseItem,	0x20);
		NotUseDataTruncate (szQryCD   , 0x20);
		NotUseDataTruncate (szSysGB   , 0x20);
		NotUseDataTruncate (szSvrIP   , 0x20);
		NotUseDataTruncate (szSvrCD   , 0x20);
		NotUseDataTruncate (szSvrName , 0x20);
		NotUseDataTruncate (szDir     , 0x20);
		NotUseDataTruncate (szVolPath , 0x20);
		NotUseDataTruncate (szSysOS   , 0x20);
		NotUseDataTruncate (szInfo    , 0x20);
		NotUseDataTruncate (szSvrInfo , 0x20);

		sprintf(szRsrcName, "%s", trunc_char(szRsrcName));
		sprintf(szDirPath , "%s", trunc_char(szDirPath));
		strcpy(szBKRsrcName,szRsrcName);

		/*-------------------------------------------------------*/
		/*	릴리즈시 홈디렉토리 배포인경우 처리                  */
		/*-------------------------------------------------------*/
		if (cmp_mid_char(szInfo,37,1,"1") == 0) {
			EXEC SQL
				SELECT  CM_VOLPATH
				  INTO  :szChangDirPathTmp
				  FROM  CMM0038 b
				 WHERE  CM_SYSCD = :szSysCD
				   AND  CM_SVRCD = :szSvrCD
				   AND  CM_SEQNO = :szSvrSeq
				   AND  CM_RSRCCD = :szRsrcCD;

			if (sqlca.sqlcode != 0) {
				/*LOG*/sprintf(gszLogMsg,"[%s][%d][%s] 기준디렉토리 없음 (CMM0038 CM_VOLPATH) [%s][%s][%d][%s] ",pAcptNo,szSerNo,pPrcSys,szSysCD,szSvrCD,szSvrSeq,szRsrcCD);
				eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);
				strcpy(pRstCond,"SIER");

				/*---------------------------------------------------*/
				/* 자원 전송 결과 작성  	                         */
				/*---------------------------------------------------*/
				Result_Make(szRstFile,"기준디렉토리 없음 (CMM0038 CM_VOLPATH)",szSvrIP,pPrcSys,pRstCond);
				CMR1011_Make (szSysCD, szSvrIP, pAcptNo, szSerNo, szRstFile, szSysStep, pRstCond, szSvrName, pPrcSys,szSvrCD,szSvrSeq);
				continue;
			}
			NotUseDataTruncate (szChangDirPathTmp, 0x20);
		}
		else {
			ChangeVolPath(szSysCD , szSvrCD, szRsrcCD, szSvrSeq, szDirPath, szChangDirPathTmp);
		}

		if (cmp_right_char(szChangDirPathTmp, 1, "/") == 0) {
			sprintf(szChangDirPathTmp, "%s", left_char(szChangDirPathTmp, strlen(szChangDirPathTmp) - 1));
		}


		/*-------------------------------------------------------*/
		/*	릴리즈시 temp 저장인 경우 처리                       */
		/*-------------------------------------------------------*/
		if (cmp_mid_char(szInfo,23,1,"1") == 0) {
			memset(szChangDirPath   , 0x00, sizeof(szChangDirPath));
			sprintf(szChangDirPath  , "%s/%s", szChangDirPathTmp,"temp");
			memset(szChangDirPathTmp, 0x00   , sizeof(szChangDirPathTmp));
			strcpy(szChangDirPathTmp, szChangDirPath);
		}

		/*-------------------------------------------------------*/
		/*	OS가 윈도우인경우 디렉토리 변환                      */
		/*-------------------------------------------------------*/
		Convert_WinDirPath (szSysOS, szChangDirPathTmp, szChangDirPath);

		/*-------------------------------------------------------*/
		/*	결과파일명                                           */
		/*-------------------------------------------------------*/
		sprintf(szRstFile,"%s/%s.%d.%s.%d.result", gszTempPath, pAcptNo, szSerNo,szSvrIP,szSvrSeq);

		/*-------------------------------------------------------*/
		/*	개발서버에 파일저장 경로+파일명                      */
		/*-------------------------------------------------------*/
		strcpy(szRemoteFileName, szRsrcName);
		sprintf(szLocalFileName,"%s.%s.%d",szRsrcName, pAcptNo, szSerNo);
		memset(szBackFileName, 0x00, sizeof(szBackFileName));

		if (strcmp(szSysOS, dfWINDOWS) != 0 ) {
			if (cmp_mid_char(szInfo, 50, 1, "1") == 0) {
				nRet = Right_Char_Check(szChangDirPath, '/');
				if (nRet > 0) {
					sprintf(szBackFileName, "old%s/%s.%s", right_char(szChangDirPath, strlen(szChangDirPath) - nRet), szRsrcName, "`date +%Y%m%d.%H%M%S`");
				}
			}
		}
		sprintf(szLocal,"%s/%s",szReqPath,szLocalFileName);

		if (strncmp(szReqCD,"05",2) == 0) {
			/*LOG*/sprintf(gszLogMsg,"[%s][%d][%s]ECAMS_ACCT1 폐기/배포안함 : 자원생성 SKIP [%s]", pAcptNo,szSerNo,pPrcSys,szRsrcName);
	    	eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);

			strcpy(pRstCond,"0000");
			Result_Make(szRstFile,"폐기 작업-자원생성 처리안함",szSvrIP,pPrcSys,pRstCond);
			CMR1011_Make (szSysCD, szSvrIP, pAcptNo, szSerNo, szRstFile, 0, pRstCond, szSvrName, pPrcSys,szSvrCD,szSvrSeq);
			continue;
		}

		if (access(szLocal, F_OK) != 0) {
			sprintf(szCommand, "procck FileRead_cmr0027");
			while (1) {
				nRst = system(szCommand) / 256;
				if (nRst <= 20)	break;
				usleep (300000);
			}

			sprintf(szCommand,"FileRead_cmr0027 '%s' '%s' '%s' ",pAcptNo, szItemID ,szLocal);
			nRst = system(szCommand) / 256;
			if (nRst != 0) {
				/*LOG*/sprintf(gszLogMsg,"[%s][%d]ECAMS_ACCT1 Server로 전송할 파일 생성 실패 FileRead_cmr0027 [%s]",pAcptNo,szSerNo,szCommand);
				eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);

				strcpy(pRstCond,"FMER");
				Result_Make(szRstFile,"Server로 전송할 파일 생성 실패",szSvrIP,pPrcSys,pRstCond);
				CMR1011_Make (szSysCD, szSvrIP, pAcptNo, szSerNo, szRstFile, 0, pRstCond, szSvrName, pPrcSys,szSvrCD,szSvrSeq);
				continue;
			}
		}
		else {
			stat(szLocal, &f_st);
			lFileSize = f_st.st_size;

			if (lFileSize <= 0){
				sprintf(szCommand, "procck FileRead_cmr0027");
				while (1) {
					nRst = system(szCommand) / 256;
					if (nRst <= 20)	break;
					usleep (300000);
				}

				sprintf(szCommand,"FileRead_cmr0027 '%s' '%s' '%s' ",pAcptNo, szItemID ,szLocal);
				nRst = system(szCommand) / 256;
				if (nRst != 0) {
					/*LOG*/sprintf(gszLogMsg,"[%s][%d]ECAMS_ACCT1 Server로 전송할 파일 생성 실패 FileRead_cmr0027 [%s]",pAcptNo,szSerNo,szCommand);
					eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);

					strcpy(pRstCond,"FMER");
					Result_Make(szRstFile,"Server로 전송할 파일 생성 실패",szSvrIP,pPrcSys,pRstCond);
					CMR1011_Make (szSysCD, szSvrIP, pAcptNo, szSerNo, szRstFile, 0, pRstCond, szSvrName, pPrcSys,szSvrCD,szSvrSeq);
					continue;
				}
			}
		}
		stat(szLocal, &f_st);
		lFileSize = f_st.st_size;

		/*LOG*/sprintf(gszLogMsg,"[%s][%d][%s] ECAMS_ACCT1	Server로 전송할 파일 생성[%s] 사이즈[%ld]",pAcptNo,szSerNo,pPrcSys,szLocal,lFileSize);
		eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);

		memset(szchmod,0x00,sizeof(szchmod));
		memset(szchown,0x00,sizeof(szchown));
		memset(szchgrp,0x00,sizeof(szchgrp));

		/*-------------------------------------------------------*/
		/*	서버처리속성이 파일속성변경이면 속성정보 조회        */
		/*-------------------------------------------------------*/
		if (memcmp(szSvrInfo,"1",1) == 0) {
			EXEC SQL
				SELECT  a.CM_OWNER
				      , a.CM_GRPID
				      , a.CM_PERMISSION
				  INTO  :szchown
				  	  , :szchgrp
				  	  , :szchmod
				  FROM  CMM0035 a
				      , CMM0030 b
				 WHERE  a.CM_SYSCD = :szSysCD
				   AND  a.CM_SVRCD = :szSvrCD
				   AND  a.CM_SEQNO = :szSvrSeq
				   AND  a.CM_SYSCD = b.CM_SYSCD
				   AND  a.CM_JOBCD = DECODE(SUBSTR(b.CM_SYSINFO, 9, 1), '1', :szJobCD, '****');

			if (sqlca.sqlcode != 0) {
				/*LOG*/sprintf(gszLogMsg,"[%s][%d][%s] 서버 정보 없음 (USER,GROUP,PERMISSION) [%s][%s][%d][%s] ",pAcptNo,szSerNo,pPrcSys,szSysCD,szSvrCD,szSvrSeq,szJobCD);
				eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);
				strcpy(pRstCond,"SIER");

				/*-----------------------------------------------*/
				/*	자원 전송 결과 작성  	                     */
				/*-----------------------------------------------*/
				Result_Make(szRstFile,"서버 정보 없음 (USER,GROUP,PERMISSION)",szSvrIP,pPrcSys,pRstCond);
				CMR1011_Make (szSysCD, szSvrIP, pAcptNo, szSerNo, szRstFile, szSysStep, pRstCond, szSvrName, pPrcSys,szSvrCD,szSvrSeq);
				continue;
			}
			NotUseDataTruncate (szchmod, 0x20);
			NotUseDataTruncate (szchown, 0x20);
			NotUseDataTruncate (szchgrp, 0x20);
		}
		nRst = tar_index_insert_Z(pAcptNo,szReqPath,szSvrIP,szSvrSeq,szLocalFileName,szRemoteFileName,szChangDirPath,szchmod,szchown,szchgrp,"",szBackFileName);

		if (nRst != 0) {
			/*LOG*/sprintf(gszLogMsg,"[%s][%d] 파일 생성 후 Tar Idx 추가 실패 szLocal [%s]",pAcptNo,szSerNo,szLocal);
			eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);

			strcpy(pRstCond,"TARE");
			Result_Make(szRstFile,"파일 생성 후 Tar Idx 추가 실패",szSvrIP,pPrcSys,pRstCond);
			CMR1011_Make (szSysCD, szSvrIP, pAcptNo, szSerNo, szRstFile, 0, pRstCond, szSvrName, pPrcSys,szSvrCD,szSvrSeq);
			continue;
		}

		idxcnt++;
		/*LOG*/sprintf(gszLogMsg,"[%s][%d][%s] 파일생성 및 Tar 파일 Idx 추가 \n",pAcptNo,szSerNo,pPrcSys);
		eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);
	}
    EXEC SQL close SYSED60_Rsrc1;

	nPutErrCnt = 0;
	/*-----------------------------------------------------------*/
	/*	오류건수 조회                                            */
	/*-----------------------------------------------------------*/
	EXEC SQL
		SELECT  COUNT(a.CR_SEQNO)
		  INTO  :nPutErrCnt
		  FROM  CMR1011 a
		      , CMR1010 b
		 WHERE  a.CR_ACPTNO  = :pAcptNo
		   AND  b.CR_PRCDATE IS NULL
		   AND  a.CR_ACPTNO  = b.CR_ACPTNO
		   AND  a.CR_SERNO   = b.CR_SERNO
		   AND  b.CR_STATUS != '3'
		   AND  a.CR_PRCSYS  = :pPrcSys
		   AND  NVL(a.CR_PUTCODE, 'N/A') != '0000';

	/*-----------------------------------------------------------*/
	/*	처리단계 및 처리결과 변경                                */
	/*-----------------------------------------------------------*/
	EXEC SQL
		UPDATE  CMR1010
		   SET  CR_SYSSTEP = DECODE(NVL(CR_PUTCODE, '0000'), '0000', 1
		                                                           , 0
		                           )
		      , CR_PUTCODE = DECODE(NVL(CR_PUTCODE, '0000'), '0000', NULL
		                                                           , CR_PUTCODE
		                           )
		 WHERE  CR_ACPTNO = :pAcptNo
		   AND  CR_PRCDATE IS NULL
		   AND  NVL(CR_SYSSTEP, 0) <= 0;

	if (sqlca.sqlcode != 0 && sqlca.sqlcode != 1403) {
		sprintf(gszLogMsg,"Step Update Err!!! : [%s] [%d] [%s]", pAcptNo, sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
		eCAMS_Log(gszLogPath, gszLogFile, gszLogMsg);

		strcpy(pRstCond,"EROR");
		return sqlca.sqlcode;
	}

	EXEC SQL EXECUTE
    	BEGIN
	        UPDATE_1000STEP(:pAcptNo,:szSysStep);
        END;
    END-EXEC;

	if (sqlca.sqlcode != 0) {
		/*LOG*/sprintf(gszLogMsg,"[%s] CMR1000 SYSSTEP UPDATE ERROR [%d] [%s]", pAcptNo,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);

		strcpy(pRstCond,"EROR");
		return sqlca.sqlcode;
	}
	EXEC SQL COMMIT;

	if (nPutErrCnt != 0) {
		strcpy(pRstCond,"EROR");
		return nPutErrCnt;
	}
	strcpy(pRstCond,"0000");

	szSysStep = 1;
	/*-----------------------------------------------------------*/
	/*	대상 서버로 전송                                         */
	/*-----------------------------------------------------------*/
	if (idxcnt> 0){
		EXEC SQL declare SYSED60_Rsrc2 cursor for
			SELECT  DISTINCT
			        B.CM_SYSCD
			      , B.CM_SVRCD
			      , B.CM_SVRNAME
			      , B.CM_SVRIP
			      , B.CM_PORTNO
			      , B.CM_DIR
			      , B.CM_SEQNO
			  FROM  CMR1010 A
			      , CMM0031 B
			      , CMM0036 C
			      , CMM0038 D
			      , CMR1000 E
			 WHERE  A.CR_ACPTNO = :pAcptNo
			   AND  A.CR_PRCDATE IS NULL
			   AND  E.CR_ACPTNO = A.CR_ACPTNO
			   AND  SUBSTR(C.CM_INFO,11,1) = '1'
			   AND  A.CR_QRYCD  = '60'
			   AND  B.CM_SVRCD  = DECODE(:pPrcSys, 'SYSTS', '35'
			   	                                          , '05'
			   	                        )
			   AND  B.CM_CLOSEDT IS NULL
			   AND  B.CM_SVRSTOP = 'N'
			   AND  A.CR_SYSCD	= B.CM_SYSCD
			   AND  A.CR_SYSCD  = C.CM_SYSCD
			   AND  A.CR_RSRCCD = C.CM_RSRCCD
			   AND  A.CR_SYSCD  = D.CM_SYSCD
			   AND  A.CR_RSRCCD	= D.CM_RSRCCD
			   AND  B.CM_SVRCD	= D.CM_SVRCD
			   AND  B.CM_SEQNO	= D.CM_SEQNO
			   AND  NVL(A.CR_APLYDATE,TO_CHAR(SYSDATE,'YYYYMMDDHH24MI')) <= TO_CHAR(SYSDATE,'YYYYMMDDHH24MI');

		EXEC SQL open  SYSED60_Rsrc2;
		while(1) {
			EXEC SQL fetch SYSED60_Rsrc2
				INTO  :szSysCD
					, :szSvrCD
					, :szSvrName
					, :szSvrIP
					, :szPortNo
					, :szDir
					, :szSvrSeq;

			if (sqlca.sqlcode == 1403)	break;
			if (sqlca.sqlcode != 0 && sqlca.sqlcode != -1405) {
				sprintf(gszLogMsg,"SYSED_Rsrc2 DB FETCH ERROR : [%s] [%d] [%s]",pAcptNo, sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
				eCAMS_Log(gszLogPath, gszLogFile, gszLogMsg);
				break;
			}

			NotUseDataTruncate (szSysCD  , 0x20);
			NotUseDataTruncate (szSvrCD  , 0x20);
			NotUseDataTruncate (szSvrName, 0x20);
			NotUseDataTruncate (szSvrIP  , 0x20);
			NotUseDataTruncate (szDir    , 0x20);

			eCAMS_ACComp_Fork ("SYSTPT", pAcptNo, 1, szSvrIP, szSysCD, "", "", "1","", pPrcSys, "", "", szPortNo, "", szSvrCD , szSvrSeq,0);
		}
		EXEC SQL close SYSED60_Rsrc2;
	}

	/*-----------------------------------------------------------*/
	/*	처리완료 여부 체크 및 대기 처리                          */
	/*-----------------------------------------------------------*/
	wait_Accomp_Fork("SYSTPT",pAcptNo);


    nPutErrCnt = 0;
 	/*-----------------------------------------------------------*/
	/*	오류건수 조회                                            */
	/*-----------------------------------------------------------*/
	EXEC SQL
		SELECT  COUNT(a.CR_SEQNO)
		  INTO  :nPutErrCnt
		  FROM  CMR1011 a
		      , CMR1010 b
		 WHERE  a.CR_ACPTNO  = :pAcptNo
		   AND  b.CR_PRCDATE IS NULL
		   AND  a.CR_ACPTNO  = b.CR_ACPTNO
		   and  a.CR_SERNO   = b.CR_SERNO
		   and  b.CR_STATUS != '3'
		   AND  a.CR_PRCSYS = :pPrcSys
		   And  NVL(a.CR_PUTCODE, 'N/A') != '0000';

	/*-----------------------------------------------------------*/
	/*	처리단계 및 처리결과 변경                                */
	/*-----------------------------------------------------------*/
	EXEC SQL
		UPDATE  CMR1010
		   SET  CR_SYSSTEP = DECODE(NVL(CR_PUTCODE, '0000'), '0000', 2
									                               , 0
									   )
		      , CR_PUTCODE = DECODE(NVL(CR_PUTCODE, '0000'), '0000', NULL
									                               , CR_PUTCODE
									   )
		 WHERE  CR_ACPTNO = :pAcptNo
		   AND  CR_PRCDATE IS NULL
		   AND  NVL(CR_SYSSTEP,1) <= 1;

	if (sqlca.sqlcode != 0 && sqlca.sqlcode != 1403) {
		sprintf(gszLogMsg,"Step Update Err!!! : [%s] [%d] [%s]", pAcptNo, sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
		eCAMS_Log(gszLogPath, gszLogFile, gszLogMsg);

		strcpy(pRstCond,"EROR");
		return sqlca.sqlcode;
	}

	EXEC SQL EXECUTE
    	BEGIN
	        UPDATE_1000STEP(:pAcptNo,:szSysStep);
        END;
    END-EXEC;

	if (sqlca.sqlcode != 0) {
		/*LOG*/sprintf(gszLogMsg,"[%s] CMR1000 SYSSTEP UPDATE ERROR [%d] [%s]", pAcptNo,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);

		strcpy(pRstCond,"EROR");
		return sqlca.sqlcode;
	}
	EXEC SQL COMMIT;

	if (nPutErrCnt != 0) {
		strcpy(pRstCond,"EROR");
		return nPutErrCnt;
	}
	strcpy(pRstCond,"0000");

	return nPutErrCnt;
}



/*---------------------------------------------------------------*/
/*	Function  : RunSysedRsrcScript                               */
/*	Action    : 배포 스크립트 수행                               */
/*	Parameter :	pAcptNo   : 신청번호                             */
/*	            pPrcSys   : 처리단계                             */
/*	            pRstCond  : 처리결과                             */
/*	Return    : 오류건수                                         */
/*---------------------------------------------------------------*/
int 	RunSysedRsrcScript	( char *pAcptNo
							, char *pPrcSys
							, char *pRstCond
							)
{
char	szSysCD                [dfSysCD];
char	szDsnCD                [dfDsnCD];
char	szRsrcName          [dfRsrcName];
char	szRsrcCD              [dfRsrcCD];
char	szJobCD                [dfJobCD];
int		szVersion                       ;
int		szBefVer                        ;
char	szEditor              [dfEditor];
int		szSerNo                         ;
char	szSrcChg                   [1+1];
char	szPri                       [10];
char	szAplyDate                [14+1];
char	szItemID              [dfItemID];
char	szReqCD                [dfReqCD];
char	szConfNo              [dfAcptNo];
char	szBaseItem            [dfItemID];
char	szQryCD                [dfReqCD];
char	szSysGB                    [1+1];
char	szSvrIP                [dfSvrIP];
int		szPortNo                        ;
char	szSvrCD                [dfSvrCD];
char	szSvrName              [dfSvrNM];
char	szDir                    [dfDir];
char	szVolPath                [dfDir];
char	szSysOS                [dfSysOS];
int		szSvrSeq                        ;
char	szInfo                  [dfInfo];
char	szDirPath                [dfDir];
int		szSubSvrSeq                     ;
char	szSubSysOs             [dfSysOS];
int		szSubPortNo                     ;
char	szSubSvrIP             [dfSvrIP];
char	szReqPath                [dfDir];
char	szRstFile           [dfFullPath];
char	szBKRsrcName        [dfRsrcName];
char	szChangDirPath           [dfDir];
char	szChangDirPathTmp         [dfDir];
char	szRemoteFileName    [dfFullPath];
char	szLocalFileName     [dfFullPath];
char	szRemote            [dfFullPath];
char	szLocal             [dfFullPath];
char	szCommand           [dfFullPath];
char	idxFileName         [dfFullPath];
int		idxcnt                          ;
int		nRst                            ;
int		nComErrCnt                      ;
char	szPrePri                    [10];
int		nCnt                            ;
int		bFlag                           ;
int		szSysStep                       ;
int	 	zzRet                           ;
int  	zzCnt                           ;
int  	zzCnt2                          ;
char 	zzVolDir                 [dfDir];
char 	zzDirPath                [dfDir];
char 	zzDirTruc                [dfDir];

CMD_INFO	CmdInfo                     ;


	memset(szPrePri , 0x00, sizeof(szPrePri ));
	memset(szReqPath, 0x00, sizeof(szReqPath));
	szSysStep = 2;

	/*-----------------------------------------------------------*/
	/*	파일 생성시 파일이 저장될 경로 설정및 생성               */
	/*-----------------------------------------------------------*/
	SetTempDir("77",szReqPath);
	strcat(szReqPath,pAcptNo);
	if (access(szReqPath,F_OK) != 0)
		Local_Dir_Make(szReqPath);

	/*-----------------------------------------------------------*/
	/*	소켓 명령 변수 초기화                                    */
	/*-----------------------------------------------------------*/
	InitCmdInfo(&CmdInfo);
	strcpy(CmdInfo.szAcptNo,pAcptNo);
	sprintf(CmdInfo.szLogFile,"%sTransList.%s",gszLogPath,gszLogFile);


	EXEC SQL DECLARE SYSED_Rsrc3 CURSOR FOR
		SELECT  DISTINCT
		        A.CR_SYSCD
		      , A.CR_DSNCD
		      , A.CR_RSRCCD
		      , A.CR_JOBCD
		      , A.CR_RSRCNAME
		      , A.CR_VERSION
		      , A.CR_BEFVER
		      , A.CR_EDITOR
		      , A.CR_SERNO
		      , A.CR_PRIORITY
		      , A.CR_SRCCHG
		      , NVL(A.CR_APLYDATE, '0')
		      , A.CR_ITEMID
		      , A.CR_QRYCD
		      , A.CR_CONFNO
		      , A.CR_BASEITEM
		      , B.CR_QRYCD
		      , B.CR_SYSGB
		      , C.CM_SVRIP
		      , C.CM_PORTNO
		      , C.CM_SVRCD
		      , C.CM_SVRNAME
		      , C.CM_DIR
		      , C.CM_VOLPATH
		      , C.CM_SYSOS
		      , C.CM_SEQNO
		      , D.CM_INFO
		      ,	NVL(A.CR_DSNCD2, F.CM_DIRPATH)
		  FROM  CMR1000 B
		      , CMR1010 A
		      , CMM0031 C
		      , CMM0036 D
		      , CMM0038 E
		      , CMM0070 F
  		 WHERE  A.CR_ACPTNO = :pAcptNo
		   AND  NVL(A.CR_SYSSTEP,0) = :szSysStep
		   AND  A.CR_SRCCMP = 'Y'
		   AND  A.CR_PRCDATE IS NULL
		   AND  B.CR_ACPTNO = A.CR_ACPTNO
		   AND  A.CR_SYSCD  = C.CM_SYSCD
		   AND  (    (     B.CR_QRYCD IN ('04','16')
		              AND  C.CM_SVRCD  = DECODE(:pPrcSys, 'SYSTS', '35'
		              	                                         , '05'
		              	                       )
		   	         )
		         OR  (     B.CR_QRYCD  = '03'
		              AND  C.CM_SVRCD  = '15'
		   	         )
		         OR  (     B.CR_QRYCD  = '06'
		              AND  C.CM_SVRCD  = DECODE(:pPrcSys, 'SYSTS', '35'
		              	                                         , '05'
		              	                       )
		   	         )
		        )
		   AND  C.CM_CLOSEDT    IS NULL
		   AND  C.CM_SVRSTOP = 'N'
		   AND  D.CM_CLOSEDT    IS NULL
		   AND  A.CR_SYSCD  = D.CM_SYSCD
		   AND  A.CR_RSRCCD = D.CM_RSRCCD
		   AND  (   (     A.CR_QRYCD != '05'
		             AND SUBSTR(D.CM_INFO,21,1) = '1'
		            )
		         OR (     A.CR_QRYCD  = '05'
		             AND SUBSTR(D.CM_INFO,18,1) = '1'
		            )
		        )
		   AND  A.CR_SYSCD  = E.CM_SYSCD
		   AND  A.CR_RSRCCD = E.CM_RSRCCD
		   AND  C.CM_SVRCD  = E.CM_SVRCD
		   AND  C.CM_SEQNO  = E.CM_SEQNO
		   AND  A.CR_SYSCD  = F.CM_SYSCD
		   AND  A.CR_DSNCD  = F.CM_DSNCD
		   AND  (    (     :pPrcSys = 'SYSTS'
		   	          AND  A.CR_DEPLOYT = 'Y'
		   	         )
		   	     OR  (     :pPrcSys = 'SYSED'
		   	     	  AND  A.CR_DEPLOY  = 'Y'
		   	     	 )
		   	    )
		   AND  NVL(A.CR_APLYDATE,TO_CHAR(SYSDATE,'YYYYMMDDHH24MI')) <= TO_CHAR(SYSDATE,'YYYYMMDDHH24MI')
		   AND  (    A.CR_PID IS NULL
		         OR  NVL(A.CR_PUTCODE, 'RTRY') = 'RTRY'
		        )
		 ORDER  BY  A.CR_PRIORITY, A.CR_SERNO;


	EXEC SQL DECLARE SYSED_Rsrc3_sub CURSOR FOR
		SELECT  a.CM_SYSOS
		      , a.CM_SEQNO
		      , a.CM_SVRIP
		      , a.CM_PORTNO
		  FROM  CMM0031 a
		      , CMM0038 b
		 WHERE  a.CM_SYSCD = :szSysCD
		   AND  a.CM_SVRCD = :szSvrCD
		   AND  a.CM_CLOSEDT IS NULL
		   AND  a.CM_SVRSTOP = 'N'
		   AND  a.CM_SYSCD = b.CM_SYSCD
		   AND  a.CM_SVRCD = b.CM_SVRCD
		   AND  a.CM_SEQNO = b.CM_SEQNO
		   AND  b.CM_RSRCCD = :szRsrcCD;

	szSysStep = 2;

	EXEC SQL open  SYSED_Rsrc3;
    while (1) {
		EXEC SQL fetch SYSED_Rsrc3
			INTO  :szSysCD
			    , :szDsnCD
			    , :szRsrcCD
			    , :szJobCD
			    , :szRsrcName
			    , :szVersion
			    , :szBefVer
			    , :szEditor
			    , :szSerNo
			    , :szPri
			    , :szSrcChg
			    , :szAplyDate
			    , :szItemID
			    , :szReqCD
			    , :szConfNo
			    , :szBaseItem
			    , :szQryCD
			    , :szSysGB
			    , :szSvrIP
			    , :szPortNo
			    , :szSvrCD
			    , :szSvrName
			    , :szDir
			    , :szVolPath
			    , :szSysOS
			    , :szSvrSeq
			    , :szInfo
			    , :szDirPath;

		if (sqlca.sqlcode == 1403)	break;
		if (sqlca.sqlcode != 0 && sqlca.sqlcode != -1405) {
			sprintf(gszLogMsg,"RunSysedRsrcScript DB FETCH ERROR : [%s] [%d] [%d] [%s]", pAcptNo, szSerNo, sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
			eCAMS_Log(gszLogPath, gszLogFile, gszLogMsg);
			break;
		}

		NotUseDataTruncate (szSysCD   ,	0x20);
		NotUseDataTruncate (szDsnCD   ,	0x20);
		NotUseDataTruncate (szRsrcCD  ,	0x20);
		NotUseDataTruncate (szEditor  ,	0x20);
		NotUseDataTruncate (szSrcChg  ,	0x20);
		NotUseDataTruncate (szAplyDate,	0x20);
		NotUseDataTruncate (szItemID  ,	0x20);
		NotUseDataTruncate (szReqCD   ,	0x20);
		NotUseDataTruncate (szConfNo  ,	0x20);
		NotUseDataTruncate (szBaseItem,	0x20);
		NotUseDataTruncate (szQryCD   ,	0x20);
		NotUseDataTruncate (szSysGB   ,	0x20);
		NotUseDataTruncate (szSvrIP   ,	0x20);
		NotUseDataTruncate (szSvrCD   ,	0x20);
		NotUseDataTruncate (szSvrName ,	0x20);
		NotUseDataTruncate (szDir     ,	0x20);
		NotUseDataTruncate (szVolPath ,	0x20);
		NotUseDataTruncate (szSysOS   ,	0x20);
		NotUseDataTruncate (szInfo    ,	0x20);
		NotUseDataTruncate (szPri     ,	0x20);
		NotUseDataTruncate (szJobCD   ,	0x20);

		sprintf(szRsrcName, "%s", trunc_char(szRsrcName));
		sprintf(szDirPath , "%s", trunc_char(szDirPath ));
		strcpy(szBKRsrcName,szRsrcName);

		/*-------------------------------------------------------*/
		/*	릴리즈시 홈디렉토리 배포                             */
		/*-------------------------------------------------------*/
		if (cmp_mid_char(szInfo,37,1,"1") == 0) {
			EXEC SQL
				SELECT  CM_VOLPATH
				  INTO  :szChangDirPathTmp
				  FROM  CMM0038 b
				 WHERE  CM_SYSCD  = :szSysCD
				   AND  CM_SVRCD  = :szSvrCD
				   AND  CM_SEQNO  = :szSvrSeq
				   AND  CM_RSRCCD = :szRsrcCD;

			if (sqlca.sqlcode != 0) {
				/*LOG*/sprintf(gszLogMsg,"[%s][%d][%s] 기준디렉토리 없음 (CMM0038 CM_VOLPATH) [%s][%s][%d][%s] ",pAcptNo,szSerNo,pPrcSys,szSysCD,szSvrCD,szSvrSeq,szRsrcCD);
				eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);
				strcpy(pRstCond,"SIER");

				/*-----------------------------------------------*/
				/* 자원 전송 결과 작성                           */
				/*-----------------------------------------------*/
				Result_Make(szRstFile,"기준디렉토리 없음 (CMM0038 CM_VOLPATH)",szSvrIP,pPrcSys,pRstCond);
				CMR1011_Make (szSysCD, szSvrIP, pAcptNo, szSerNo, szRstFile, szSysStep, pRstCond, szSvrName, pPrcSys,szSvrCD,szSvrSeq);
				continue;
			}
			NotUseDataTruncate (szChangDirPathTmp, 0x20);
		}
		else {
			ChangeVolPath_NEW(pAcptNo, szSysCD , szSvrCD, szRsrcCD, szSvrSeq, szDirPath, szChangDirPathTmp);
		}

		if (cmp_right_char(szChangDirPathTmp, 1, "/") == 0) {
			sprintf(szChangDirPathTmp, "%s", left_char(szChangDirPathTmp, strlen(szChangDirPathTmp) - 1));
		}

		/*-------------------------------------------------------*/
		/*	릴리즈시 Temp 저장                                   */
		/*-------------------------------------------------------*/
		if (cmp_mid_char(szInfo,23,1,"1") == 0) {
			memset(szChangDirPath , 0x00   , sizeof(szChangDirPath   ));
			sprintf(szChangDirPath, "%s/%s", szChangDirPathTmp,"temp");
			memset(szChangDirPathTmp, 0x00, sizeof(szChangDirPathTmp));
			strcpy(szChangDirPathTmp, szChangDirPath);
		}

		/*-------------------------------------------------------*/
		/*	윈도우시스템의 경우 디렉토리 변환                    */
		/*-------------------------------------------------------*/
		Convert_WinDirPath (szSysOS, szChangDirPathTmp, szChangDirPath);

		/*-------------------------------------------------------*/
		/*	결과파일명                                           */
		/*-------------------------------------------------------*/
		sprintf(szRstFile,"%s/%s.%d.%s.%d.result", gszTempPath, pAcptNo, szSerNo,szSvrIP,szSvrSeq);

		/*-------------------------------------------------------*/
		/*	개발서버에 파일저장 경로+파일명                      */
		/*-------------------------------------------------------*/
		strcpy(szRemoteFileName,szRsrcName);

		sprintf(szLocalFileName,"%s.%s.%d",szRsrcName, pAcptNo, szSerNo);
		sprintf(szLocal,"%s/%s",szReqPath,szLocalFileName);

		Result_Make(szRstFile,"컴파일전 CMR1011 생성",szSvrIP,pPrcSys,"0000");
		CMR1011_Make (szSysCD, szSvrIP, pAcptNo, szSerNo, szRstFile, 2, "0000", szSvrName, pPrcSys,szSvrCD,szSvrSeq);

		/*-------------------------------------------------------*/
		/*	처리결과 초기화                                      */
		/*-------------------------------------------------------*/
		EXEC SQL
			UPDATE  CMR1011
			   SET  CR_PRCRST  = NULL
			      , CR_PUTCODE = NULL
			 WHERE  CR_ACPTNO  = :pAcptNo
			   AND  CR_PRCSYS  = :pPrcSys
			   AND  CR_SERNO   = :szSerNo
  		       AND  CR_SVRSEQ  = :szSvrSeq
  		       AND  CR_IPADDR  = :szSvrIP
			   AND  CR_SVRCD   = :szSvrCD;

		if (sqlca.sqlcode != 0 && sqlca.sqlcode != 1403) {
			sprintf(gszLogMsg,"cr_prcrst clear Err!!! : [%s] [%d] [%s]",pAcptNo, sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
			eCAMS_Log(gszLogPath, gszLogFile, gszLogMsg);
			strcpy(pRstCond,"EROR");
			return 1;
		}

		EXEC SQL
			UPDATE  CMR1010
			   SET  CR_PUTCODE = NULL
			 WHERE  CR_ACPTNO  = :pAcptNo
			   AND  CR_SERNO   = :szSerNo;

		if (sqlca.sqlcode != 0 && sqlca.sqlcode != 1403) {
			sprintf(gszLogMsg,"cr_putcode clear Err!!! : [%s] [%d] [%s]",pAcptNo, sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
			eCAMS_Log(gszLogPath, gszLogFile, gszLogMsg);
			strcpy(pRstCond,"EROR");
			return 1;
		}
		EXEC SQL COMMIT;

		if (strlen(szPrePri) == 0) {
			strcpy(szPrePri, szPri);
		}

		if (strcmp(szPrePri, szPri) != 0) {
			/*LOG*/sprintf(gszLogMsg,"ECAMS_ACCT1	Process_SYSED(<%s><%s>) [%s][%s]순위 처리 시작 \n",pAcptNo,pPrcSys,szPri,szPrePri);
			eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);

			do {
				/*-----------------------------------------------*/
				/* 현재 우선처리 순위중 처리미완료건 조회        */
				/*-----------------------------------------------*/
				EXEC SQL

					SELECT  COUNT(*)
					  INTO  :nCnt
					  FROM  CMR1010 a
					      , CMR1011 b
					      , CMM0036 c
					 WHERE  a.CR_ACPTNO   = :pAcptNo
					   AND  a.CR_PRIORITY = :szPrePri
					   AND  a.CR_ACPTNO   = b.CR_ACPTNO
					   AND  a.CR_SERNO    = b.CR_SERNO
					   AND  b.CR_PRCSYS   = :pPrcSys
					   AND	a.CR_SYSCD	  = C.CM_SYSCD
					   AND  a.CR_RSRCCD   = C.CM_RSRCCD
					   AND  (    (     A.CR_QRYCD != '05'
					              AND  SUBSTR(c.CM_INFO,21,1) = '1'
					             )
					         OR  (     A.CR_QRYCD  = '05'
					              AND  SUBSTR(c.CM_INFO,18,1) = '1'
					             )
					        )
					   AND  b.CR_PRCRST IS NULL
					   AND  (    (     :pPrcSys = 'SYSTS'
					   	          AND  A.CR_DEPLOYT = 'Y'
					   	         )
					   	     OR  (     :pPrcSys = 'SYSED'
					   	     	  AND  A.CR_DEPLOY  = 'Y'
					   	     	 )
					   	    )
					   AND  NVL(A.CR_APLYDATE,TO_CHAR(SYSDATE,'YYYYMMDDHH24MI')) <= TO_CHAR(SYSDATE,'YYYYMMDDHH24MI');

				if (sqlca.sqlcode != 0 ) {
					nCnt = 0;
				}
				sleep(1);
			} while(nCnt != 0);

			/*---------------------------------------------------*/
		    /*	해당 순위가 완료 되었으면 처리된 건에 오류       */
		    /*  결과가 있는지 조회                               */
		    /*---------------------------------------------------*/
			EXEC SQL
				SELECT  COUNT(*)
				  INTO  :nCnt
				  FROM  CMR1010 a
				      , CMR1011 b
				      , CMM0036 c
				 WHERE  a.CR_ACPTNO   = :pAcptNo
				   AND  a.CR_PRIORITY = :szPrePri
				   AND  a.CR_ACPTNO   = b.CR_ACPTNO
				   AND  a.CR_SERNO    = b.CR_SERNO
				   AND  b.CR_PRCSYS   = :pPrcSys
				   AND	a.CR_SYSCD	  = c.CM_SYSCD
				   AND  a.CR_RSRCCD   = c.CM_RSRCCD
				   AND  a.CR_PRCDATE IS NULL
				   AND  (   (     A.CR_QRYCD != '05'
				             AND  SUBSTR(c.CM_INFO,21,1) = '1'
				            )
				         OR (     A.CR_QRYCD  = '05'
				             AND  SUBSTR(c.CM_INFO,18,1) = '1'
				            )
				        )
				   AND  b.CR_PRCRST   != '0000'
				   AND  (    (     :pPrcSys = 'SYSTS'
				   	          AND  A.CR_DEPLOYT = 'Y'
				   	         )
				   	     OR  (     :pPrcSys = 'SYSED'
				   	     	  AND  A.CR_DEPLOY  = 'Y'
				   	     	 )
				   	    )
				   AND  NVL(A.CR_APLYDATE,TO_CHAR(SYSDATE,'YYYYMMDDHH24MI')) <= TO_CHAR(SYSDATE,'YYYYMMDDHH24MI');

			if (nCnt != 0) {
				/*LOG*/sprintf(gszLogMsg, "ECAMS_ACCT1	Process_SYSCOM(<%s><%s>) 상위 우선순위 오류처리 대기[%s]",pAcptNo,pPrcSys,szPrePri);
				eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);

				EXEC SQL
					UPDATE  CMR1010
					   SET  CR_SYSSTEP = DECODE(NVL(CR_PUTCODE, 'NA'), '0000', 3
					                                                         , 2
					                           )
					      , CR_PUTCODE = DECODE(NVL(CR_PUTCODE, 'NA'), '0000', NULL
					                                                         , CR_PUTCODE
					                           )
					 WHERE  CR_ACPTNO  = :pAcptNo
					   AND  CR_PRCDATE IS NULL
					   AND  NVL(CR_SYSSTEP,0) <= 2;

				if (sqlca.sqlcode != 0 && sqlca.sqlcode != 1403) {
					sprintf(gszLogMsg,"Step Update Err!!! : [%s] [%d] [%s]", pAcptNo, sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
					eCAMS_Log(gszLogPath, gszLogFile, gszLogMsg);

					strcpy(pRstCond,"EROR");
					return sqlca.sqlcode;
				}
				EXEC SQL COMMIT;

				EXEC SQL
					DELETE  FROM  CMR1011
					 WHERE CR_ACPTNO = :pAcptNo
					   AND CR_SERNO  = :szSerNo
					   AND CR_SVRSEQ = :szSvrSeq
					   AND CR_PRCSYS = :pPrcSys
					   AND CR_SVRCD  = :szSvrCD;

				EXEC SQL COMMIT;
				exit (1);
			}
			strcpy(szPrePri, szPri);
		}

		/*-------------------------------------------------------*/
		/*	신청건 일괄쉘이 아닌경우 배포스크립트 수행           */
		/*-------------------------------------------------------*/
		if (cmp_mid_char(szInfo,29,1,"1") != 0 &&
			cmp_mid_char(szInfo,57,1,"1") != 0 ) {
			if (cmp_mid_char(szInfo,31,1,"1") == 0) {
				eCAMS_ACComp_Fork("SYSCOM",pAcptNo, szSerNo, szSvrIP,
						    	szSysCD, szRsrcCD, szDsnCD, gSpoolGB ,szReqCD,pPrcSys,szChangDirPath,
								szRemoteFileName, szPortNo, "000001", szSvrCD, szSvrSeq,1);
			}
			else {
				eCAMS_ACComp_Fork("SYSCOM",pAcptNo, szSerNo, szSvrIP,
						    	szSysCD, szRsrcCD, szDsnCD, gSpoolGB ,szReqCD,pPrcSys,szChangDirPath,
								szRemoteFileName, szPortNo, "000001", szSvrCD, szSvrSeq,0);
			}


			EXEC SQL
				UPDATE  CMR1010 A
				   SET  CR_SRCCMP = 'N'
				 WHERE  CR_ACPTNO = :pAcptNo
				   AND  CR_SERNO  = :szSerNo
				   AND  (    (     :pPrcSys = 'SYSTS'
				   	          AND  A.CR_DEPLOYT = 'Y'
				   	         )
				   	     OR  (     :pPrcSys = 'SYSED'
				   	     	  AND  A.CR_DEPLOY  = 'Y'
				   	     	 )
				   	    );
			continue;
		}

		/*-------------------------------------------------------*/
		/*	신청건 일괄쉘인 경우 처리 수행                       */
		/*-------------------------------------------------------*/
		EXEC SQL OPEN SYSED_Rsrc3_sub;
		while (1) {
	        EXEC SQL fetch SYSED_Rsrc3_sub
	        	INTO  :szSubSysOs
	        		, :szSubSvrSeq
	        		, :szSubSvrIP
	        		, :szSubPortNo;

			if (sqlca.sqlcode == 1403)	break;

			NotUseDataTruncate (szSubSysOs, 0x20);
			NotUseDataTruncate (szSubSvrIP, 0x20);

			/*---------------------------------------------------*/
			/*	릴리즈시 홈 디렉토리 배포                        */
			/*---------------------------------------------------*/
			if (cmp_mid_char(szInfo,37,1,"1") == 0) {
				EXEC SQL
					SELECT  CM_VOLPATH
					  INTO  :szChangDirPathTmp
					  FROM  CMM0038 b
					 WHERE  CM_SYSCD  = :szSysCD
					   AND  CM_SVRCD  = :szSvrCD
					   AND  CM_SEQNO  = :szSubSvrSeq
					   AND  CM_RSRCCD = :szRsrcCD;

				if (sqlca.sqlcode != 0) {
					/*LOG*/sprintf(gszLogMsg,"[%s][%d][%s] 기준디렉토리 없음 (CMM0038 CM_VOLPATH) [%s][%s][%d][%s] ",pAcptNo,szSerNo,pPrcSys,szSysCD,szSvrCD,szSvrSeq,szRsrcCD);
					eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);
					strcpy(pRstCond,"SIER");

					/*-------------------------------------------*/
					/* 자원 전송 결과 작성                       */
					/*-------------------------------------------*/
					Result_Make(szRstFile,"기준디렉토리 없음 (CMM0038 CM_VOLPATH)",szSvrIP,pPrcSys,pRstCond);
					CMR1011_Make (szSysCD, szSvrIP, pAcptNo, szSerNo, szRstFile, szSysStep, pRstCond, szSvrName, pPrcSys,szSvrCD,szSvrSeq);
					continue;
				}
				NotUseDataTruncate (szChangDirPathTmp, 0x20);
			}
			else {
				ChangeVolPath_NEW(pAcptNo, szSysCD , szSvrCD, szRsrcCD, szSubSvrSeq, szDirPath, szChangDirPathTmp);
			}

			if (cmp_right_char(szChangDirPathTmp, 1, "/") == 0) {
				sprintf(szChangDirPathTmp, "%s", left_char(szChangDirPathTmp, strlen(szChangDirPathTmp) - 1));
			}

			/*---------------------------------------------------*/
			/*	릴리즈시 temp 배포면 디렉토리에 temp 추가        */
			/*---------------------------------------------------*/
			if (cmp_mid_char(szInfo,23,1,"1") == 0) {
				memset(szChangDirPath , 0x00   , sizeof(szChangDirPath));
				sprintf(szChangDirPath, "%s/%s", szChangDirPathTmp,"temp");
				memset(szChangDirPathTmp, 0x00, sizeof(szChangDirPathTmp));
				strcpy(szChangDirPathTmp, szChangDirPath);
			}

			/*---------------------------------------------------*/
			/*	윈도우서버에 대해 디렉토리명 변환                */
			/*---------------------------------------------------*/
			Convert_WinDirPath (szSubSysOs, szChangDirPathTmp, szChangDirPath);

			/*---------------------------------------------------*/
			/*	결과파일명                                       */
			/*---------------------------------------------------*/
			sprintf(szRstFile,"%s/%s.%d.%s.%d.result", gszTempPath, pAcptNo, szSerNo,szSvrIP,szSubSvrSeq);

			/*---------------------------------------------------*/
			/*	개발서버에 파일저장 경로+파일명                  */
			/*---------------------------------------------------*/
			strcpy(szRemoteFileName,szRsrcName);
			sprintf(szLocalFileName,"%s.%s.%d",szRsrcName, pAcptNo, szSerNo);
			sprintf(szLocal,"%s/%s",szReqPath,szLocalFileName);

			if (eCAMS_ACComp_Fork("SYSCOM",pAcptNo, szSerNo, szSubSvrIP,
					    	szSysCD, szRsrcCD, szDsnCD, gSpoolGB ,szReqCD,pPrcSys,szChangDirPath,
							szRemoteFileName, szSubPortNo, "000001", szSvrCD, szSubSvrSeq,1) != 0) {
				/*LOG*/sprintf(gszLogMsg, "ECAMS_ACCT1	[%s][%s][%d] eCAMS_ACComp_Fork Fail \n",pAcptNo,pPrcSys,szSerNo);
				eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);
				strcpy(pRstCond,"9999");

				Result_Make(szRstFile,"eCAMS_ACComp_Fork 처리중 오류 [오류건재처리요망]",szSubSvrIP,pPrcSys,pRstCond);
				CMR1011_Make (szSysCD, szSubSvrIP, pAcptNo, szSerNo, szRstFile, 2, pRstCond, szSvrName, pPrcSys,szSvrCD,szSubSvrSeq);

				EXEC SQL
					UPDATE  CMR1010
					   SET  CR_SYSSTEP = DECODE(NVL(CR_PUTCODE,'NA'),'0000', 3
					                                                       , 2
					                           )
						  , CR_PUTCODE = DECODE(NVL(CR_PUTCODE,'NA'),'0000', NULL
					                                                       , CR_PUTCODE
					                           )
					 WHERE  CR_ACPTNO = :pAcptNo
					   AND  CR_PRCDATE IS NULL
					   AND  NVL(CR_SYSSTEP,0) <= 2;

				if (sqlca.sqlcode != 0 && sqlca.sqlcode != 1403) {
					sprintf(gszLogMsg,"Step Update Err!!! : [%s] [%d] [%s]",pAcptNo, sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
					eCAMS_Log(gszLogPath, gszLogFile, gszLogMsg);

					strcpy(pRstCond,"EROR");
					return sqlca.sqlcode;
				}
				EXEC SQL COMMIT;
				exit(1);
			}
		}
		EXEC SQL close SYSED_Rsrc3_sub;

		if (cmp_mid_char(szInfo,57,1,"1") == 0 ) {
			zzCnt = 0;
			zzCnt2 = 13;
			sprintf(zzVolDir, "%s", rep_char(szChangDirPath,"//","/"));

			if (cmp_left_char(zzVolDir, 1, "/") == 0 ) {
				strcpy(zzDirTruc,"/");
				sprintf(zzVolDir, "%s", right_char(zzVolDir,strlen(zzVolDir)-1));
      		}

      		while((zzRet=Char_Check(zzVolDir, "/")) >= 0) {
      	      	zzRet = Char_Check(zzVolDir, "/");

				if (zzRet >= 0) {
					sprintf(zzDirTruc, "%s%s",zzDirTruc, left_char(zzVolDir,zzRet + 1));
					sprintf(zzVolDir, "%s", right_char(zzVolDir, strlen(zzVolDir) - zzRet - 1));
					zzCnt++;
				}
				else{
					break;
				}

				if (zzCnt >= zzCnt2) {
					break;
				}
			}

			if (cmp_right_char(zzDirTruc, 1, "/") == 0 ) {
				sprintf(zzDirTruc, "%s", left_char(zzDirTruc,strlen(zzDirTruc)-1));
      		}


			EXEC SQL
				UPDATE  CMR1010 A
				   SET  CR_SRCCMP = 'N'
				 WHERE  CR_ACPTNO = :pAcptNo
				   AND  (    (     :pPrcSys = 'SYSTS'
				   	          AND  A.CR_DEPLOYT = 'Y'
				   	         )
				   	     OR  (     :pPrcSys = 'SYSED'
				   	     	  AND  A.CR_DEPLOY  = 'Y'
				   	     	 )
				   	    )
				   AND  EXISTS (SELECT  'X'
				                  FROM  CMM0070
				                 WHERE  CM_SYSCD = A.CR_SYSCD
				                   AND  CM_DSNCD = A.CR_DSNCD
				                   AND  CM_DIRPATH LIKE :zzDirTruc || '%'
				               )
				   AND  NVL(CR_APLYDATE,TO_CHAR(SYSDATE,'YYYYMMDDHH24MI')) <= TO_CHAR(SYSDATE,'YYYYMMDDHH24MI');
		}
		else {
			EXEC SQL
				UPDATE  CMR1010 A
				   SET  CR_SRCCMP = 'N'
				 WHERE  CR_ACPTNO = :pAcptNo
				   AND  (    (     :pPrcSys = 'SYSTS'
				   	          AND  A.CR_DEPLOYT = 'Y'
				   	         )
				   	     OR  (     :pPrcSys = 'SYSED'
				   	     	  AND  A.CR_DEPLOY  = 'Y'
				   	     	 )
				   	    )
				   AND  NVL(CR_APLYDATE,TO_CHAR(SYSDATE,'YYYYMMDDHH24MI')) <= TO_CHAR(SYSDATE,'YYYYMMDDHH24MI')
		   	       AND  EXISTS (SELECT  'X'
		   	                      FROM  CMM0036
		   	                     WHERE  CM_SYSCD  = A.CR_SYSCD
		   	                       AND  CM_RSRCCD = A.CR_RSRCCD
		   	                       AND  SUBSTR(CM_INFO, 29, 1) = '1'
		   	                   );

		}
		EXEC SQL COMMIT;
		EXEC SQL close SYSED_Rsrc3;
		EXEC SQL open  SYSED_Rsrc3;
	}
    EXEC SQL close SYSED_Rsrc3;
	sleep(3);

	/*-----------------------------------------------------------*/
	/*	신청건별 처리완료 체크                                   */
	/*-----------------------------------------------------------*/
	wait_Accomp_Fork("SYSCOM",pAcptNo);

	/*-----------------------------------------------------------*/
	/*	오류건수 체크                                            */
	/*-----------------------------------------------------------*/
	nComErrCnt = 0;

	EXEC SQL
		SELECT  COUNT(a.CR_SEQNO)
		  INTO  :nComErrCnt
		  FROM  CMR1011 a
		      , CMR1010 b
		 WHERE  a.CR_ACPTNO = :pAcptNo
		   AND  b.CR_PRCDATE IS NULL
		   AND  a.CR_ACPTNO = b.CR_ACPTNO
		   AND  a.CR_SERNO  = b.CR_SERNO
		   AND  b.CR_STATUS != '3'
		   AND  a.CR_PRCSYS = :pPrcSys
		   AND  (    (     :pPrcSys = 'SYSTS'
		   	          AND  B.CR_DEPLOYT = 'Y'
		   	         )
		   	     OR  (     :pPrcSys = 'SYSED'
		   	     	  AND  B.CR_DEPLOY  = 'Y'
		   	     	 )
		   	    )
		   AND  NVL(b.CR_APLYDATE,TO_CHAR(SYSDATE,'YYYYMMDDHH24MI')) <= TO_CHAR(SYSDATE,'YYYYMMDDHH24MI')
		   AND  NVL(a.CR_PUTCODE, 'N/A') != '0000';

	/*-----------------------------------------------------------*/
	/*	시스템 처리단계 변경                                     */
	/*-----------------------------------------------------------*/
	EXEC SQL
		UPDATE  CMR1010
		   SET  CR_SYSSTEP = DECODE(NVL(CR_PUTCODE, '0000'), '0000', 3
		                                                           , 2
		                           )
		      , CR_PUTCODE = DECODE(NVL(CR_PUTCODE, '0000'), '0000', NULL
		                                                           , CR_PUTCODE
		                           )
		 WHERE  CR_ACPTNO = :pAcptNo
		   AND  CR_PRCDATE IS NULL
		   AND  (    (     :pPrcSys = 'SYSTS'
		   	          AND  CR_DEPLOYT = 'Y'
		   	         )
		   	     OR  (     :pPrcSys = 'SYSED'
		   	     	  AND  CR_DEPLOY  = 'Y'
		   	     	 )
		   	    )
		   AND  NVL(CR_APLYDATE,TO_CHAR(SYSDATE,'YYYYMMDDHH24MI')) <= TO_CHAR(SYSDATE,'YYYYMMDDHH24MI')
		   AND  NVL(CR_SYSSTEP,0) <= 2;

	if (sqlca.sqlcode != 0 && sqlca.sqlcode != 1403) {
		sprintf(gszLogMsg,"Step Update Err!!! : [%s] [%d] [%s]",pAcptNo, sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
		eCAMS_Log(gszLogPath, gszLogFile, gszLogMsg);

		strcpy(pRstCond,"EROR");
		return sqlca.sqlcode;
	}

	EXEC SQL EXECUTE
    	BEGIN
	        UPDATE_1000STEP(:pAcptNo,:szSysStep);
        END;
    END-EXEC;

	if (sqlca.sqlcode != 0) {
		/*LOG*/sprintf(gszLogMsg,"[%s] CMR1000 SYSSTEP UPDATE ERROR [%d] [%s]",pAcptNo,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);

		strcpy(pRstCond,"EROR");
		return sqlca.sqlcode;
	}
	EXEC SQL COMMIT;

	if (nComErrCnt != 0) {
		strcpy(pRstCond,"EROR");
		return nComErrCnt;
	}
	strcpy(pRstCond,"0000");

	/*-----------------------------------------------------------*/
	/*	미처리 대상 재 확인하여 미처리이면 처리로직 수행         */
	/*-----------------------------------------------------------*/
	szSysStep = 3;
	EXEC SQL DECLARE SYSED_Rsrc3_c CURSOR FOR
		SELECT  DISTINCT
		        A.CR_SYSCD
		      , A.CR_DSNCD
		      , A.CR_RSRCCD
		      , A.CR_JOBCD
		      , A.CR_RSRCNAME
		      , A.CR_VERSION
		      , A.CR_BEFVER
		      , A.CR_EDITOR
		      , A.CR_SERNO
		      , A.CR_PRIORITY
		      , A.CR_SRCCHG
		      , NVL(A.CR_APLYDATE, '0')
		      , A.CR_ITEMID
		      , A.CR_QRYCD
		      , A.CR_CONFNO
		      , A.CR_BASEITEM
		      , B.CR_QRYCD
		      , B.CR_SYSGB
		      , C.CM_SVRIP
		      , C.CM_PORTNO
		      , C.CM_SVRCD
		      , C.CM_SVRNAME
		      , C.CM_DIR
		      , C.CM_VOLPATH
		      , C.CM_SYSOS
		      , C.CM_SEQNO
		      , D.CM_INFO
		      , F.CM_DIRPATH
		  FROM  CMR1000 B
		      , CMR1010 A
		      , CMM0031 C
		      , CMM0036 D
		      , CMM0038 E
		      , CMM0070 F
		 WHERE  A.CR_ACPTNO = :pAcptNo
		   AND	NVL(A.CR_SYSSTEP,0) = :szSysStep
		   AND	A.CR_SRCCMP = 'Y'
		   AND  A.CR_PRCDATE IS NULL
		   AND  B.CR_ACPTNO = A.CR_ACPTNO
		   AND  A.CR_SYSCD  = C.CM_SYSCD
		   AND  (    (     B.CR_QRYCD IN ('04','16')
		              AND  C.CM_SVRCD  = DECODE(:pPrcSys, 'SYSTS', '35'
		              	                                         , '05'
		              	                       )
		   	         )
		         OR  (     B.CR_QRYCD  = '03'
		              AND  C.CM_SVRCD  = '15'
		   	         )
		         OR  (     B.CR_QRYCD  = '06'
		              AND  C.CM_SVRCD  = DECODE(:pPrcSys, 'SYSTS', '35'
		              	                                         , '05'
		              	                       )
		   	         )
		        )
		   AND  C.CM_CLOSEDT    IS NULL
		   AND  C.CM_SVRSTOP = 'N'
		   AND  D.CM_CLOSEDT    IS NULL
		   AND  A.CR_SYSCD  = D.CM_SYSCD
		   AND  A.CR_RSRCCD = D.CM_RSRCCD
		   AND  (   (     A.CR_QRYCD != '05'
		             AND  SUBSTR(D.CM_INFO,21,1) = '1'
		            )
		         OR (     A.CR_QRYCD  = '05'
		             AND  SUBSTR(D.CM_INFO,18,1) = '1'
		            )
		        )
		   AND  A.CR_SYSCD  = E.CM_SYSCD
		   AND  A.CR_RSRCCD = E.CM_RSRCCD
		   AND  C.CM_SVRCD  = E.CM_SVRCD
		   AND  C.CM_SEQNO  = E.CM_SEQNO
		   AND  A.CR_SYSCD  = F.CM_SYSCD
		   AND  A.CR_DSNCD  = F.CM_DSNCD
		   AND  (    (     :pPrcSys = 'SYSTS'
		   	          AND  A.CR_DEPLOYT = 'Y'
		   	         )
		   	     OR  (     :pPrcSys = 'SYSED'
		   	     	  AND  A.CR_DEPLOY  = 'Y'
		   	     	 )
		   	    )
		   AND  NVL(A.CR_APLYDATE,TO_CHAR(SYSDATE,'YYYYMMDDHH24MI')) <= TO_CHAR(SYSDATE,'YYYYMMDDHH24MI')
		   AND  NOT EXISTS (SELECT 'X'
				              FROM  CMR1011
				             WHERE  CR_ACPTNO = A.CR_ACPTNO
				               AND  CR_SERNO  = A.CR_SERNO
				               AND  CR_PRCSYS = :pPrcSys
				               AND  NVL(CR_PRCRST,'NPRO')='0000'
		                   )
		   AND  (    A.CR_PID IS NULL
		         OR  NVL(A.CR_PUTCODE,'RTRY') = 'RTRY'
		        )
		 ORDER  BY  A.CR_PRIORITY, A.CR_SERNO;

	EXEC SQL DECLARE SYSED_Rsrc3_c_sub CURSOR FOR
		SELECT  A.CM_SYSOS
		      , A.CM_SEQNO
		      , A.CM_SVRIP
		      , A.CM_PORTNO
		  FROM  CMM0031 A
		      , CMM0038 B
		 WHERE  A.CM_SYSCD  = :szSysCD
		   AND  A.CM_SVRCD  = :szSvrCD
		   AND  A.CM_CLOSEDT IS NULL
		   AND  A.CM_SVRSTOP = 'N'
		   AND  A.CM_SYSCD  = B.CM_SYSCD
		   AND  A.CM_SVRCD  = B.CM_SVRCD
		   AND  A.CM_SEQNO  = B.CM_SEQNO
		   AND  B.CM_RSRCCD = :szRsrcCD;

	EXEC SQL open  SYSED_Rsrc3_c;
    while (1) {
		EXEC SQL fetch SYSED_Rsrc3_c
			INTO  :szSysCD
			    , :szDsnCD
			    , :szRsrcCD
			    , :szJobCD
			    , :szRsrcName
			    , :szVersion
			    , :szBefVer
			    , :szEditor
			    , :szSerNo
			    , :szPri
			    , :szSrcChg
			    , :szAplyDate
			    , :szItemID
			    , :szReqCD
			    , :szConfNo
			    , :szBaseItem
			    , :szQryCD
			    , :szSysGB
			    , :szSvrIP
			    , :szPortNo
			    , :szSvrCD
			    , :szSvrName
			    , :szDir
			    , :szVolPath
			    , :szSysOS
			    , :szSvrSeq
			    , :szInfo
			    , :szDirPath;

		if (sqlca.sqlcode == 1403)	break;
		if (sqlca.sqlcode != 0 && sqlca.sqlcode != -1405) {
			sprintf(gszLogMsg,"SYSED_Rsrc3_c DB FETCH ERROR : [%s] [%d] [%d] [%s]",pAcptNo, szSerNo, sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
			eCAMS_Log(gszLogPath, gszLogFile, gszLogMsg);
			break;
		}

		NotUseDataTruncate (szSysCD   ,	0x20);
		NotUseDataTruncate (szDsnCD   ,	0x20);
		NotUseDataTruncate (szRsrcCD  ,	0x20);
		NotUseDataTruncate (szEditor  ,	0x20);
		NotUseDataTruncate (szSrcChg  ,	0x20);
		NotUseDataTruncate (szAplyDate,	0x20);
		NotUseDataTruncate (szItemID  ,	0x20);
		NotUseDataTruncate (szReqCD   ,	0x20);
		NotUseDataTruncate (szConfNo  ,	0x20);
		NotUseDataTruncate (szBaseItem,	0x20);
		NotUseDataTruncate (szQryCD   ,	0x20);
		NotUseDataTruncate (szSysGB   ,	0x20);
		NotUseDataTruncate (szSvrIP   ,	0x20);
		NotUseDataTruncate (szSvrCD   ,	0x20);
		NotUseDataTruncate (szSvrName ,	0x20);
		NotUseDataTruncate (szDir     ,	0x20);
		NotUseDataTruncate (szVolPath ,	0x20);
		NotUseDataTruncate (szSysOS   ,	0x20);
		NotUseDataTruncate (szInfo    ,	0x20);
		NotUseDataTruncate (szPri     ,	0x20);
		NotUseDataTruncate (szJobCD   ,	0x20);

		sprintf(szRsrcName, "%s", trunc_char(szRsrcName));
		sprintf(szDirPath , "%s", trunc_char(szDirPath ));
		strcpy(szBKRsrcName, szRsrcName);

		/*-------------------------------------------------------*/
		/*	홈디렉토리 배포면 홈디렉토리로 디렉토리 변경         */
		/*-------------------------------------------------------*/
		if (cmp_mid_char(szInfo,37,1,"1") == 0) {
			EXEC SQL
				SELECT  CM_VOLPATH
				  INTO  :szChangDirPathTmp
				  FROM  CMM0038 b
				 WHERE  CM_SYSCD  = :szSysCD
				   AND  CM_SVRCD  = :szSvrCD
				   AND  CM_SEQNO  = :szSvrSeq
				   AND  CM_RSRCCD = :szRsrcCD;

			if (sqlca.sqlcode != 0) {
				/*LOG*/sprintf(gszLogMsg,"[%s][%d][%s] 기준디렉토리 없음 (CMM0038 CM_VOLPATH) [%s][%s][%d][%s] ",pAcptNo,szSerNo,pPrcSys,szSysCD,szSvrCD,szSvrSeq,szRsrcCD);
				eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);
				strcpy(pRstCond,"SIER");

				/*-----------------------------------------------*/
				/* 자원 전송 결과 작성                          */
				/*-----------------------------------------------*/
				Result_Make(szRstFile,"기준디렉토리 없음 (CMM0038 CM_VOLPATH)",szSvrIP,pPrcSys,pRstCond);
				CMR1011_Make (szSysCD, szSvrIP, pAcptNo, szSerNo, szRstFile, szSysStep, pRstCond, szSvrName, pPrcSys,szSvrCD,szSvrSeq);
				continue;
			}
			NotUseDataTruncate (szChangDirPathTmp, 0x20);
		}

		else {
			ChangeVolPath_NEW(pAcptNo, szSysCD , szSvrCD, szRsrcCD, szSvrSeq, szDirPath, szChangDirPathTmp);
		}

		if (cmp_right_char(szChangDirPathTmp, 1, "/") == 0) {
			sprintf(szChangDirPathTmp, "%s", left_char(szChangDirPathTmp, strlen(szChangDirPathTmp) - 1));
		}

		/*-------------------------------------------------------*/
		/*	TEMP 디렉토리 저장이면 디렉토리에 TEMP 추가          */
		/*-------------------------------------------------------*/
		if (cmp_mid_char(szInfo,23,1,"1") == 0) {
			memset(szChangDirPath   , 0x00   ,sizeof(szChangDirPath   ));
			sprintf(szChangDirPath  , "%s/%s",szChangDirPathTmp,"temp");
			memset(szChangDirPathTmp, 0x00, sizeof(szChangDirPathTmp));
			strcpy(szChangDirPathTmp, szChangDirPath);
		}

		/*-------------------------------------------------------*/
		/*	윈도우 서버이면 디렉토리명 변환                      */
		/*-------------------------------------------------------*/
		Convert_WinDirPath (szSysOS, szChangDirPathTmp, szChangDirPath);

		/*-------------------------------------------------------*/
		/*	결과파일명                                           */
		/*-------------------------------------------------------*/
		sprintf(szRstFile,"%s/%s.%d.%s.%d.result", gszTempPath, pAcptNo, szSerNo,szSvrIP,szSvrSeq);

		/*-------------------------------------------------------*/
		/*	개발서버에 파일저장 경로+파일명                      */
		/*-------------------------------------------------------*/
		strcpy(szRemoteFileName,szRsrcName);

		sprintf(szLocalFileName,"%s.%s.%d",szRsrcName, pAcptNo, szSerNo);
		sprintf(szLocal,"%s/%s",szReqPath,szLocalFileName);

		bFlag = FALSE;
		do {
			WaitComplete(pAcptNo, szSerNo, szSvrIP, pPrcSys,"COM", pRstCond,szSvrCD,szSvrSeq);
			if (strcmp(pRstCond,"NPRO") != 0)	continue;

			/*---------------------------------------------------*/
			/*	일괄쉘실행이 아니면 처리 프로세스 진행           */
			/*---------------------------------------------------*/
			if (cmp_mid_char(szInfo,29,1,"1") != 0) {
				eCAMS_ACComp_Fork("SYSCOM",pAcptNo, szSerNo, szSvrIP,
						    	szSysCD, szRsrcCD, szDsnCD, gSpoolGB ,szReqCD,pPrcSys,szChangDirPath,
								szRemoteFileName, szPortNo, "000001", szSvrCD, szSvrSeq,1);

				EXEC SQL
					UPDATE  CMR1010 A
					   SET  CR_SRCCMP = 'N'
					 WHERE  CR_ACPTNO = :pAcptNo
					   AND  CR_SERNO  = :szSerNo
					   AND  (    (     :pPrcSys = 'SYSTS'
					   	          AND  A.CR_DEPLOYT = 'Y'
					   	         )
					   	     OR  (     :pPrcSys = 'SYSED'
					   	     	  AND  A.CR_DEPLOY  = 'Y'
					   	     	 )
					   	    );

				continue;
			}

			/*---------------------------------------------------*/
			/*	일괄쉘실행 진행                                  */
			/*---------------------------------------------------*/
			EXEC SQL OPEN SYSED_Rsrc3_c_sub;
			while (1) {
		        EXEC SQL fetch SYSED_Rsrc3_c_sub
		        	INTO  :szSubSysOs
		        		, :szSubSvrSeq
		        		, :szSubSvrIP
		        		, :szSubPortNo;

				if (sqlca.sqlcode == 1403)	break;

				NotUseDataTruncate (szSubSysOs, 0x20);
				NotUseDataTruncate (szSubSvrIP, 0x20);

				/*-----------------------------------------------*/
				/*	홈 디렉토리 배포                             */
				/*-----------------------------------------------*/
				if (cmp_mid_char(szInfo,37,1,"1") == 0) {
					EXEC SQL
						SELECT  CM_VOLPATH
						  INTO  :szChangDirPathTmp
						  FROM  CMM0038 b
						 WHERE  CM_SYSCD  = :szSysCD
						   AND  CM_SVRCD  = :szSvrCD
						   AND  CM_SEQNO  = :szSubSvrSeq
						   AND  CM_RSRCCD = :szRsrcCD;

					if (sqlca.sqlcode != 0) {
						/*LOG*/sprintf(gszLogMsg,"[%s][%d][%s] 기준디렉토리 없음 (CMM0038 CM_VOLPATH) [%s][%s][%d][%s] ",pAcptNo,szSerNo,pPrcSys,szSysCD,szSvrCD,szSvrSeq,szRsrcCD);
						eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);
						strcpy(pRstCond,"SIER");

						/*---------------------------------------*/
						/* 자원 전송 결과 작성  	             */
						/*---------------------------------------*/
						Result_Make(szRstFile,"기준디렉토리 없음 (CMM0038 CM_VOLPATH)",szSvrIP,pPrcSys,pRstCond);
						CMR1011_Make (szSysCD, szSvrIP, pAcptNo, szSerNo, szRstFile, szSysStep, pRstCond, szSvrName, pPrcSys,szSvrCD,szSvrSeq);
						continue;
					}
					NotUseDataTruncate (szChangDirPathTmp, 0x20);
				}
				else {
					ChangeVolPath(szSysCD , szSvrCD, szRsrcCD, szSubSvrSeq, szDirPath, szChangDirPathTmp);
				}

				if (cmp_right_char(szChangDirPathTmp, 1, "/") == 0) {
					sprintf(szChangDirPathTmp, "%s", left_char(szChangDirPathTmp, strlen(szChangDirPathTmp) - 1));
				}

				/*-----------------------------------------------*/
				/*	TEMP 디렉토리 저장이면 디렉토리에 TEMP 추가  */
				/*-----------------------------------------------*/
				if (cmp_mid_char(szInfo,23,1,"1") == 0) {
					memset(szChangDirPath   , 0x00   ,sizeof(szChangDirPath   ));
					sprintf(szChangDirPath  , "%s/%s",szChangDirPathTmp,"temp");
					memset(szChangDirPathTmp, 0x00, sizeof(szChangDirPathTmp));
					strcpy(szChangDirPathTmp, szChangDirPath);
				}

				/*-----------------------------------------------*/
				/*	윈도우 서버이면 디렉토리명 변환              */
				/*-----------------------------------------------*/
				Convert_WinDirPath (szSysOS, szChangDirPathTmp, szChangDirPath);

				/*-----------------------------------------------*/
				/*	결과파일명                                   */
				/*-----------------------------------------------*/
				sprintf(szRstFile,"%s/%s.%d.%s.%d.result", gszTempPath, pAcptNo, szSerNo,szSvrIP,szSubSvrSeq);

				/*-----------------------------------------------*/
				/*	개발서버에 파일저장 경로+파일명              */
				/*-----------------------------------------------*/
				strcpy(szRemoteFileName,szRsrcName);
				sprintf(szLocalFileName,"%s.%s.%d",szRsrcName, pAcptNo, szSerNo);
				sprintf(szLocal,"%s/%s",szReqPath,szLocalFileName);

				if (eCAMS_ACComp_Fork("SYSCOM",pAcptNo, szSerNo, szSubSvrIP,
						    	szSysCD, szRsrcCD, szDsnCD, gSpoolGB ,szReqCD,pPrcSys,szChangDirPath,
								szRemoteFileName, szSubPortNo, "000001", szSvrCD, szSubSvrSeq,1) != 0) {
					/*LOG*/sprintf(gszLogMsg, "ECAMS_ACCT1	[%s][%s][%d] eCAMS_ACComp_Fork Fail \n",pAcptNo,pPrcSys,szSerNo);
					eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);

					strcpy(pRstCond,"9999");
					Result_Make(szRstFile,"eCAMS_ACComp_Fork 처리중 오류 [오류건재처리요망]",szSubSvrIP,pPrcSys,pRstCond);
					CMR1011_Make (szSysCD, szSubSvrIP, pAcptNo, szSerNo, szRstFile, 3, pRstCond, szSvrName, pPrcSys,szSvrCD,szSubSvrSeq);

					EXEC SQL
						UPDATE  CMR1010
						   SET  CR_SYSSTEP = DECODE(NVL(CR_PUTCODE, 'N/A'), '0000', 4
						                                                          , 2
						                           )
						      , CR_PUTCODE = DECODE(NVL(CR_PUTCODE, 'N/A'), '0000', NULL
						                                                          , CR_PUTCODE
						                           )
						 WHERE  CR_ACPTNO = :pAcptNo
						   AND  CR_PRCDATE IS NULL
						   AND  NVL(CR_SYSSTEP,0) <= 3;

					if (sqlca.sqlcode != 0 && sqlca.sqlcode != 1403) {
						sprintf(gszLogMsg,"Step Update Err!!! : [%s] [%d] [%s]", pAcptNo, sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
						eCAMS_Log(gszLogPath, gszLogFile, gszLogMsg);

						strcpy(pRstCond,"EROR");
						return sqlca.sqlcode;
					}
					EXEC SQL COMMIT;
					exit(1);
				}
			}
			EXEC SQL close SYSED_Rsrc3_c_sub;

			EXEC SQL
				UPDATE  CMR1010 A
				   SET  CR_SRCCMP = 'N'
				 WHERE  CR_ACPTNO = :pAcptNo
				   AND  (    (     :pPrcSys = 'SYSTS'
				   	          AND  A.CR_DEPLOYT = 'Y'
				   	         )
				   	     OR  (     :pPrcSys = 'SYSED'
				   	     	  AND  A.CR_DEPLOY  = 'Y'
				   	     	 )
				   	    )
		   	       AND  EXISTS (SELECT  'X'
		   	                      FROM  CMM0036
		   	                     WHERE  CM_SYSCD  = A.CR_SYSCD
		   	                       AND  CM_RSRCCD = A.CR_RSRCCD
		   	                       AND  SUBSTR(CM_INFO, 29, 1) = '1'
		   	                   );

			EXEC SQL COMMIT;
			EXEC SQL close SYSED_Rsrc3_c;
			EXEC SQL open  SYSED_Rsrc3_c;
		} while (strcmp(pRstCond,"NPRO") == 0);
	}
    EXEC SQL close SYSED_Rsrc3_c;


 	nComErrCnt = 0;
	/*-----------------------------------------------------------*/
	/*	오류건수 체크                                            */
	/*-----------------------------------------------------------*/
	EXEC SQL
		SELECT  COUNT(a.CR_SEQNO)
		  INTO  :nComErrCnt
		  FROM  CMR1011 a
		      , CMR1010 b
		 WHERE  a.CR_ACPTNO  = :pAcptNo
		   AND  b.CR_PRCDATE IS NULL
		   AND  a.CR_ACPTNO  = b.CR_ACPTNO
		   AND  a.CR_SERNO   = b.CR_SERNO
		   AND  b.CR_STATUS != '3'
		   AND  a.CR_PRCSYS = :pPrcSys
		   AND  (    (     :pPrcSys = 'SYSTS'
		   	          AND  B.CR_DEPLOYT = 'Y'
		   	         )
		   	     OR  (     :pPrcSys = 'SYSED'
		   	     	  AND  B.CR_DEPLOY  = 'Y'
		   	     	 )
		   	    )
		   AND  NVL(b.CR_APLYDATE,TO_CHAR(SYSDATE,'YYYYMMDDHH24MI')) <= TO_CHAR(SYSDATE,'YYYYMMDDHH24MI')
		   AND  NVL(a.CR_PutCode, 'NA') != '0000';

	EXEC SQL
		UPDATE  CMR1010
		   SET  CR_SYSSTEP = DECODE(NVL(CR_PUTCODE, '0000'), '0000', 4
		                                                           , 2
		                           )
		      , CR_PUTCODE = DECODE(NVL(CR_PUTCODE, '0000'), '0000', NULL
		                                                           , CR_PUTCODE
		                           )
		      , CR_SRCCMP  = DECODE(NVL(CR_PUTCODE, '0000'), '0000', 'Y'
		                                                           , CR_SRCCMP
		                           )
		 WHERE  CR_ACPTNO = :pAcptNo
		   AND  CR_PRCDATE IS NULL
		   AND  (    (     :pPrcSys = 'SYSTS'
		   	          AND  CR_DEPLOYT = 'Y'
		   	         )
		   	     OR  (     :pPrcSys = 'SYSED'
		   	     	  AND  CR_DEPLOY  = 'Y'
		   	     	 )
		   	    )
		   AND  NVL(CR_APLYDATE,TO_CHAR(SYSDATE,'YYYYMMDDHH24MI')) <= TO_CHAR(SYSDATE,'YYYYMMDDHH24MI')
		   AND  NVL(CR_SYSSTEP,0) <= 3;

	if (sqlca.sqlcode != 0 && sqlca.sqlcode != 1403) {
		sprintf(gszLogMsg,"Step Update Err!!! : [%s] [%d] [%s]",pAcptNo, sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
		eCAMS_Log(gszLogPath, gszLogFile, gszLogMsg);

		strcpy(pRstCond,"EROR");
		return sqlca.sqlcode;
	}


	EXEC SQL EXECUTE
    	BEGIN
	        UPDATE_1000STEP(:pAcptNo,:szSysStep);
        END;
    END-EXEC;

	if (sqlca.sqlcode != 0) {
		/*LOG*/sprintf(gszLogMsg,"[%s] CMR1000 SYSSTEP UPDATE ERROR [%d] [%s]", pAcptNo,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);

		strcpy(pRstCond,"EROR");
		return sqlca.sqlcode;
	}
	EXEC SQL COMMIT;

	if (nComErrCnt != 0) {
		strcpy(pRstCond,"EROR");
		return nComErrCnt;
	}
	strcpy(pRstCond,"0000");
	return nComErrCnt;
}




/*---------------------------------------------------------------*/
/*	Function  : RunSysedRsrc_MCI_Script                          */
/*	Action    : 컴파일/배포 목록 작성                            */
/*	Parameter :	pAcptNo   : 신청번호                             */
/*	            pPrcSys   : 처리단계                             */
/*	            pRstCond  : 처리결과                             */
/*	Return    : 오류건수                                         */
/*---------------------------------------------------------------*/
int 	RunSysedRsrc_MCI_Script 	( char *pAcptNo
									, char *pPrcSys
									, char *pRstCond
									)
{
char	szSysCD                [dfSysCD];
char	szDsnCD                [dfDsnCD];
char	szRsrcName          [dfRsrcName];
char	szRsrcCD              [dfRsrcCD];
int		szVersion                       ;
int		szBefVer                        ;
char	szEditor              [dfEditor];
int		szSerNo                         ;
char	szSrcChg                   [1+1];
char	szPri                       [10];
char	szPrePri                    [10];
char	szAplyDate                [14+1];
char	szItemID              [dfItemID];
char	szBaseItem            [dfItemID];
char	szReqCD                [dfReqCD];
char	szConfNo              [dfAcptNo];
char	szQryCD                [dfReqCD];
char	szSysGB                    [1+1];
char	szSvrIP                [dfSvrIP];
int		szPortNo                        ;
char	szSvrCD                [dfSvrCD];
char	szSvrName              [dfSvrNM];
char	szDir                    [dfDir];
char	szVolPath                [dfDir];
char	szSysOS                [dfSysOS];
int		szSvrSeq                        ;
char	szInfo                  [dfInfo];
char	szDirPath                [dfDir];
char	szchmod                      [6];
char	szchown                     [21];
char	szchgrp                     [21];
char	szJobCD                [dfJobCD];
char	szSvrInfo            [dfSvrInfo];
char	szReqPath                [dfDir];
char	szRstFile           [dfFullPath];
char	szBKRsrcName        [dfRsrcName];
char	szChangDirPath           [dfDir];
char	szChangDirPathTmp        [dfDir];
char	szRemoteFileName    [dfFullPath];
char	szLocalFileName     [dfFullPath];
char	szBackFileName      [dfRsrcName];
char	szRemote            [dfFullPath];
char	szLocal             [dfFullPath];
char	szCommand           [dfFullPath];
char	idxFileName         [dfFullPath];
char	szFileDate                [14+1];
char	szSubSysOs             [dfSysCD];
int		szSubPortNo                     ;
char	szSubSvrIP             [dfSvrIP];
int		szSubSvrSeq                     ;
int		idxcnt                          ;
int		nRst                            ;
int		nComErrCnt                      ;
int		szSysStep                       ;
struct 	stat f_st                       ;
long	lFileSize                       ;
int		nRet                            ;
int 	nCnt                            ;
int 	retval                          ;
CMD_INFO	  CmdInfo                   ;


	memset(szPrePri , 0x00, sizeof(szPrePri ));
	memset(szReqPath, 0x00, sizeof(szReqPath));

	/*-----------------------------------------------------------*/
	/*	파일 생성시 파일이 저장될 경로 설정및 생성               */
	/*-----------------------------------------------------------*/
	SetTempDir("77",szReqPath);
	strcat(szReqPath,pAcptNo);
	if (access(szReqPath,F_OK) != 0)
		Local_Dir_Make(szReqPath);

	/*-----------------------------------------------------------*/
	/*	소켓 명령 변수 초기화                                    */
	/*-----------------------------------------------------------*/
	InitCmdInfo(&CmdInfo);
	strcpy(CmdInfo.szAcptNo,pAcptNo);
	sprintf(CmdInfo.szLogFile,"%sTransList.%s",gszLogPath,gszLogFile);

	EXEC SQL DECLARE SYSCOM_Rsrc_MCI CURSOR FOR
		SELECT  DISTINCT
		        A.CR_SYSCD
		      , A.CR_DSNCD
		      , A.CR_RSRCCD
		      , A.CR_JOBCD
		      , A.CR_RSRCNAME
		      , A.CR_VERSION
		      , A.CR_BEFVER
		      , A.CR_EDITOR
		      , A.CR_SERNO
		      , A.CR_PRIORITY
		      , A.CR_SRCCHG
		      , NVL(A.CR_APLYDATE, '0')
		      , A.CR_ITEMID
		      , A.CR_QRYCD
		      , A.CR_CONFNO
		      , A.CR_BASEITEM
		      , B.CR_QRYCD
		      , B.CR_SYSGB
		      , C.CM_SVRIP
		      , C.CM_PORTNO
		      , C.CM_SVRCD
		      , C.CM_SVRNAME
		      , C.CM_DIR
		      , C.CM_VOLPATH
		      , C.CM_SYSOS
		      , C.CM_SEQNO
		      , D.CM_INFO
		      , F.CM_DIRPATH
		  FROM  CMR1000 B
		      , CMR1010 A
		      , CMM0031 C
		      , CMM0036 D
		      , CMM0038 E
		      , CMM0070 F
		 WHERE  A.CR_ACPTNO = :pAcptNo
		   AND  A.CR_PRCDATE IS NULL
		   AND  B.CR_ACPTNO = A.CR_ACPTNO
		   AND  A.CR_SYSCD  = C.CM_SYSCD
		   AND  (    (     B.CR_QRYCD IN ('04','16')
		              AND  C.CM_SVRCD  = DECODE(:pPrcSys, 'SYSTS', '35'
		              	                                         , '05'
		              	                       )
		   	         )
		         OR  (     B.CR_QRYCD  = '03'
		              AND  C.CM_SVRCD  = '15'
		   	         )
		         OR  (     B.CR_QRYCD  = '06'
		              AND  C.CM_SVRCD  = DECODE(:pPrcSys, 'SYSTS', '35'
		              	                                         , '05'
		              	                       )
		   	         )
		        )
		   AND  C.CM_CLOSEDT    IS NULL
		   AND  C.CM_SVRSTOP = 'N'
		   AND  D.CM_CLOSEDT    IS NULL
		   AND  A.CR_SYSCD  = D.CM_SYSCD
		   AND  A.CR_RSRCCD = D.CM_RSRCCD
		   AND  (    SUBSTR(D.CM_INFO,59,1) = '1'
		         OR  SUBSTR(D.CM_INFO,60,1) = '1'
		         OR  SUBSTR(D.CM_INFO,61,1) = '1'
		        )
		   AND  A.CR_SYSCD  = E.CM_SYSCD
		   AND  A.CR_RSRCCD = E.CM_RSRCCD
		   AND  C.CM_SVRCD  = E.CM_SVRCD
		   AND  C.CM_SEQNO  = E.CM_SEQNO
		   AND  A.CR_SYSCD  = F.CM_SYSCD
		   AND  A.CR_DSNCD  = F.CM_DSNCD
		   AND  (    (     :pPrcSys     = 'SYSTS'
		   	          AND  A.CR_DEPLOYT = 'Y'
		   	         )
		   	     OR  (     :pPrcSys     = 'SYSED'
		   	     	  AND  A.CR_DEPLOY  = 'Y'
		   	     	 )
		   	     OR  (     :pPrcSys     = 'SYSMCI'
		   	     	  AND  A.CR_DEPLOYM = 'Y'
		   	     	 )
		   	    )
		   AND  NVL(A.CR_APLYDATE,TO_CHAR(SYSDATE,'YYYYMMDDHH24MI')) <= TO_CHAR(SYSDATE,'YYYYMMDDHH24MI')
		 ORDER  BY  A.CR_PRIORITY, A.CR_SERNO;


	EXEC SQL open  SYSCOM_Rsrc_MCI;
    while (1) {
		EXEC SQL fetch SYSCOM_Rsrc_MCI
			into  :szSysCD
			    , :szDsnCD
			    , :szRsrcCD
			    , :szJobCD
			    , :szRsrcName
			    , :szVersion
			    , :szBefVer
			    , :szEditor
			    , :szSerNo
			    , :szPri
			    , :szSrcChg
			    , :szAplyDate
			    , :szItemID
			    , :szReqCD
			    , :szConfNo
			    , :szBaseItem
			    , :szQryCD
			    , :szSysGB
			    , :szSvrIP
			    , :szPortNo
			    , :szSvrCD
			    , :szSvrName
			    , :szDir
			    , :szVolPath
			    , :szSysOS
			    , :szSvrSeq
			    , :szInfo
			    , :szDirPath;

		if (sqlca.sqlcode == 1403)	break;
		if (sqlca.sqlcode != 0 && sqlca.sqlcode != -1405) {
			sprintf(gszLogMsg,"RunSyscomRsrcScript DB FETCH ERROR : [%s] [%d] [%d] [%s]", pAcptNo, szSerNo, sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
			eCAMS_Log(gszLogPath, gszLogFile, gszLogMsg);
			break;
		}

		NotUseDataTruncate (szSysCD   , 0x20);
		NotUseDataTruncate (szDsnCD   , 0x20);
		NotUseDataTruncate (szRsrcCD  , 0x20);
		NotUseDataTruncate (szEditor  , 0x20);
		NotUseDataTruncate (szSrcChg  , 0x20);
		NotUseDataTruncate (szAplyDate, 0x20);
		NotUseDataTruncate (szItemID  , 0x20);
		NotUseDataTruncate (szReqCD   , 0x20);
		NotUseDataTruncate (szConfNo  ,	0x20);
		NotUseDataTruncate (szBaseItem,	0x20);
		NotUseDataTruncate (szQryCD   , 0x20);
		NotUseDataTruncate (szSysGB   , 0x20);
		NotUseDataTruncate (szSvrIP   , 0x20);
		NotUseDataTruncate (szSvrCD   , 0x20);
		NotUseDataTruncate (szSvrName , 0x20);
		NotUseDataTruncate (szDir     , 0x20);
		NotUseDataTruncate (szVolPath , 0x20);
		NotUseDataTruncate (szSysOS   , 0x20);
		NotUseDataTruncate (szInfo    , 0x20);
		NotUseDataTruncate (szPri     , 0x20);
		NotUseDataTruncate (szJobCD   , 0x20);

		sprintf(szRsrcName, "%s", trunc_char(szRsrcName));
		sprintf(szDirPath , "%s", trunc_char(szDirPath ));
		strcpy(szBKRsrcName,szRsrcName);

		ChangeVolPath(szSysCD , szSvrCD, szRsrcCD, szSvrSeq, szDirPath, szChangDirPathTmp);

		if (cmp_mid_char(szInfo,19,1,"1") == 0) {
			EXEC SQL
				SELECT  CM_VOLPATH
				  INTO  :szChangDirPath
				  FROM  CMM0038
				 WHERE  CM_SYSCD  = :szSysCD
				   AND  CM_SEQNO  = :szSvrSeq
				   AND  CM_SVRCD  = :szSvrCD
				   AND  CM_RSRCCD = :szRsrcCD;

			if (sqlca.sqlcode != 0) {
				sprintf(gszLogMsg, "SQLErrCheck 2: REAL Server 정보 오류 syscd[%s]rsrccd[%s]svrcd[%s]szSeqNo[%d] [%d] [%s]", szSysCD,szRsrcCD,szSvrCD,szSvrSeq,sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
				eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);
				exit (1);
			}

			NotUseDataTruncate (szChangDirPath, 0x20);
			sprintf(szChangDirPathTmp, "%s/%s/%s", szChangDirPath,pAcptNo, right_char(szChangDirPathTmp, strlen(szChangDirPathTmp) - strlen(szChangDirPath)));
		}

		if (cmp_right_char(szChangDirPathTmp, 1, "/") == 0){
			sprintf(szChangDirPathTmp, "%s", left_char(szChangDirPathTmp, strlen(szChangDirPathTmp) - 1));
		}

		/*-------------------------------------------------------*/
		/* 	OS 별 디렉토리 변환                                  */
		/*-------------------------------------------------------*/
		Convert_WinDirPath (szSysOS, szChangDirPathTmp, szChangDirPath);

		/*-------------------------------------------------------*/
		/*	결과파일명                                           */
		/*-------------------------------------------------------*/
		sprintf(szRstFile,"%s/%s.%d", gszTempPath, pAcptNo, szSerNo);

		/*-------------------------------------------------------*/
		/*	개발서버에 파일저장 경로+파일명                      */
		/*-------------------------------------------------------*/
		strcpy(szRemoteFileName,szRsrcName);
		sprintf(szLocalFileName,"%s.%s.%d",szRsrcName, pAcptNo, szSerNo);
		sprintf(szLocal,"%s/%s",szReqPath,szLocalFileName);

		/*-------------------------------------------------------*/
		/*	MCI 연계인 경우 LOAD 요청                            */
		/*-------------------------------------------------------*/
		if (strcmp(pPrcSys, "SYSMCI") == 0 ||
			strcmp(pPrcSys, "SYSTS" ) == 0 ) {
			if (cmp_mid_char(szInfo,59,1,"1") == 0) {
				/*LOG*/sprintf(gszLogMsg,"[%s][%d][%s]ECAMS_ACCT1 MCI 연계[%s] %s", pAcptNo,szSerNo,pPrcSys,szQryCD, szInfo);
		    	eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);

				sprintf(szCommand, "ecams_mci %s %d %s %s %d", pAcptNo, szSerNo, pPrcSys, szSvrCD, szSvrSeq);
				retval = system (szCommand)/256;
				if (retval == 0) {
					sprintf(szCommand, "ecams_mci %s %d %s1 %s %d ", pAcptNo, szSerNo, pPrcSys, szSvrCD, szSvrSeq);
					retval = system (szCommand)/256;
				}
			}
	    }

		/*-------------------------------------------------------*/
		/*	EAI 연계인 경우 LOAD 요청                            */
		/*-------------------------------------------------------*/
		if (strcmp(pPrcSys, "SYSMCI") != 0) {
			if (cmp_mid_char(szInfo,60,1,"1") == 0) {
				/*LOG*/sprintf(gszLogMsg,"[%s][%d][%s]ECAMS_ACCT1 EAI 연계[%s] %s", pAcptNo,szSerNo,pPrcSys,szQryCD, szInfo);
		    	eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);

				sprintf(szCommand, "ecams_eai %s %d %s %s %d %s ", pAcptNo, szSerNo, pPrcSys, szSvrCD, szSvrSeq, "EAI");
				retval = system (szCommand)/256;
		    }
		}
		
		/*-------------------------------------------------------*/
		/*	FEP 연계인 경우 LOAD 요청                            */
		/*-------------------------------------------------------*/
		if (strcmp(pPrcSys, "SYSMCI") != 0) {
			if (cmp_mid_char(szInfo,61,1,"1") == 0) {
				/*LOG*/sprintf(gszLogMsg,"[%s][%d][%s]ECAMS_ACCT1 FEP 연계[%s] %s", pAcptNo,szSerNo,pPrcSys,szQryCD, szInfo);
		    	eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);

				sprintf(szCommand, "ecams_eai %s %d %s %s %d %s ", pAcptNo, szSerNo, pPrcSys, szSvrCD, szSvrSeq, "FEP");
				retval = system (szCommand)/256;
		    }
		}
	}
    EXEC SQL close SYSCOM_Rsrc_MCI;

	/*-----------------------------------------------------------*/
	/*	MCI/EAI/FEP 연계 처리완료 여부 체크                      */
	/*-----------------------------------------------------------*/
	while (1) {
		sleep (3);
		sprintf(szCommand, "procck1 ecams_mci %s", pAcptNo);
		retval = system(szCommand) / 256;
		if (retval > 0)	continue;

		sprintf(szCommand, "procck1 ecams_eai %s", pAcptNo);
		retval = system(szCommand) / 256;
		if (retval > 0)	continue;

		break;
	}


	/*-----------------------------------------------------------*/
	/*	처리완료 여부 체크                                       */
	/*-----------------------------------------------------------*/
	nComErrCnt = 0;

	/*-----------------------------------------------------------*/
	/*	처리결과 오류건수 조회                                   */
	/*-----------------------------------------------------------*/
	EXEC SQL
		SELECT  COUNT(a.CR_SEQNO)
		  INTO  :nComErrCnt
		  FROM  CMR1011 a
		      , CMR1010 b
		 WHERE  a.CR_ACPTNO  = :pAcptNo
		   AND  b.CR_PRCDATE IS NULL
		   AND  a.CR_ACPTNO  = b.CR_ACPTNO
		   AND  a.CR_SERNO   = b.CR_SERNO
		   AND  b.CR_STATUS != '3'
		   AND  a.CR_PRCSYS  = :pPrcSys
		   AND  NVL(a.CR_PUTCODE,'NA') != '0000';

	/*-----------------------------------------------------------*/
	/*	처리단계 변경                                            */
	/*-----------------------------------------------------------*/
	EXEC SQL
		UPDATE  CMR1010
		   SET  CR_SYSSTEP = DECODE(NVL(CR_PUTCODE,'0000'),'0000', 3
		                                                         , 2
		                           )
		      , CR_PUTCODE = DECODE(NVL(CR_PUTCODE,'0000'),'0000', NULL
		                                                         , CR_PUTCODE
		                           )
		 WHERE  CR_ACPTNO  = :pAcptNo
		   AND  CR_PRCDATE IS NULL
		   AND  NVL(CR_SYSSTEP,0) <= 2;

	if (sqlca.sqlcode != 0 && sqlca.sqlcode != 1403) {
		sprintf(gszLogMsg,"Step Update Err!!! : [%s] [%d] [%s]", pAcptNo, sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
		eCAMS_Log(gszLogPath, gszLogFile, gszLogMsg);

		strcpy(pRstCond,"EROR");
		return sqlca.sqlcode;
	}

	EXEC SQL EXECUTE
    	BEGIN
	        UPDATE_1000STEP(:pAcptNo,:szSysStep);
        END;
    END-EXEC;

	if (sqlca.sqlcode != 0) {
		/*LOG*/sprintf(gszLogMsg,"[%s] CMR1000 SYSSTEP UPDATE ERROR [%d] [%s]", pAcptNo,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);
		strcpy(pRstCond,"EROR");
		return sqlca.sqlcode;
	}
	EXEC SQL COMMIT;

	if (nComErrCnt != 0) {
		strcpy(pRstCond,"EROR");
		return nComErrCnt;
	}
	strcpy(pRstCond, "0000");

	return nComErrCnt;
}

/*---------------------------------------------------------------*/
/*             E N D    O F    P R O G R A M                     */
/*---------------------------------------------------------------*/
