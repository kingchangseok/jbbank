/*-----------------------------------------------------------------
 ┌──────┬───────────────────────┐
 │ 프로그램명 │ ecams_acct_sysced.pc                         │
 ├──────┼───────────────────────┤
 │ 기      능 │ 배포오류로 인한 원복처리                     │
 ├──────┼───────────────────────┤
 │ 작  성  일 │ 2011. 07. 20                                 │
 ├──────┼───────────────────────┤
 │ 작  성  자 │ 최   병   남                                 │
 └──────┴───────────────────────┘
-----------------------------------------------------------------*/

/*---------------------------------------------------------------*/
/*     Header files                                              */
/*---------------------------------------------------------------*/
#include <ecams_util.h>
#include <ecamsapi.h>

EXEC SQL INCLUDE "ecams_acct.h";



/*---------------------------------------------------------------*/
/*       INTERNAL  FUNCTION  DEFINE                              */
/*---------------------------------------------------------------*/
int 	DeclareSyscedRsrcCursor	(char *pAcptNo, char *pPrcSys);
int 	RunSyscedRsrcScript		(char *pAcptNo, char *pPrcSys, char *pRstCond);
int 	UploadSyscedRsrc		(char *pAcptNo, char *pPrcSys, char *pRstCond);



/*---------------------------------------------------------------*/
/*    User Work 변수                                             */
/*---------------------------------------------------------------*/
#define DEBUG 1
char	gSpoolGB                     [2];




/*---------------------------------------------------------------*/
/*	Function  : DeclareSyscedRsrcCursor                          */
/*	Action    : 컴파일/배포 원복대상 목록 작성                   */
/*	Parameter :	pAcptNo   : 신청번호                             */
/*	            pPrcSys   : 처리단계                             */
/*	Return    : 0 : 정상, 1 : 처리대상없슴                       */
/*---------------------------------------------------------------*/
int 	DeclareSyscedRsrcCursor	( char *pAcptNo
								, char *pPrcSys
								)
{
char	szSysCD                [dfSysCD];
char	szDsnCD                [dfDsnCD];
char	szRsrcName          [dfRsrcName];
char	szRsrcCD              [dfRsrcCD];
int		szVersion                       ;
int		szBefVer                        ;
char	szEditor              [dfEditor];
int		szSerNo                         ;
char	szSrcChg                   [1+1];
int		szPri                           ;
char	szAplyDate                [14+1];
char	szItemID              [dfItemID];
char	szReqCD                [dfReqCD];
char	szBaseItem            [dfItemID];
char	szConfNo              [dfAcptNo];
char	szQryCD                [dfReqCD];
char	szSysGB                    [1+1];
char	szSvrIP                [dfSvrIP];
int		szPortNo                        ;
char	szSvrCD                [dfSvrCD];
char	szSvrName              [dfSvrNM];
char	szDir                    [dfDir];
char	szVolPath                [dfDir];
char	szSysOS                [dfSysOS];
int		szSvrSeq                        ;
char	szInfo                  [dfInfo];
char	szDirPath                [dfDir];
char	szJobCD                [dfJobCD];
char	szSvrInfo            [dfSvrInfo];
int 	checkCnt                        ;
int 	tag                             ;
int		szSysStep                       ;


	EXEC SQL DECLARE SYSCED_Rsrc1 CURSOR FOR
			SELECT  DISTINCT
			        A.CR_SYSCD
			      , A.CR_DSNCD
			      , A.CR_RSRCCD
			      , A.CR_RSRCNAME
			      , A.CR_JOBCD
			      , A.CR_VERSION
			      , A.CR_BEFVER
			      , A.CR_EDITOR
			      , A.CR_SERNO
			      , A.CR_PRIORITY
			      , A.CR_SRCCHG
			      , NVL(A.CR_APLYDATE, '0')
			      , A.CR_ITEMID
			      , A.CR_QRYCD
			      , A.CR_CONFNO
			      , A.CR_BASEITEM
			      , B.CR_QRYCD
			      , B.CR_SYSGB
			      , C.CM_SVRIP
			      , C.CM_PORTNO
			      , C.CM_SVRCD
			      , C.CM_SVRNAME
			      , C.CM_DIR
			      , C.CM_VOLPATH
			      , C.CM_SYSOS
			      , C.CM_SEQNO
			      , C.CM_SVRUSE
			      , D.CM_INFO
			      , F.CM_DIRPATH
			  FROM  CMR1000 B
			      , CMR1010 A
			      , CMM0031 C
			      , CMM0036 D
			      , CMM0038 E
			      , CMM0070 F
			 WHERE  A.CR_ACPTNO = :pAcptNo
			   AND  NVL(A.CR_SYSSTEP,0) = :szSysStep
			   AND  A.CR_PRCDATE IS NULL
			   AND  B.CR_ACPTNO = A.CR_ACPTNO
			   AND  A.CR_SYSCD  = C.CM_SYSCD
			   AND  (    (B.CR_QRYCD IN ('03','04') AND INSTR(ROLLBACK_SVR(B.CR_ACPTNO, B.CR_QRYCD, 'F'), C.CM_SVRCD) > 0)
			         OR  (B.CR_QRYCD  = '06'        AND C.CM_SVRCD  in ('03','13'))
			         OR  (B.CR_QRYCD  = '12'        AND C.CM_SVRCD  in ('13','15'))
			   		)
			   AND  SUBSTR(D.CM_INFO,24,1) = '1'
			   AND  C.CM_CLOSEDT    IS NULL
			   AND  C.CM_SVRSTOP = 'N'
			   AND  D.CM_CLOSEDT    IS NULL
			   AND  A.CR_SYSCD  = D.CM_SYSCD
			   AND  A.CR_RSRCCD = D.CM_RSRCCD
			   AND  (    (C.CM_SVRCD in ('03','13') and SUBSTR(D.CM_INFO,13,1) = '1')
			   		 OR  (C.CM_SVRCD in ('05','15') and SUBSTR(D.CM_INFO,11,1) = '1')
			   		)
			   AND  A.CR_SYSCD  = E.CM_SYSCD
			   AND  A.CR_RSRCCD = E.CM_RSRCCD
			   AND  C.CM_SVRCD  = E.CM_SVRCD
			   AND  C.CM_SEQNO  = E.CM_SEQNO
			   AND  A.CR_SYSCD  = F.CM_SYSCD
			   AND  A.CR_DSNCD  = F.CM_DSNCD
		   AND  (    A.CR_PID IS NULL
		         OR  NVL(A.CR_PUTCODE,'RTRY') = 'RTRY'
		        );

	szSysStep = 0;
	checkCnt  = 0;
	tag	= 0;

	EXEC SQL open  SYSCED_Rsrc1;
    while (1) {
		EXEC SQL fetch SYSCED_Rsrc1
			INTO  :szSysCD
			    , :szDsnCD
			    , :szRsrcCD
			    , :szRsrcName
			    , :szJobCD
			    , :szVersion
			    , :szBefVer
			    , :szEditor
			    , :szSerNo
			    , :szPri
			    , :szSrcChg
			    , :szAplyDate
			    , :szItemID
			    , :szReqCD
			    , :szConfNo
			    , :szBaseItem
			    , :szQryCD
			    , :szSysGB
			    , :szSvrIP
			    , :szPortNo
			    , :szSvrCD
			    , :szSvrName
			    , :szDir
			    , :szVolPath
			    , :szSysOS
			    , :szSvrSeq
			    , :szSvrInfo
			    , :szInfo
			    , :szDirPath;

		if (checkCnt == 0 && sqlca.sqlcode == 1403) {
			checkCnt++ ;
			tag = 0 ;
			break;
		}
		else {
			tag = 1 ;
			break;
		}
	}
	EXEC SQL close SYSCED_Rsrc1;

	if (tag == 0 ) return 0;

	return 1;

}


/*---------------------------------------------------------------*/
/*	Function  : Process_SYSCED                                   */
/*	Action    : 컴파일/배포 원복 처리 MAIN                       */
/*	Parameter :	pAcptNo   : 신청번호                             */
/*	            pPrcSys   : 처리단계                             */
/*	            pRstCond  : 처리결과                             */
/*	Return    : NONE                                             */
/*---------------------------------------------------------------*/
void	Process_SYSCED	( char *pAcptNo
						, char *pPrcSys
						, char *pRstCond
						)
{
int		errRtCode                       ;


	sprintf(gSpoolGB, "%s", "1");
	memset (pRstCond, 0x00, sizeof(pRstCond));

	/*LOG*/sprintf(gszLogMsg,"[%s]<%s>처리시작",pAcptNo,pPrcSys);
	eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);

	/*-----------------------------------------------------------*/
	/*	원복 작업에 필요한 자원 정보 조회 쿼리 선언	             */
	/*-----------------------------------------------------------*/
	/*LOG*/sprintf(gszLogMsg,"[%s][%s] DeclareSyscedRsrcCursor Start",pAcptNo, pPrcSys);
	eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);

	errRtCode = 0;
	errRtCode = DeclareSyscedRsrcCursor(pAcptNo, pPrcSys);

	/*LOG*/sprintf(gszLogMsg,"[%s][%s] DeclareSyscedRsrcCursor returned[%d]",pAcptNo, pPrcSys,errRtCode);
	eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);

	/*-----------------------------------------------------------*/
	/*   신청 자원을 생성하여 대상 Server에 Upload 하고 오류가   */
	/*   있을 경우 오류건수를 리턴                               */
	/*-----------------------------------------------------------*/
	/*LOG*/sprintf(gszLogMsg,"[%s][%s] UploadSyscedRsrc  start",pAcptNo, pPrcSys);
	eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);

	errRtCode = 0;
	errRtCode = UploadSyscedRsrc(pAcptNo,pPrcSys,pRstCond );

	/*LOG*/sprintf(gszLogMsg,"[%s][%s] UploadSyscedRsrc returned [%s][%d]",pAcptNo, pPrcSys,pRstCond,errRtCode);
	eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);

	if (errRtCode != 0 ) {
		strcpy(pRstCond, "EROR");
		return ;
	}

	/*-----------------------------------------------------------*/
	/* 대상 서버에 올라간 자원에 대한 script 실행	  	         */
	/*-----------------------------------------------------------*/
	/*LOG*/sprintf(gszLogMsg,"[%s][%s] RunSyscedRsrcScript  start",pAcptNo, pPrcSys);
	eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);

	errRtCode = 0;
	errRtCode = RunSyscedRsrcScript(pAcptNo,pPrcSys,pRstCond);

	/*LOG*/sprintf(gszLogMsg,"[%s][%s] RunSyscedRsrcScript returned [%s][%d]",pAcptNo, pPrcSys,pRstCond,errRtCode);
	eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);

	if (errRtCode != 0 ) {
		strcpy(pRstCond, "EROR");
		return ;
	}

	/*LOG*/sprintf(gszLogMsg,"[%s][%s] 처리완료  [%s]",pAcptNo, pPrcSys,pRstCond);
	eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);
}



/*---------------------------------------------------------------*/
/*	Function  : UploadSyscedRsrc                                 */
/*	Action    : 신청자원 서버로 전송                             */
/*	Parameter :	pAcptNo   : 신청번호                             */
/*	            pPrcSys   : 처리단계                             */
/*	            pRstCond  : 처리결과                             */
/*	Return    : 오류건수                                         */
/*---------------------------------------------------------------*/
int 	UploadSyscedRsrc	( char *pAcptNo
							, char *pPrcSys
							, char *pRstCond
							)
{
char	szSysCD                [dfSysCD];
char	szDsnCD                [dfDsnCD];
char	szRsrcName          [dfRsrcName];
char	szRsrcCD              [dfRsrcCD];
int		szVersion                       ;
int		szBefVer                        ;
char	szEditor              [dfEditor];
int		szSerNo                         ;
char	szSrcChg                   [1+1];
int		szPri                           ;
char	szAplyDate                [14+1];
char	szItemID              [dfItemID];
char	szBaseItem            [dfItemID];
char	szReqCD                [dfReqCD];
char	szConfNo              [dfAcptNo];
char	szQryCD                [dfReqCD];
char	szSysGB                    [1+1];
char	szSvrIP                [dfSvrIP];
int		szPortNo                        ;
char	szSvrCD                [dfSvrCD];
char	szSvrName              [dfSvrNM];
char	szDir                    [dfDir];
char	szVolPath                [dfDir];
char	szSysOS                [dfSysOS];
int		szSvrSeq                        ;
char	szInfo                  [dfInfo];
char	szDirPath                [dfDir];
char	szchmod                      [6];
char	szchown                     [21];
char	szchgrp                     [21];
char	szJobCD                [dfJobCD];
char	szSvrInfo            [dfSvrInfo];
char	szReqPath                [dfDir];
char	szRstFile           [dfFullPath];
char	szBKRsrcName        [dfRsrcName];
char	szChangDirPath           [dfDir];
char	szChangDirPathTmp        [dfDir];
char	szRemoteFileName    [dfFullPath];
char	szLocalFileName     [dfFullPath];
char	szBackFileName      [dfRsrcName];
char	szRemote            [dfFullPath];
char	szLocal             [dfFullPath];
char	szCommand           [dfFullPath];
char	idxFileName         [dfFullPath];
char	szLocalOrg          [dfFullPath];
char	szBackDir                [dfDir];
char	szBackDir2               [dfDir];
char	szFileDate                [14+1];
int		idxcnt                          ;
int		nRst                            ;
int		nPutErrCnt                      ;
int		szSysStep                       ;
struct 	stat f_st                       ;
long	lFileSize                       ;
int		nRet                            ;
CMD_INFO	  CmdInfo                   ;


	memset(szReqPath, 0x00, sizeof(szReqPath));


	/*-----------------------------------------------------------*/
	/*	파일 생성시 파일이 저장될 경로 설정및 생성               */
	/*-----------------------------------------------------------*/
	SetTempDir("77",szReqPath);
	strcat(szReqPath,pAcptNo);
	if (access(szReqPath,F_OK) != 0)
		Local_Dir_Make(szReqPath);

	/*-----------------------------------------------------------*/
	/*	소켓 명령 변수 초기화                                    */
	/*-----------------------------------------------------------*/
	InitCmdInfo(&CmdInfo);
	strcpy(CmdInfo.szAcptNo,pAcptNo);
	sprintf(CmdInfo.szLogFile,"%sTransList.%s",gszLogPath,gszLogFile);

	/*-----------------------------------------------------------*/
	/*	Tar Index 파일 생성 초기화                               */
	/*-----------------------------------------------------------*/
	tar_index_init(pAcptNo,szReqPath);
	idxcnt = 0 ;
	szSysStep = 0;

	EXEC SQL open  SYSCED_Rsrc1;
    while (1) {
		EXEC SQL fetch SYSCED_Rsrc1
			INTO  :szSysCD
			    , :szDsnCD
			    , :szRsrcCD
			    , :szRsrcName
			    , :szJobCD
			    , :szVersion
			    , :szBefVer
			    , :szEditor
			    , :szSerNo
			    , :szPri
			    , :szSrcChg
			    , :szAplyDate
			    , :szItemID
			    , :szReqCD
			    , :szConfNo
			    , :szBaseItem
			    , :szQryCD
			    , :szSysGB
			    , :szSvrIP
			    , :szPortNo
			    , :szSvrCD
			    , :szSvrName
			    , :szDir
			    , :szVolPath
			    , :szSysOS
			    , :szSvrSeq
			    , :szSvrInfo
			    , :szInfo
			    , :szDirPath;

		if (sqlca.sqlcode == 1403)	break;
		if (sqlca.sqlcode != 0 && sqlca.sqlcode != -1405) {
			sprintf(gszLogMsg,"UploadSyscedRsrc DB FETCH ERROR : [%s] [%d] [%d] [%s]",pAcptNo, szSerNo, sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
			eCAMS_Log(gszLogPath, gszLogFile, gszLogMsg);
			break;
		}

		NotUseDataTruncate (szSysCD   ,	0x20);
		NotUseDataTruncate (szDsnCD   ,	0x20);
		NotUseDataTruncate (szRsrcCD  ,	0x20);
		NotUseDataTruncate (szRsrcName,	0x20);
		NotUseDataTruncate (szJobCD   ,	0x20);
		NotUseDataTruncate (szEditor  ,	0x20);
		NotUseDataTruncate (szSrcChg  ,	0x20);
		NotUseDataTruncate (szAplyDate,	0x20);
		NotUseDataTruncate (szItemID  ,	0x20);
		NotUseDataTruncate (szReqCD   ,	0x20);
		NotUseDataTruncate (szConfNo  ,	0x20);
		NotUseDataTruncate (szBaseItem,	0x20);
		NotUseDataTruncate (szQryCD   ,	0x20);
		NotUseDataTruncate (szSysGB   ,	0x20);
		NotUseDataTruncate (szSvrIP   ,	0x20);
		NotUseDataTruncate (szSvrCD   ,	0x20);
		NotUseDataTruncate (szSvrName ,	0x20);
		NotUseDataTruncate (szDir     ,	0x20);
		NotUseDataTruncate (szVolPath ,	0x20);
		NotUseDataTruncate (szSysOS   ,	0x20);
		NotUseDataTruncate (szInfo    ,	0x20);
		NotUseDataTruncate (szDirPath ,	0x20);
		NotUseDataTruncate (szSvrInfo ,	0x20);

		strcpy(szBKRsrcName, szRsrcName);

		/*-------------------------------------------------------*/
		/*	릴리즈시 홈디렉토리 배포면 자원별 홈디렉토리 조회    */
		/*-------------------------------------------------------*/
		ChangeVolPath(szSysCD , szSvrCD, szRsrcCD, szSvrSeq, szDirPath, szChangDirPathTmp);

		if (cmp_right_char(szChangDirPathTmp, 1, "/") == 0) {
			sprintf(szChangDirPathTmp, "%s", left_char(szChangDirPathTmp, strlen(szChangDirPathTmp) - 1));
		}

		/*-------------------------------------------------------*/
		/*	릴리즈시 temp 저장이면 디렉토리에 temp 추가          */
		/*-------------------------------------------------------*/
		if (cmp_mid_char(szInfo,23,1,"1") == 0) {
			memset(szChangDirPath , 0x00   , sizeof(szChangDirPath   ));
			sprintf(szChangDirPath, "%s/%s", szChangDirPathTmp,"temp");
			memset(szChangDirPathTmp, 0x00, sizeof(szChangDirPathTmp));
			strcpy(szChangDirPathTmp, szChangDirPath);
		}

		/*-------------------------------------------------------*/
		/*	OS종류별 디렉토리명 변환                             */
		/*-------------------------------------------------------*/
		Convert_WinDirPath (szSysOS, szChangDirPathTmp, szChangDirPath);

		/*-------------------------------------------------------*/
		/*	결과파일명                                           */
		/*-------------------------------------------------------*/
		sprintf(szRstFile,"%s/%s.%d.%s.%d.result", gszTempPath, pAcptNo, szSerNo,szSvrIP,szSvrSeq);

		/*-------------------------------------------------------*/
		/*	개발서버에 파일저장 경로+파일명                      */
		/*-------------------------------------------------------*/
		strcpy(szRemoteFileName, szRsrcName);
		sprintf(szLocalFileName,"%s.%s.%d",szRsrcName, pAcptNo, szSerNo);
		
		if (strcmp(szSysOS, dfWINDOWS) != 0 ) {
			if (cmp_mid_char(szInfo,50,1,"1") == 0) {
				nRet = Right_Char_Check(szChangDirPath, '/');
				if (nRet > 0) {
					sprintf(szBackFileName, "old%s/%s.%s", right_char(szChangDirPath, strlen(szChangDirPath) - nRet), szRsrcName, "`date +%Y%m%d.%H%M%S`");
				}
			}
		}
		
		sprintf(szLocal, "%s/%s", szReqPath, szLocalFileName);

		if (strcmp(szReqCD, REQ_DELETE) == 0) {
			/*LOG*/sprintf(gszLogMsg,"[%s][%d][SYSCED]ECAMS_ACCT1 폐기/배포안함 : 자원생성 SKIP [%s]", pAcptNo,szSerNo,szRsrcName);
	    	eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);

			strcpy(pRstCond,"0000");
			Result_Make(szRstFile,"폐기 작업-자원생성 처리안함",szSvrIP,pPrcSys,pRstCond);
			CMR1011_Make (szSysCD, szSvrIP, pAcptNo, szSerNo, szRstFile, 0, pRstCond, szSvrName, pPrcSys,szSvrCD,szSvrSeq);
			continue;
		}

		if (strcmp(szReqCD, REQ_NEW) == 0) {
			/*LOG*/sprintf(gszLogMsg,"[%s][%d][SYSCED]ECAMS_ACCT1 신규 ROLLBACK SKIP  [%s]", pAcptNo,szSerNo,szRsrcName);
	    	eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);

			strcpy(pRstCond,"0000");
			Result_Make(szRstFile,"신규 ROLLBACK SKIP",szSvrIP,pPrcSys,pRstCond);
			CMR1011_Make (szSysCD, szSvrIP, pAcptNo, szSerNo, szRstFile, 1004, pRstCond, szSvrName, pPrcSys,szSvrCD,szSvrSeq);
			continue;
		}

		if (strcmp(szQryCD, REQ_ROLLBACK) == 0) {
			sprintf(szCommand, "procck FileRead_cmr0025");
			while (1) {
				nRst = system(szCommand) / 256;
				if (nRst <= 20)	break;
				usleep (300000);
			}
			sprintf(szCommand,"FileRead_cmr0025 '%s' '%s' '%d'",szItemID, szLocal,szBefVer);
			nRst = system(szCommand) / 256;
			if (access(szLocal, F_OK) != 0) {
				/*LOG*/sprintf(gszLogMsg,"[%s][%d] SYSCED 롤백 할 파일 생성 실패 FileRead_cmr0025 [%s]",pAcptNo,szSerNo,szCommand);
				strcpy(pRstCond,"FMER");
				Result_Make(szRstFile,gszLogMsg,szSvrIP,pPrcSys,pRstCond);
				eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);
				CMR1011_Make (szSysCD, szSvrIP, pAcptNo, szSerNo, szRstFile, szSysStep, pRstCond, szSvrName, pPrcSys,szSvrCD,szSvrSeq);
				continue;
			}
		}
		else {
			if (access(szLocal, F_OK) == 0) {
				sprintf(szLocalOrg,"%s.org",szLocal);
				if (access(szLocal,F_OK) != 0) {
					sprintf(szCommand, "mv '%s' '%s'",szLocal, szLocalOrg);
					system(szCommand);
				}
			}

			sprintf(szCommand, "procck FileRead_cmr0025");
			while (1) {
				nRst = system(szCommand) / 256;
				if (nRst <= 20)	break;
				usleep (300000);
			}

			sprintf(szCommand,"FileRead_cmr0025 '%s' '%s' 'last'",szItemID,szLocal);
			nRst = system(szCommand) / 256;
			if (nRst != 0) {
				/*LOG*/sprintf(gszLogMsg,"[%s][%d]ECAMS_ACCT1 Server로 전송할 파일 생성 실패 FileRead_cmr0025 [%s]",pAcptNo,szSerNo,szCommand);
				eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);

				strcpy(pRstCond,"FMER");
				Result_Make(szRstFile,"Server로 전송할 파일 생성 실패",szSvrIP,pPrcSys,pRstCond);
				CMR1011_Make (szSysCD, szSvrIP, pAcptNo, szSerNo, szRstFile, 0, pRstCond, szSvrName, pPrcSys,szSvrCD,szSvrSeq);
				continue;
			}
		}

		stat(szLocal, &f_st);
		lFileSize = f_st.st_size;

		if (lFileSize <= 0) {
			/*LOG*/sprintf(gszLogMsg,"[%s][%d]ECAMS_ACCT1 Server로 전송할 파일 생성 실패 FileRead_cmr0025 [%s]",pAcptNo,szSerNo,szCommand);
			eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);

			strcpy(pRstCond,"FMER");
			Result_Make(szRstFile,"Server로 전송할 파일 생성 실패",szSvrIP,pPrcSys,pRstCond);
			CMR1011_Make (szSysCD, szSvrIP, pAcptNo, szSerNo, szRstFile, 0, pRstCond, szSvrName, pPrcSys,szSvrCD,szSvrSeq);
			continue;
		}

		/*LOG*/sprintf(gszLogMsg,"[%s][%d][SYSCED] ECAMS_ACCT1	Server로 전송할 파일 생성[%s] 사이즈[%ld] szQryCD=[%s]",pAcptNo,szSerNo,szLocal,lFileSize,szQryCD);
		eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);

		memset(szchmod, 0x00, sizeof(szchmod));
		memset(szchown, 0x00, sizeof(szchown));
		memset(szchgrp, 0x00, sizeof(szchgrp));

		/*-------------------------------------------------------*/
		/*	파일 소유자,그룹정보, 권한정보 조회                  */
		/*-------------------------------------------------------*/
		if (memcmp(szSvrInfo,"1",1) == 0) {
			EXEC SQL
				SELECT  a.CM_OWNER
				      , a.CM_GRPID
				      , a.CM_PERMISSION
				  INTO  :szchown
				  	  , :szchgrp
				  	  , :szchmod
				  FROM  CMM0035 a
				      , CMM0030 b
				 WHERE  a.CM_SYSCD = :szSysCD
				   AND  a.CM_SVRCD = :szSvrCD
				   AND  a.CM_SEQNO = :szSvrSeq
				   AND  a.CM_SYSCD = b.CM_SYSCD
				   AND  a.CM_JOBCD = DECODE(SUBSTR(b.CM_SYSINFO, 9, 1), '1', :szJobCD, '****');

			if (sqlca.sqlcode != 0) {
				/*LOG*/sprintf(gszLogMsg,"[%s][%d][SYSCED] 서버 정보 없음 (USER,GROUP,PERMISSION) [%s][%s][%d][%s] ",pAcptNo,szSerNo,szSysCD,szSvrCD,szSvrSeq,szJobCD);
				eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);
				strcpy(pRstCond,"SIER");

				/*-----------------------------------------------*/
				/*	자원 전송 결과 작성  	                     */
				/*-----------------------------------------------*/
				Result_Make(szRstFile,"서버 정보 없음 (USER,GROUP,PERMISSION)",szSvrIP,pPrcSys,pRstCond);
				CMR1011_Make (szSysCD, szSvrIP, pAcptNo, szSerNo, szRstFile, szSysStep, pRstCond, szSvrName, pPrcSys,szSvrCD,szSvrSeq);
				continue;
			}

			NotUseDataTruncate (szchmod, 0x20);
			NotUseDataTruncate (szchown, 0x20);
			NotUseDataTruncate (szchgrp, 0x20);
		}

		nRst = tar_index_insert_Z(pAcptNo,szReqPath,szSvrIP,szSvrSeq,szLocalFileName,szRemoteFileName,szChangDirPath,szchmod,szchown,szchgrp,"",szBackFileName);
		if (nRst != 0){
			/*LOG*/sprintf(gszLogMsg,"[%s][%d] 파일 생성 후 Tar Idx 추가 실패 szLocal [%s]",pAcptNo,szSerNo,szLocal);
			eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);

			strcpy(pRstCond,"TARE");
			Result_Make(szRstFile,"파일 생성 후 Tar Idx 추가 실패",szSvrIP,pPrcSys,pRstCond);
			CMR1011_Make (szSysCD, szSvrIP, pAcptNo, szSerNo, szRstFile, 0, pRstCond, szSvrName, pPrcSys,szSvrCD,szSvrSeq);
			continue;
		}

		idxcnt++;
		/*LOG*/sprintf(gszLogMsg, "[%s][%d][SYSCED] 파일생성 및 Tar 파일 Idx 추가", pAcptNo, szSerNo);
		eCAMS_Log(gszLogPath, gszLogFile, gszLogMsg);
	}
    EXEC SQL close SYSCED_Rsrc1;

	nPutErrCnt = 0;
	/*-----------------------------------------------------------*/
	/*	파일 전송 오류건수 조회                                  */
	/*-----------------------------------------------------------*/
	EXEC SQL
		SELECT  COUNT(a.CR_SEQNO)
		  INTO  :nPutErrCnt
		  FROM  CMR1011 a
		      , CMR1010 b
		 WHERE  a.CR_ACPTNO  = :pAcptNo
		   AND  b.CR_PRCDATE IS NULL
		   AND  a.CR_ACPTNO  = b.CR_ACPTNO
		   AND  a.CR_SERNO   = b.CR_SERNO
		   AND  b.CR_STATUS != '3'
		   AND  a.CR_PRCSYS = :pPrcSys
		   AND  NVL(a.CR_PutCode,'NA') != '0000';

	/*-----------------------------------------------------------*/
	/*	파일전송 결과 변경                                       */
	/*-----------------------------------------------------------*/
	EXEC SQL
		UPDATE  CMR1010
		   SET  CR_SYSSTEP = DECODE(NVL(CR_PUTCODE, '0000'), '0000', 1   , 0         )
		      , CR_PUTCODE = DECODE(NVL(CR_PUTCODE, '0000'), '0000', NULL, CR_PUTCODE)
		 WHERE  CR_ACPTNO = :pAcptNo
		   AND  CR_PRCDATE IS NULL
		   AND  NVL(CR_SYSSTEP,0) <= 0;

	if (sqlca.sqlcode != 0 && sqlca.sqlcode != 1403) {
		sprintf(gszLogMsg,"Step Update Err!!! : [%s] [%d] [%s]", pAcptNo, sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
		eCAMS_Log(gszLogPath, gszLogFile, gszLogMsg);
		strcpy(pRstCond,"EROR");
		return sqlca.sqlcode;
	}
	EXEC SQL COMMIT;

	if (nPutErrCnt != 0) {
		strcpy(pRstCond, "EROR");
		return nPutErrCnt;
	}
	strcpy(pRstCond, "0000");

	szSysStep = 1;
	/*-----------------------------------------------------------*/
	/*	대상서버별 전송                                          */
	/*-----------------------------------------------------------*/
	if (idxcnt> 0) {
		EXEC SQL declare SYSCED_Rsrc2 cursor for
			SELECT 	DISTINCT
			        B.CM_SYSCD
			      , B.CM_SVRCD
			      , B.CM_SVRNAME
			      ,	B.CM_SVRIP
			      ,	B.CM_PORTNO
			      ,	B.CM_DIR
			      ,	B.CM_SEQNO
			  FROM	CMR1010 A
			      , CMM0031 B
			      , CMM0036 C
			      , CMM0038 D
			      , CMR1000 E
			 WHERE  A.CR_ACPTNO = :pAcptNo
			   AND  A.CR_PRCDATE IS NULL
			   AND  E.CR_ACPTNO = A.CR_ACPTNO
			   AND  NVL(A.CR_SYSSTEP,0) = :szSysStep
			   AND  (    (E.CR_QRYCD  IN ('03','04') AND  INSTR(ROLLBACK_SVR(E.CR_ACPTNO,E.CR_QRYCD,'F'),B.CM_SVRCD) > 0)
			         OR  (E.CR_QRYCD  = '06'         AND  B.CM_SVRCD  IN ('03','13'))
			         OR  (E.CR_QRYCD  = '12'         AND  B.CM_SVRCD  IN ('13','15'))
			   		)
			   AND  (    (B.CM_SVRCD IN ('03','13') AND SUBSTR(C.CM_INFO,13,1) = '1')
			   		 OR  (B.CM_SVRCD IN ('05','15') AND SUBSTR(C.CM_INFO,11,1) = '1')
			   		)
			   AND  B.CM_CLOSEDT IS NULL
			   AND  B.CM_SVRSTOP = 'N'
			   AND  A.CR_SYSCD	= B.CM_SYSCD
			   AND  A.CR_SYSCD  = C.CM_SYSCD
			   AND  A.CR_RSRCCD = C.CM_RSRCCD
			   AND  SUBSTR(C.CM_INFO,24,1) = '1'
			   AND  A.CR_SYSCD  = D.CM_SYSCD
			   AND  A.CR_RSRCCD	= D.CM_RSRCCD
			   AND  B.CM_SVRCD	= D.CM_SVRCD
			   AND  B.CM_SEQNO	= D.CM_SEQNO
			   AND  (    A.CR_PID IS NULL
			         OR  NVL(A.CR_PUTCODE,'RTRY') = 'RTRY'
			        );

		EXEC SQL open  SYSCED_Rsrc2;
		while(1) {
			EXEC SQL fetch SYSCED_Rsrc2
				INTO  :szSysCD
					, :szSvrCD
					, :szSvrName
					, :szSvrIP
					, :szPortNo
					, :szDir
					, :szSvrSeq;

			if (sqlca.sqlcode == 1403)	break;
			if (sqlca.sqlcode != 0 && sqlca.sqlcode != -1405) {
				sprintf(gszLogMsg,"SYSCED_Rsrc2 DB FETCH ERROR : [%s] [%d] [%s]", pAcptNo, sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
				eCAMS_Log(gszLogPath, gszLogFile, gszLogMsg);
				break;
			}

			NotUseDataTruncate (szSysCD  , 0x20);
			NotUseDataTruncate (szSvrCD  , 0x20);
			NotUseDataTruncate (szSvrName, 0x20);
			NotUseDataTruncate (szSvrIP  , 0x20);
			NotUseDataTruncate (szDir    , 0x20);

			eCAMS_ACComp_Fork ("SYSTPT", pAcptNo, 1, szSvrIP, szSysCD, "", "", "1","", pPrcSys, ""
			                           , "", szPortNo, "", szSvrCD , szSvrSeq,0);
		}
		EXEC SQL close SYSCED_Rsrc2;
	}

	/*-----------------------------------------------------------*/
	/*	처리완료 여부 체크                                       */
	/*-----------------------------------------------------------*/
	wait_Accomp_Fork("SYSTPT",pAcptNo);


    nPutErrCnt = 0;
	/*-----------------------------------------------------------*/
	/*	파일 전송 오류건수 조회                                  */
	/*-----------------------------------------------------------*/
	EXEC SQL
		SELECT  COUNT(a.CR_SEQNO)
		  INTO  :nPutErrCnt
		  FROM  CMR1011 a
		      , CMR1010 b
		 WHERE  a.CR_ACPTNO  = :pAcptNo
		   AND  b.CR_PRCDATE IS NULL
		   AND  a.CR_ACPTNO  = b.CR_ACPTNO
		   AND  a.CR_SERNO   = b.CR_SERNO
		   AND  b.CR_STATUS != '3'
		   AND  a.CR_PRCSYS  = :pPrcSys
		   AND  NVL(a.CR_PUTCODE, 'N/A') != '0000';

	/*-----------------------------------------------------------*/
	/*	파일전송 결과 변경                                       */
	/*-----------------------------------------------------------*/
	EXEC SQL
		UPDATE  CMR1010
		   SET  CR_SYSSTEP = DECODE(NVL(CR_PUTCODE,'0000'), '0000', 2   , 0         )
		      , CR_PUTCODE = DECODE(NVL(CR_PUTCODE,'0000'), '0000', NULL, CR_PUTCODE)
		 WHERE  CR_ACPTNO = :pAcptNo
		   AND  CR_PRCDATE IS NULL
		   AND  NVL(CR_SYSSTEP, 1) <= 1;

	if (sqlca.sqlcode != 0 && sqlca.sqlcode != 1403) {
		sprintf(gszLogMsg,"Step Update Err!!! : [%s] [%d] [%s]"
						  ,pAcptNo, sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
		eCAMS_Log(gszLogPath, gszLogFile, gszLogMsg);
		strcpy(pRstCond,"EROR");
		return sqlca.sqlcode;
	}
	EXEC SQL COMMIT;

	if (nPutErrCnt != 0) {
		strcpy(pRstCond,"EROR");
		return nPutErrCnt;
	}
	strcpy(pRstCond,"0000");

	return nPutErrCnt;
}



/*---------------------------------------------------------------*/
/*	Function  : RunSyscedRsrcScript                              */
/*	Action    : 전송된 자원에 대하여 스크립트 수행               */
/*	Parameter :	pAcptNo   : 신청번호                             */
/*	            pPrcSys   : 처리단계                             */
/*	            pRstCond  : 처리결과                             */
/*	Return    : 오류건수                                         */
/*---------------------------------------------------------------*/
int 	RunSyscedRsrcScript	( char *pAcptNo
							, char *pPrcSys
							, char *pRstCond
							)
{
char	szSysCD                [dfSysCD];
char	szDsnCD                [dfDsnCD];
char	szRsrcName          [dfRsrcName];
char	szRsrcCD              [dfRsrcCD];
int		szVersion                       ;
int		szBefVer                        ;
char	szEditor              [dfEditor];
int		szSerNo                         ;
char	szSrcChg                   [1+1];
char	szPri                       [10];
char	szPrePri                    [10];
char	szAplyDate                [14+1];
char	szItemID              [dfItemID];
char	szBaseItem            [dfItemID];
char	szReqCD                [dfReqCD];
char	szConfNo              [dfAcptNo];
char	szQryCD                [dfReqCD];
char	szSysGB                    [1+1];
char	szSvrIP                [dfSvrIP];
int		szPortNo                        ;
char	szSvrCD                [dfSvrCD];
char	szSvrName              [dfSvrNM];
char	szDir                    [dfDir];
char	szVolPath                [dfDir];
char	szSysOS                [dfSysOS];
int		szSvrSeq                        ;
char	szInfo                  [dfInfo];
char	szDirPath                [dfDir];
char	szchmod                      [6];
char	szchown                     [21];
char	szchgrp                     [21];
char	szJobCD                [dfJobCD];
char	szSvrInfo            [dfSvrInfo];
char	szReqPath                [dfDir];
char	szRstFile           [dfFullPath];
char	szBKRsrcName        [dfRsrcName];
char	szChangDirPath           [dfDir];
char	szChangDirPathTmp        [dfDir];
char	szRemoteFileName    [dfFullPath];
char	szLocalFileName     [dfFullPath];
char	szBackFileName      [dfRsrcName];
char	szRemote            [dfFullPath];
char	szLocal             [dfFullPath];
char	szCommand           [dfFullPath];
char	idxFileName         [dfFullPath];
char	szSubSysOs             [dfSysCD];
int		szSubPortNo                     ;
char	szSubSvrIP             [dfSvrIP];
int		szSubSvrSeq                     ;
char	szFileDate                [14+1];
int		idxcnt                          ;
int		nRst                            ;
int		nComErrCnt                      ;
int		szSysStep                       ;
struct 	stat f_st                       ;
long	lFileSize                       ;
int		nRet                            ;
int 	nCnt                            ;
CMD_INFO	  CmdInfo                   ;


	memset(szPrePri , 0x00, sizeof(szPrePri ));
	memset(szReqPath, 0x00, sizeof(szReqPath));
	szSysStep = 2;

	/*-----------------------------------------------------------*/
	/*	파일 생성시 파일이 저장될 경로 설정및 생성               */
	/*-----------------------------------------------------------*/
	SetTempDir("77",szReqPath);
	strcat(szReqPath,pAcptNo);
	if (access(szReqPath,F_OK) != 0)
		Local_Dir_Make(szReqPath);

	/*-----------------------------------------------------------*/
	/*	소켓 명령 변수 초기화                                    */
	/*-----------------------------------------------------------*/
	InitCmdInfo(&CmdInfo);
	strcpy(CmdInfo.szAcptNo,pAcptNo);
	sprintf(CmdInfo.szLogFile,"%sTransList.%s",gszLogPath,gszLogFile);


	/*-----------------------------------------------------------*/
	/*	스크립트 수행 대상 목록 작성                             */
	/*-----------------------------------------------------------*/
	EXEC SQL DECLARE SYSCED_Rsrc3 CURSOR FOR
		SELECT  DISTINCT
		        A.CR_SYSCD
		      , A.CR_DSNCD
		      
		      , A.CR_RSRCCD
		      , A.CR_JOBCD
		      , A.CR_RSRCNAME
		      , A.CR_VERSION
		      , A.CR_BEFVER
		      , A.CR_EDITOR
		      , A.CR_SERNO
		      , A.CR_PRIORITY
		      , A.CR_SRCCHG
		      , NVL(A.CR_APLYDATE, '0')
		      , A.CR_ITEMID
		      , A.CR_QRYCD
		      , A.CR_CONFNO
		      , A.CR_BASEITEM
		      , B.CR_QRYCD
		      , B.CR_SYSGB
		      , C.CM_SVRIP
		      , C.CM_PORTNO
		      , C.CM_SVRCD
		      , C.CM_SVRNAME
		      , C.CM_DIR
		      , C.CM_VOLPATH
		      , C.CM_SYSOS
		      , C.CM_SEQNO
		      , D.CM_INFO
		      , F.CM_DIRPATH
		  FROM  CMR1000 B
		      , CMR1010 A
		      , CMM0031 C
		      , CMM0036 D
		      , CMM0038 E
		      , CMM0070 F
		 WHERE  A.CR_ACPTNO = :pAcptNo
		   AND	NVL(A.CR_SYSSTEP,0) = :szSysStep
		   AND	A.CR_SRCCMP = 'Y'
		   AND  A.CR_PRCDATE IS NULL
		   AND  B.CR_ACPTNO = A.CR_ACPTNO
		   AND  A.CR_SYSCD  = C.CM_SYSCD
		   AND  (    (B.CR_QRYCD  IN ('03','04') AND  INSTR(ROLLBACK_SVR(B.CR_ACPTNO,B.CR_QRYCD,'S'),C.CM_SVRCD) > 0)
		         OR  (B.CR_QRYCD  = '06' AND  C.CM_SVRCD  IN ('03','13') )
		         OR  (B.CR_QRYCD  = '12' AND  C.CM_SVRCD  IN ('15') )
				)
		   AND  C.CM_CLOSEDT    IS NULL
		   AND  C.CM_SVRSTOP = 'N'
		   AND  D.CM_CLOSEDT    IS NULL
		   AND  A.CR_SYSCD  = D.CM_SYSCD
		   AND  A.CR_RSRCCD = D.CM_RSRCCD
		   AND  (    (A.CR_QRYCD != '05' AND SUBSTR(D.CM_INFO,21,1) = '1')
		         OR  (A.CR_QRYCD  = '05' AND SUBSTR(D.CM_INFO,18,1) = '1')
		        )
		   AND  A.CR_SYSCD  = E.CM_SYSCD
		   AND  A.CR_RSRCCD = E.CM_RSRCCD
		   AND  C.CM_SVRCD  = E.CM_SVRCD
		   AND  C.CM_SEQNO  = E.CM_SEQNO
		   AND  A.CR_SYSCD  = F.CM_SYSCD
		   AND  A.CR_DSNCD  = F.CM_DSNCD
		   AND  (    A.CR_PID IS NULL
		         OR  NVL(A.CR_PUTCODE, 'RTRY') = 'RTRY'
		        )
		 ORDER  BY  A.CR_PRIORITY, A.CR_SERNO;


	/*-----------------------------------------------------------*/
	/*	스크립트 수행 대상 서버 목록 작성                        */
	/*-----------------------------------------------------------*/
	EXEC SQL DECLARE SYSCED_Rsrc3_sub CURSOR FOR
		SELECT  A.CM_SYSOS
		      , A.CM_SEQNO
		      , A.CM_SVRIP
		      , A.CM_PORTNO
		  FROM  CMM0031 A
		      , CMM0038 B
		 WHERE  A.CM_SYSCD = :szSysCD
		   AND  A.CM_SVRCD = :szSvrCD
		   AND  A.CM_CLOSEDT IS NULL
		   AND  A.CM_SVRSTOP = 'N'
		   AND  A.CM_SYSCD = B.CM_SYSCD
		   AND  A.CM_SVRCD = B.CM_SVRCD
		   AND  A.CM_SEQNO = B.CM_SEQNO
		   AND  B.CM_RSRCCD = :szRsrcCD;

	szSysStep = 2;

	EXEC SQL open  SYSCED_Rsrc3;
    while (1) {
		EXEC SQL fetch SYSCED_Rsrc3
			INTO  :szSysCD
			    , :szDsnCD
			    , :szRsrcCD
			    , :szJobCD
			    , :szRsrcName
			    , :szVersion
			    , :szBefVer
			    , :szEditor
			    , :szSerNo
			    , :szPri
			    , :szSrcChg
			    , :szAplyDate
			    , :szItemID
			    , :szReqCD
			    , :szConfNo
			    , :szBaseItem
			    , :szQryCD
			    , :szSysGB
			    , :szSvrIP
			    , :szPortNo
			    , :szSvrCD
			    , :szSvrName
			    , :szDir
			    , :szVolPath
			    , :szSysOS
			    , :szSvrSeq
			    , :szInfo
			    , :szDirPath;

		if (sqlca.sqlcode == 1403)	break;
		if (sqlca.sqlcode != 0 && sqlca.sqlcode != -1405) {
			sprintf(gszLogMsg,"RunSyscedRsrcScript DB FETCH ERROR : [%s] [%d] [%d] [%s]", pAcptNo, szSerNo, sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
			eCAMS_Log(gszLogPath, gszLogFile, gszLogMsg);
			break;
		}

		NotUseDataTruncate (szSysCD   ,	0x20);
		NotUseDataTruncate (szDsnCD   ,	0x20);
		NotUseDataTruncate (szRsrcCD  ,	0x20);
		NotUseDataTruncate (szRsrcName,	0x20);
		NotUseDataTruncate (szEditor  ,	0x20);
		NotUseDataTruncate (szSrcChg  ,	0x20);
		NotUseDataTruncate (szAplyDate,	0x20);
		NotUseDataTruncate (szItemID  ,	0x20);
		NotUseDataTruncate (szReqCD   ,	0x20);
		NotUseDataTruncate (szConfNo  ,	0x20);
		NotUseDataTruncate (szBaseItem,	0x20);
		NotUseDataTruncate (szQryCD   ,	0x20);
		NotUseDataTruncate (szSysGB   ,	0x20);
		NotUseDataTruncate (szSvrIP   ,	0x20);
		NotUseDataTruncate (szSvrCD   ,	0x20);
		NotUseDataTruncate (szSvrName ,	0x20);
		NotUseDataTruncate (szDir     ,	0x20);
		NotUseDataTruncate (szVolPath ,	0x20);
		NotUseDataTruncate (szSysOS   ,	0x20);
		NotUseDataTruncate (szInfo    ,	0x20);
		NotUseDataTruncate (szDirPath ,	0x20);
		NotUseDataTruncate (szPri     ,	0x20);
		NotUseDataTruncate (szJobCD   ,	0x20);

		strcpy(szBKRsrcName,szRsrcName);

		ChangeVolPath(szSysCD , szSvrCD, szRsrcCD, szSvrSeq, szDirPath, szChangDirPathTmp);

		if (cmp_right_char(szChangDirPathTmp, 1, "/") == 0) {
			sprintf(szChangDirPathTmp, "%s", left_char(szChangDirPathTmp, strlen(szChangDirPathTmp) - 1));
		}

		/*-------------------------------------------------------*/
		/*	릴리즈시 TEMP 저장이면 디렉토리에 TEMP 추가          */
		/*-------------------------------------------------------*/
		if (cmp_mid_char(szInfo,23,1,"1") == 0) {
			memset(szChangDirPath , 0x00   , sizeof(szChangDirPath));
			sprintf(szChangDirPath, "%s/%s", szChangDirPathTmp,"temp");
			memset(szChangDirPathTmp, 0x00, sizeof(szChangDirPathTmp));
			strcpy(szChangDirPathTmp, szChangDirPath);
		}

		/*-------------------------------------------------------*/
		/*	윈도우 서버에 대한 디렉토리명 변환                   */
		/*-------------------------------------------------------*/
		Convert_WinDirPath (szSysOS, szChangDirPathTmp, szChangDirPath);

		/*-------------------------------------------------------*/
		/*	결과파일명                                           */
		/*-------------------------------------------------------*/
		sprintf(szRstFile,"%s/%s.%d.%s.%d.result", gszTempPath, pAcptNo, szSerNo,szSvrIP,szSvrSeq);

		/*-------------------------------------------------------*/
		/*	개발서버에 파일저장 경로+파일명                      */
		/*-------------------------------------------------------*/
		strcpy(szRemoteFileName,szRsrcName);

		sprintf(szLocalFileName,"%s.%s.%d",szRsrcName, pAcptNo, szSerNo);
		
		/*
		if (strcmp(szSysOS, dfWINDOWS) != 0 ) {
			sprintf(szBackFileName,"%s.%s.backup",szRsrcName,pAcptNo);
		}
		*/
		
		sprintf(szLocal, "%s/%s", szReqPath, szLocalFileName);

		Result_Make(szRstFile,"컴파일전 CMR1011 생성",szSvrIP,pPrcSys,"0000");
		CMR1011_Make (szSysCD, szSvrIP, pAcptNo, szSerNo, szRstFile, 2, "0000", szSvrName, pPrcSys,szSvrCD,szSvrSeq);


		/*-------------------------------------------------------*/
		/*	처리결과 초기화                                      */
		/*-------------------------------------------------------*/
		EXEC SQL
			UPDATE  CMR1011
			   SET  CR_PRCRST  = NULL
			      , CR_PUTCODE = NULL
			 WHERE  CR_ACPTNO  = :pAcptNo
			   AND  CR_PRCSYS  = :pPrcSys
			   AND  CR_SERNO   = :szSerNo
  		       AND  CR_SVRSEQ  = :szSvrSeq
  		       AND  CR_IPADDR  = :szSvrIP
			   AND  CR_SVRCD   = :szSvrCD;

		if (sqlca.sqlcode != 0 && sqlca.sqlcode != 1403) {
			sprintf(gszLogMsg,"cr_prcrst clear Err!!! : [%s] [%d] [%s]", pAcptNo, sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
			eCAMS_Log(gszLogPath, gszLogFile, gszLogMsg);
			strcpy(pRstCond,"EROR");
			return 1;
		}
		EXEC SQL COMMIT;


		EXEC SQL
			UPDATE  CMR1010
			   SET  CR_PUTCODE = NULL
			 WHERE  CR_ACPTNO = :pAcptNo
			   AND  CR_SERNO  = :szSerNo;

		if (sqlca.sqlcode != 0 && sqlca.sqlcode != 1403) {
			sprintf(gszLogMsg,"cr_putcode clear Err!!! : [%s] [%d] [%s]", pAcptNo, sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
			eCAMS_Log(gszLogPath, gszLogFile, gszLogMsg);
			strcpy(pRstCond,"EROR");
			return 1;
		}
		EXEC SQL COMMIT;

		if (strcmp(szReqCD, REQ_NEW) == 0) {
			/*LOG*/sprintf(gszLogMsg,"[%s][%d][SYSCED]ECAMS_ACCT1 신규 ROLLBACK SKIP  [%s]", pAcptNo,szSerNo,szRsrcName);
	    	eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);

			strcpy(pRstCond,"0000");
			Result_Make(szRstFile,"신규 ROLLBACK SKIP",szSvrIP,pPrcSys,pRstCond);
			CMR1011_Make (szSysCD, szSvrIP, pAcptNo, szSerNo, szRstFile, 0, pRstCond, szSvrName, pPrcSys,szSvrCD,szSvrSeq);
			continue;
		}

		if (strcmp(pPrcSys,"SYSCED") != 0 )		continue;

		if (strlen(szPrePri) == 0) {
			strcpy(szPrePri, szPri);
		}

		if (strcmp(szPrePri, szPri) != 0) {
			/*LOG*/sprintf(gszLogMsg,"ECAMS_ACCT1	Process_SYSCED(<%s><%s>) [%s][%s]순위 처리 시작 \n",pAcptNo,pPrcSys,szPri,szPrePri);
			eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);

			do {
				/*-----------------------------------------------*/
				/*	현재 우선처리 순위중 처리미완료건 조회       */
				/*-----------------------------------------------*/
				EXEC SQL
					SELECT  COUNT(*)
					  INTO  :nCnt
					  FROM  CMR1010 a
					      , CMR1011 b
					      , CMM0036 c
					 WHERE  a.CR_ACPTNO   = :pAcptNo
					   AND  a.CR_PRIORITY = :szPrePri
					   AND  a.CR_ACPTNO   = b.CR_ACPTNO
					   AND  a.CR_SERNO    = b.CR_SERNO
					   AND  b.CR_PRCSYS   = :pPrcSys
					   AND	a.CR_SYSCD	  = c.CM_SYSCD
					   AND  a.CR_RSRCCD   = c.CM_RSRCCD
					   AND  (    (a.CR_QRYCD != '05' AND SUBSTR(c.CM_INFO,21,1) = '1')
					         OR  (a.CR_QRYCD  = '05' AND SUBSTR(c.CM_INFO,18,1) = '1')
					        )
					   AND  b.CR_PRCRST IS NULL;

				if (sqlca.sqlcode != 0) {
					nCnt = 0;
				}
				sleep(1);
			} while(nCnt != 0);

			/*---------------------------------------------------*/
		    /*	해당 순위가 완료 되었으면 처리된 건에 오류       */
		    /*  결과가 있는지 조회                               */
		    /*---------------------------------------------------*/
			EXEC SQL
				SELECT  COUNT(*)
				  INTO  :nCnt
				  FROM  CMR1010 a
				      , CMR1011 b
				      , CMM0036 c
				 WHERE  a.CR_ACPTNO   = :pAcptNo
				   AND  a.CR_PRIORITY = :szPrePri
				   AND  a.CR_ACPTNO   = b.CR_ACPTNO
				   AND  a.CR_SERNO    = b.CR_SERNO
				   AND  b.CR_PRCSYS   = :pPrcSys
				   AND	a.CR_SYSCD	  = c.CM_SYSCD
				   AND  a.CR_RSRCCD   = c.CM_RSRCCD
				   AND  a.CR_PRCDATE IS NULL
				   AND  (   (A.CR_QRYCD != '05' AND SUBSTR(c.CM_INFO,21,1) = '1')
				         OR (A.CR_QRYCD  = '05' AND SUBSTR(c.CM_INFO,18,1) = '1')
				        )
				   AND  b.CR_PRCRST   != '0000';

			if (nCnt != 0) {
				/*LOG*/sprintf(gszLogMsg, "ECAMS_ACCT1	Process_SYSCOM(<%s><%s>) 상위 우선순위 오류처리 대기[%s] \n",pAcptNo,pPrcSys,szPrePri);
				eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);

				EXEC SQL
					UPDATE  CMR1010
					   SET  CR_SYSSTEP = DECODE(NVL(CR_PUTCODE, 'N/A'), '0000', 3   , 2         )
					      , CR_PUTCODE = DECODE(NVL(CR_PUTCODE, 'N/A'), '0000', NULL, CR_PUTCODE)
					 WHERE  CR_ACPTNO  = :pAcptNo
					   AND  CR_PRCDATE IS NULL
					   AND  NVL(CR_SYSSTEP, 0) <= 2;

				if (sqlca.sqlcode != 0 && sqlca.sqlcode != 1403) {
					sprintf(gszLogMsg,"Step Update Err!!! : [%s] [%d] [%s]",pAcptNo, sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
					eCAMS_Log(gszLogPath, gszLogFile, gszLogMsg);
					strcpy(pRstCond,"EROR");
					return sqlca.sqlcode;
				}

				EXEC SQL
					DELETE  FROM  CMR1011
					 WHERE  CR_ACPTNO = :pAcptNo
					   AND  CR_SERNO  = :szSerNo
					   AND  CR_SVRSEQ = :szSvrSeq
					   AND  CR_PRCSYS = :pPrcSys
					   AND  CR_SVRCD  = :szSvrCD;

				EXEC SQL COMMIT;
				exit (1);
			}
		}
		strcpy(szPrePri,szPri);

		/*-------------------------------------------------------*/
		/*	신청건 일괄 쉘 실행                                  */
		/*-------------------------------------------------------*/
		if (cmp_mid_char(szInfo,29,1,"1") == 0) {
			EXEC SQL OPEN SYSCED_Rsrc3_sub;
			while (1) {
		        EXEC SQL fetch SYSCED_Rsrc3_sub
		        	INTO  :szSubSysOs
		        		, :szSubSvrSeq
		        		, :szSubSvrIP
		        		, :szSubPortNo;

				if (sqlca.sqlcode == 1403)	break;

				NotUseDataTruncate (szSubSysOs, 0x20);
				NotUseDataTruncate (szSubSvrIP, 0x20);

				/*-----------------------------------------------*/
				/*	릴리즈시 홈 디렉토리 배포면 홈디렉토리 조회  */
				/*-----------------------------------------------*/
				ChangeVolPath(szSysCD, szSvrCD, szRsrcCD, szSubSvrSeq, szDirPath, szChangDirPathTmp);

				if (cmp_right_char(szChangDirPathTmp, 1, "/") == 0) {
					sprintf(szChangDirPathTmp, "%s", left_char(szChangDirPathTmp, strlen(szChangDirPathTmp) - 1));
				}

				/*-----------------------------------------------*/
				/*	릴리즈시 TEMP 배포면 디렉토리에 TEMP 추가    */
				/*-----------------------------------------------*/
				if (cmp_mid_char(szInfo,23,1,"1") == 0) {
					memset(szChangDirPath , 0x00   , sizeof(szChangDirPath));
					sprintf(szChangDirPath, "%s/%s", szChangDirPathTmp, "temp");
					memset(szChangDirPathTmp, 0x00, sizeof(szChangDirPathTmp));
					strcpy(szChangDirPathTmp, szChangDirPath);
				}

				/*-----------------------------------------------*/
				/*	윈도우 서버이면 디렉토리명 변환              */
				/*-----------------------------------------------*/
				Convert_WinDirPath (szSubSysOs, szChangDirPathTmp, szChangDirPath);

				/*-----------------------------------------------*/
				/*	결과파일명                                   */
				/*-----------------------------------------------*/
				sprintf(szRstFile,"%s/%s.%d.%s.%d.result", gszTempPath, pAcptNo, szSerNo,szSvrIP,szSubSvrSeq);

				/*-----------------------------------------------*/
				/*	개발서버에 파일저장 경로+파일명              */
				/*-----------------------------------------------*/
				strcpy(szRemoteFileName,szRsrcName);
				sprintf(szLocalFileName,"%s.%s.%d",szRsrcName, pAcptNo, szSerNo);
				sprintf(szLocal,"%s/%s",szReqPath,szLocalFileName);

				if (eCAMS_ACComp_Fork("SYSCOM",pAcptNo, szSerNo, szSubSvrIP,
						    	szSysCD, szRsrcCD, szDsnCD, gSpoolGB ,szReqCD,pPrcSys,szChangDirPath,
								szRemoteFileName, szSubPortNo, "000001", szSvrCD, szSubSvrSeq,1) != 0) {
					/*LOG*/sprintf(gszLogMsg, "ECAMS_ACCT1	[%s][%s][%d] eCAMS_ACComp_Fork Fail \n",pAcptNo,pPrcSys,szSerNo);
					eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);

					strcpy(pRstCond,"9999");
					Result_Make(szRstFile,"eCAMS_ACComp_Fork 처리중 오류 [오류건재처리요망]",szSubSvrIP,pPrcSys,pRstCond);
					CMR1011_Make (szSysCD, szSubSvrIP, pAcptNo, szSerNo, szRstFile, 2, pRstCond, szSvrName, pPrcSys,szSvrCD,szSubSvrSeq);

					EXEC SQL
						UPDATE  CMR1010
						   SET  CR_SYSSTEP = DECODE(NVL(CR_PUTCODE, 'N/A'), '0000', 3   , 2         )
						      , CR_PUTCODE = DECODE(NVL(CR_PUTCODE, 'N/A'), '0000', NULL, CR_PUTCODE)
						 WHERE  CR_ACPTNO = :pAcptNo
						   AND  CR_PRCDATE IS NULL
						   AND  NVL(CR_SYSSTEP, 0) <= 2;

					if (sqlca.sqlcode != 0 && sqlca.sqlcode != 1403) {
						sprintf(gszLogMsg,"Step Update Err!!! : [%s] [%d] [%s]", pAcptNo, sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
						eCAMS_Log(gszLogPath, gszLogFile, gszLogMsg);
						strcpy(pRstCond,"EROR");
						return sqlca.sqlcode;
					}
					EXEC SQL COMMIT;
					exit(1);
				}
			}
			EXEC SQL close SYSCED_Rsrc3_sub;

			EXEC SQL
				UPDATE  CMR1010
				   SET  CR_SRCCMP = 'N'
				 WHERE  CR_ACPTNO = :pAcptNo
				   AND	CR_RSRCCD = :szRsrcCD
				   AND	CR_JOBCD  = :szJobCD;

			EXEC SQL COMMIT;
			EXEC SQL close SYSCED_Rsrc3;
			EXEC SQL open  SYSCED_Rsrc3;
		}
		else {
			if (cmp_mid_char(szInfo,31,1,"1") == 0) {
				eCAMS_ACComp_Fork("SYSCOM",pAcptNo, szSerNo, szSvrIP,
						    	szSysCD, szRsrcCD, szDsnCD, gSpoolGB ,szReqCD,pPrcSys,szChangDirPath,
								szRemoteFileName, szPortNo, "000001", szSvrCD, szSvrSeq,0);
			}
			else {
				eCAMS_ACComp_Fork("SYSCOM",pAcptNo, szSerNo, szSvrIP,
						    	szSysCD, szRsrcCD, szDsnCD, gSpoolGB ,szReqCD,pPrcSys,szChangDirPath,
								szRemoteFileName, szPortNo, "000001", szSvrCD, szSvrSeq,1);
			}
		}
	}
    EXEC SQL close SYSCED_Rsrc3;

	/*-----------------------------------------------------------*/
	/*	처리완료 여부 체크                                       */
	/*-----------------------------------------------------------*/
	wait_Accomp_Fork("SYSCOM",pAcptNo);


	nComErrCnt = 0;
	/*-----------------------------------------------------------*/
	/*	처리 결과 오류 건수 조회                                 */
	/*-----------------------------------------------------------*/
	EXEC SQL
		SELECT  COUNT(a.CR_SEQNO)
		  INTO  :nComErrCnt
		  FROM  CMR1011 a
		      , CMR1010 b
		 WHERE  a.CR_ACPTNO  = :pAcptNo
		   AND  b.CR_PRCDATE IS NULL
		   AND  a.CR_ACPTNO  = b.CR_ACPTNO
		   AND  a.CR_SERNO   = b.CR_SERNO
		   AND  b.CR_STATUS != '3'
		   AND  a.CR_PRCSYS  = :pPrcSys
		   AND  NVL(a.CR_PUTCODE,'NA') != '0000';

	/*-----------------------------------------------------------*/
	/*	처리결과 및 작업단계 등록                                */
	/*-----------------------------------------------------------*/
	EXEC SQL
		UPDATE  CMR1010
		   SET  CR_SYSSTEP = DECODE(NVL(CR_PUTCODE, '0000'), '0000', 3   , 2         )
		      ,	CR_PUTCODE = DECODE(NVL(CR_PUTCODE, '0000'), '0000', NULL, CR_PUTCODE)
		 WHERE  CR_ACPTNO = :pAcptNo
		   AND  CR_PRCDATE IS NULL
		   AND  NVL(CR_SYSSTEP,0) <= 2;

	if (sqlca.sqlcode != 0 && sqlca.sqlcode != 1403) {
		sprintf(gszLogMsg,"Step Update Err!!! : [%s] [%d] [%s]", pAcptNo, sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
		eCAMS_Log(gszLogPath, gszLogFile, gszLogMsg);
		strcpy(pRstCond,"EROR");
		return sqlca.sqlcode;
	}
	EXEC SQL COMMIT;

	if (nComErrCnt != 0) {
		strcpy(pRstCond,"EROR");
		return nComErrCnt;
	}
	strcpy(pRstCond, "0000");

	szSysStep = 3;
	/*-----------------------------------------------------------*/
	/*	미처리 대상 재 확인하여 미처리이면 처리로직 수행         */
	/*-----------------------------------------------------------*/
	EXEC SQL DECLARE SYSCED_Rsrc3_c CURSOR FOR
		SELECT  DISTINCT
		        A.CR_SYSCD
		      , A.CR_DSNCD
		      , A.CR_RSRCCD
		      , A.CR_JOBCD
		      , A.CR_RSRCNAME
		      , A.CR_VERSION
		      , A.CR_BEFVER
		      , A.CR_EDITOR
		      , A.CR_SERNO
		      , A.CR_PRIORITY
		      , A.CR_SRCCHG
		      , NVL(A.CR_APLYDATE, '0')
		      , A.CR_ITEMID
		      , A.CR_QRYCD
		      , A.CR_CONFNO
		      , A.CR_BASEITEM
		      , B.CR_QRYCD
		      , B.CR_SYSGB
		      , C.CM_SVRIP
		      , C.CM_PORTNO
		      , C.CM_SVRCD
		      , C.CM_SVRNAME
		      , C.CM_DIR
		      , C.CM_VOLPATH
		      , C.CM_SYSOS
		      , C.CM_SEQNO
		      , D.CM_INFO
		      , F.CM_DIRPATH
		  FROM  CMR1000 B
		      , CMR1010 A
		      , CMM0031 C
		      , CMM0036 D
		      , CMM0038 E
		      , CMM0070 F
		 WHERE  A.CR_ACPTNO = :pAcptNo
		   AND	NVL(A.CR_SYSSTEP,0) = :szSysStep
		   AND	A.CR_SRCCMP = 'Y'
		   AND  A.CR_PRCDATE IS NULL
		   AND  B.CR_ACPTNO = A.CR_ACPTNO
		   AND  A.CR_SYSCD  = C.CM_SYSCD
		   AND  (    (B.CR_QRYCD  IN ('03','04') AND  INStr(ROLLBACK_SVR(B.CR_ACPTNO,B.CR_QRYCD,'S'),C.CM_SVRCD)>0)
		         OR  (B.CR_QRYCD  = '06'         AND  C.CM_SVRCD  in ('03','13'))
		         OR  (B.CR_QRYCD  = '12'         AND  C.CM_SVRCD  in ('15'))
				)
		   AND  C.CM_CLOSEDT    IS NULL
		   AND  C.CM_SVRSTOP = 'N'
		   AND  D.CM_CLOSEDT    IS NULL
		   AND  A.CR_SYSCD  = D.CM_SYSCD
		   AND  A.CR_RSRCCD = D.CM_RSRCCD
		   AND  (    (A.CR_QRYCD != '05' AND SUBSTR(D.CM_INFO,21,1) = '1')
		         OR  (A.CR_QRYCD  = '05' AND SUBSTR(D.CM_INFO,18,1) = '1')
		        )
		   AND  A.CR_SYSCD  = E.CM_SYSCD
		   AND  A.CR_RSRCCD = E.CM_RSRCCD
		   AND  C.CM_SVRCD  = E.CM_SVRCD
		   AND  C.CM_SEQNO  = E.CM_SEQNO
		   AND  A.CR_SYSCD  = F.CM_SYSCD
		   AND  A.CR_DSNCD  = F.CM_DSNCD
		   AND  NOT EXISTS (SELECT  'X'
				              FROM  CMR1011
				             WHERE  CR_ACPTNO = A.CR_ACPTNO
				               AND  CR_SERNO  = A.CR_SERNO
				               AND  CR_PRCSYS = :pPrcSys
				               AND  NVL(CR_PRCRST,'NPRO') = '0000'
		                   )
		   AND  (    A.CR_PID IS NULL
		         OR  NVL(A.CR_PUTCODE,'RTRY') = 'RTRY'
		        )
		 ORDER  BY  A.CR_PRIORITY, A.CR_SERNO;

	EXEC SQL DECLARE SYSCED_Rsrc3_c_sub CURSOR FOR
		SELECT  a.CM_SYSOS
		      , a.CM_SEQNO
		      , a.CM_SVRIP
		      , a.CM_PORTNO
		  FROM  CMM0031 a
		      , CMM0038 b
		 WHERE  a.CM_SYSCD = :szSysCD
		   AND  a.CM_SVRCD = :szSvrCD
		   AND  a.CM_CLOSEDT IS NULL
		   AND  a.CM_SVRSTOP = 'N'
		   AND  a.CM_SYSCD = b.CM_SYSCD
		   AND  a.CM_SVRCD = b.CM_SVRCD
		   AND  a.CM_SEQNO = b.CM_SEQNO
		   AND  b.CM_RSRCCD = :szRsrcCD;

	EXEC SQL open  SYSCED_Rsrc3_c;
    while (1) {
		EXEC SQL fetch SYSCED_Rsrc3_c
			INTO  :szSysCD
			    , :szDsnCD
			    , :szRsrcCD
			    , :szJobCD
			    , :szRsrcName
			    , :szVersion
			    , :szBefVer
			    , :szEditor
			    , :szSerNo
			    , :szPri
			    , :szSrcChg
			    , :szAplyDate
			    , :szItemID
			    , :szReqCD
			    , :szConfNo
			    , :szBaseItem
			    , :szQryCD
			    , :szSysGB
			    , :szSvrIP
			    , :szPortNo
			    , :szSvrCD
			    , :szSvrName
			    , :szDir
			    , :szVolPath
			    , :szSysOS
			    , :szSvrSeq
			    , :szInfo
			    , :szDirPath;

		if (sqlca.sqlcode == 1403)	break;
		if (sqlca.sqlcode != 0 && sqlca.sqlcode != -1405) {
			sprintf(gszLogMsg,"SYSCED_Rsrc3_c DB FETCH ERROR : [%s] [%d] [%d] [%s]",pAcptNo, szSerNo, sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
			eCAMS_Log(gszLogPath, gszLogFile, gszLogMsg);
			break;
		}

		NotUseDataTruncate (szSysCD   ,	0x20);
		NotUseDataTruncate (szDsnCD   ,	0x20);
		NotUseDataTruncate (szRsrcCD  ,	0x20);
		NotUseDataTruncate (szRsrcName,	0x20);
		NotUseDataTruncate (szEditor  ,	0x20);
		NotUseDataTruncate (szSrcChg  ,	0x20);
		NotUseDataTruncate (szAplyDate,	0x20);
		NotUseDataTruncate (szItemID  ,	0x20);
		NotUseDataTruncate (szReqCD   ,	0x20);
		NotUseDataTruncate (szConfNo  ,	0x20);
		NotUseDataTruncate (szBaseItem,	0x20);
		NotUseDataTruncate (szQryCD   ,	0x20);
		NotUseDataTruncate (szSysGB   ,	0x20);
		NotUseDataTruncate (szSvrIP   ,	0x20);
		NotUseDataTruncate (szSvrCD   ,	0x20);
		NotUseDataTruncate (szSvrName ,	0x20);
		NotUseDataTruncate (szDir     ,	0x20);
		NotUseDataTruncate (szVolPath ,	0x20);
		NotUseDataTruncate (szSysOS   ,	0x20);
		NotUseDataTruncate (szInfo    ,	0x20);
		NotUseDataTruncate (szDirPath ,	0x20);
		NotUseDataTruncate (szPri     ,	0x20);
		NotUseDataTruncate (szJobCD   ,	0x20);

		strcpy(szBKRsrcName, szRsrcName);

		/*-------------------------------------------------------*/
		/*	릴리즈시 홈 디렉토리 배포면 홈디렉토리 조회          */
		/*-------------------------------------------------------*/
		ChangeVolPath(szSysCD , szSvrCD, szRsrcCD, szSvrSeq, szDirPath, szChangDirPathTmp);

		if (cmp_right_char(szChangDirPathTmp, 1, "/") == 0) {
			sprintf(szChangDirPathTmp, "%s", left_char(szChangDirPathTmp, strlen(szChangDirPathTmp) - 1));
		}

		/*-------------------------------------------------------*/
		/*	릴리즈시 TEMP 배포면 디렉토리에 TEMP 추가            */
		/*-------------------------------------------------------*/
		if (cmp_mid_char(szInfo,23,1,"1") == 0){
			memset(szChangDirPath,0x00,sizeof(szChangDirPath));
			sprintf(szChangDirPath,"%s/%s",szChangDirPathTmp,"temp");
			memset(szChangDirPathTmp,0x00,sizeof(szChangDirPathTmp));
			strcpy(szChangDirPathTmp,szChangDirPath);
		}

		/*-------------------------------------------------------*/
		/*	윈도우 서버이면 디렉토리명 변환                      */
		/*-------------------------------------------------------*/
		Convert_WinDirPath (szSysOS, szChangDirPathTmp, szChangDirPath);

		/*-------------------------------------------------------*/
		/*	결과파일명                                           */
		/*-------------------------------------------------------*/
		sprintf(szRstFile,"%s/%s.%d.%s.%d.result", gszTempPath, pAcptNo, szSerNo,szSvrIP,szSvrSeq);

		/*-------------------------------------------------------*/
		/*	개발서버에 파일저장 경로+파일명                      */
		/*-------------------------------------------------------*/
		strcpy(szRemoteFileName,szRsrcName);
		sprintf(szLocalFileName,"%s.%s.%d",szRsrcName, pAcptNo, szSerNo);
		
		/*
		if (strcmp(szSysOS, dfWINDOWS) != 0 ) {
			sprintf(szBackFileName,"%s.%s.backup",szRsrcName,pAcptNo);
		}
		*/
		
		sprintf(szLocal,"%s/%s",szReqPath,szLocalFileName);

		if (strcmp(szReqCD, REQ_NEW) == 0) {
			/*LOG*/sprintf(gszLogMsg,"[%s][%d][SYSCED]ECAMS_ACCT1 신규 ROLLBACK SKIP  [%s]", pAcptNo,szSerNo,szRsrcName);
	    	eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);

			strcpy(pRstCond,"0000");
			Result_Make(szRstFile,"신규 ROLLBACK SKIP",szSvrIP,pPrcSys,pRstCond);
			CMR1011_Make (szSysCD, szSvrIP, pAcptNo, szSerNo, szRstFile, 0, pRstCond, szSvrName, pPrcSys,szSvrCD,szSvrSeq);
			continue;
		}

		do {
			/*---------------------------------------------------*/
			/*	처리여부 체크하여 미처리이면 처리로직 수행       */
			/*---------------------------------------------------*/
			WaitComplete(pAcptNo, szSerNo, szSvrIP, pPrcSys,"COM", pRstCond,szSvrCD,szSvrSeq);

			if (strcmp(pRstCond,"NPRO") != 0) break;

			/*---------------------------------------------------*/
			/*	신청건 일괄 쉘 실행                              */
			/*---------------------------------------------------*/
			if (cmp_mid_char(szInfo,29,1,"1") == 0) {
				EXEC SQL OPEN SYSCED_Rsrc3_c_sub;
				while (1) {
			        EXEC SQL fetch SYSCED_Rsrc3_c_sub
			        	INTO  :szSubSysOs
			        		, :szSubSvrSeq
			        		, :szSubSvrIP
			        		, :szSubPortNo;

					if (sqlca.sqlcode == 1403)	break;

					NotUseDataTruncate (szSubSysOs, 0x20);
					NotUseDataTruncate (szSubSvrIP, 0x20);

					/*-------------------------------------------*/
					/*	릴리즈시 홈 디렉토리 배포                */
					/*-------------------------------------------*/
					if (cmp_mid_char(szInfo,37,1,"1") == 0) {
						EXEC SQL
							SELECT  CM_VOLPATH
							  INTO  :szChangDirPathTmp
							  FROM  CMM0038 b
							 WHERE  CM_SYSCD  = :szSysCD
							   AND  CM_SVRCD  = :szSvrCD
							   AND  CM_SEQNO  = :szSubSvrSeq
							   AND  CM_RSRCCD = :szRsrcCD;

						if (sqlca.sqlcode != 0) {
							/*LOG*/sprintf(gszLogMsg,"[%s][%d][SYSCED] 기준디렉토리 없음 (CMM0038 CM_VOLPATH) [%s][%s][%d][%s] ",pAcptNo,szSerNo,szSysCD,szSvrCD,szSvrSeq,szRsrcCD);
							eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);
							strcpy(pRstCond,"SIER");

							/*-----------------------------------*/
							/* 자원 전송 결과 작성  	         */
							/*-----------------------------------*/
							Result_Make(szRstFile,"기준디렉토리 없음 (CMM0038 CM_VOLPATH)",szSvrIP,pPrcSys,pRstCond);
							CMR1011_Make (szSysCD, szSvrIP, pAcptNo, szSerNo, szRstFile, szSysStep, pRstCond, szSvrName, pPrcSys,szSvrCD,szSvrSeq);
							continue;
						}
						NotUseDataTruncate (szChangDirPathTmp, 0x20);
					}
					else {
						ChangeVolPath(szSysCD , szSvrCD, szRsrcCD, szSubSvrSeq, szDirPath, szChangDirPathTmp);
					}

					if (cmp_right_char(szChangDirPathTmp, 1, "/") == 0) {
						sprintf(szChangDirPathTmp, "%s", left_char(szChangDirPathTmp, strlen(szChangDirPathTmp) - 1));
					}

					/*-------------------------------------------*/
					/*	릴리즈시temp 배포면 디렉토리에 temp 추가 */
					/*-------------------------------------------*/
					if (cmp_mid_char(szInfo,23,1,"1") == 0) {
						memset(szChangDirPath , 0x00  , sizeof(szChangDirPath));
						sprintf(szChangDirPath,"%s/%s", szChangDirPathTmp,"temp");
						memset(szChangDirPathTmp, 0x00,sizeof(szChangDirPathTmp));
						strcpy(szChangDirPathTmp, szChangDirPath);
					}

					/*-------------------------------------------*/
					/*	윈도우서버이면 디렉토리명 변경           */
					/*-------------------------------------------*/
					Convert_WinDirPath (szSubSysOs, szChangDirPathTmp, szChangDirPath);

					/*-------------------------------------------*/
					/*	결과파일명                               */
					/*-------------------------------------------*/
					sprintf(szRstFile,"%s/%s.%d.%s.%d.result", gszTempPath, pAcptNo, szSerNo,szSvrIP,szSubSvrSeq);

					/*-------------------------------------------*/
					/*	개발서버에 파일저장 경로+파일명          */
					/*-------------------------------------------*/
					strcpy(szRemoteFileName,szRsrcName);
					sprintf(szLocalFileName,"%s.%s.%d",szRsrcName, pAcptNo, szSerNo);
					sprintf(szLocal,"%s/%s",szReqPath,szLocalFileName);

					if (eCAMS_ACComp_Fork("SYSCOM",pAcptNo, szSerNo, szSubSvrIP,
							    	szSysCD, szRsrcCD, szDsnCD, gSpoolGB ,szReqCD,pPrcSys,szChangDirPath,
									szRemoteFileName, szSubPortNo, "000001", szSvrCD, szSubSvrSeq,1) != 0) {
						/*LOG*/sprintf(gszLogMsg, "ECAMS_ACCT1	[%s][%s][%d] eCAMS_ACComp_Fork Fail \n",pAcptNo,pPrcSys,szSerNo);
						eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);

						strcpy(pRstCond,"9999");
						Result_Make(szRstFile,"eCAMS_ACComp_Fork 처리중 오류 [오류건재처리요망]",szSubSvrIP,pPrcSys,pRstCond);
						CMR1011_Make (szSysCD, szSubSvrIP, pAcptNo, szSerNo, szRstFile, 3, pRstCond, szSvrName, pPrcSys,szSvrCD,szSubSvrSeq);

						EXEC SQL
							UPDATE  CMR1010
							   SET  CR_SYSSTEP = DECODE(NVL(CR_PUTCODE, 'N/A'), '0000', 4   , 2         )
							      , CR_PUTCODE = DECODE(NVL(CR_PUTCODE, 'N/A'), '0000', NULL, CR_PUTCODE)
							 WHERE  CR_ACPTNO = :pAcptNo
							   AND  CR_PRCDATE IS NULL
							   AND  NVL(CR_SYSSTEP,0) <= 3;

						if (sqlca.sqlcode != 0 && sqlca.sqlcode != 1403) {
							sprintf(gszLogMsg,"Step Update Err!!! : [%s] [%d] [%s]", pAcptNo, sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
							eCAMS_Log(gszLogPath, gszLogFile, gszLogMsg);
							strcpy(pRstCond,"EROR");
							return sqlca.sqlcode;
						}
						EXEC SQL COMMIT;
						exit(1);
					}
				}
				EXEC SQL close SYSCED_Rsrc3_c_sub;

				EXEC SQL
					UPDATE  CMR1010
					   SET  CR_SRCCMP = 'N'
					 WHERE  CR_ACPTNO = :pAcptNo
					   AND	CR_RSRCCD = :szRsrcCD
					   AND	CR_JOBCD  = :szJobCD;

				EXEC SQL COMMIT;
				EXEC SQL close SYSCED_Rsrc3_c;
				EXEC SQL open  SYSCED_Rsrc3_c;
			}
			else {
				eCAMS_ACComp_Fork("SYSCOM",pAcptNo, szSerNo, szSvrIP,
						    	szSysCD, szRsrcCD, szDsnCD, gSpoolGB ,szReqCD,pPrcSys,szChangDirPath,
								szRemoteFileName, szPortNo, "000001", szSvrCD, szSvrSeq,1);
			}
		} while (strcmp(pRstCond,"NPRO") == 0);
	}
    EXEC SQL close SYSCED_Rsrc3_c;


 	nComErrCnt = 0;
	/*-----------------------------------------------------------*/
	/*	오류 건수 조회                                           */
	/*-----------------------------------------------------------*/
	EXEC SQL
		SELECT  COUNT(a.CR_SEQNO)
		  INTO  :nComErrCnt
		  FROM  CMR1011 a
		      , CMR1010 b
		 WHERE  a.CR_ACPTNO = :pAcptNo
		   AND  b.CR_PRCDATE IS NULL
		   AND  a.CR_ACPTNO  = b.CR_ACPTNO
		   AND  a.CR_SERNO   = b.CR_SERNO
		   AND  b.CR_STATUS != '3'
		   AND  a.CR_PRCSYS  = :pPrcSys
		   AND  NVL(a.CR_PUTCODE, 'N/A') != '0000';

	/*-----------------------------------------------------------*/
	/*	처리결과 및 작업단계 변경                                */
	/*-----------------------------------------------------------*/
	EXEC SQL
		UPDATE  CMR1010
		   SET  CR_SYSSTEP = DECODE(NVL(CR_PUTCODE, '0000'), '0000', 4   , 2         )
		      , CR_PUTCODE = DECODE(NVL(CR_PUTCODE, '0000'), '0000', NULL, CR_PUTCODE)
		      , CR_SRCCMP  = DECODE(NVL(CR_PUTCODE, '0000'), '0000', 'Y' , CR_SRCCMP )
		 WHERE  CR_ACPTNO = :pAcptNo
		   AND  CR_PRCDATE IS NULL
		   AND  NVL(CR_SYSSTEP,0) <= 3;

	if (sqlca.sqlcode != 0 && sqlca.sqlcode != 1403) {
		sprintf(gszLogMsg,"Step Update Err!!! : [%s] [%d] [%s]", pAcptNo, sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
		eCAMS_Log(gszLogPath, gszLogFile, gszLogMsg);
		strcpy(pRstCond,"EROR");
		return sqlca.sqlcode;
	}
	EXEC SQL COMMIT;

	if (nComErrCnt != 0) {
		strcpy(pRstCond,"EROR");
		return nComErrCnt;
	}

	strcpy(pRstCond,"0000");
	return nComErrCnt;

}

/*---------------------------------------------------------------*/
/*             E N D    O F    P R O G R A M                     */
/*---------------------------------------------------------------*/
