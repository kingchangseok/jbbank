/*--------------------------------------------------------------
 ┌──────┬───────────────────────┐
 │ 프로그램명 │ ecams_verfile.pc                             │
 ├──────┼───────────────────────┤
 │ 기      능 │ eCAMS 완료처리 시 신청자원의 버전파일 작성   │
 ├──────┼───────────────────────┤
 │ 작  성  일 │ 2011. 08. 16                                 │
 ├──────┼───────────────────────┤
 │ 작  성  자 │ 최   병   남                                 │
 └──────┴───────────────────────┘
-----------------------------------------------------------------*/

#define DEBUG 1
#define		dfMain		1


/*---------------------------------------------------------------*/
/*     Header files                                              */
/*---------------------------------------------------------------*/
#include	<ecamsapi.h>
#include 	<ecams_util.h>

EXEC SQL INCLUDE "ecams_acct.h";


/*---------------------------------------------------------------*/
/*       Oracle Sql Bind 변수 DEFINE                             */
/*---------------------------------------------------------------*/


/*---------------------------------------------------------------*/
/*       USER  PROCEDURE  DEFINE                                 */
/*---------------------------------------------------------------*/



/*---------------------------------------------------------------*/
/*		USER WORK DEFINE                                         */
/*---------------------------------------------------------------*/
char	gszRsultPath             [dfDir];




/*****************************************************************/
/*                                                               */
/*			신청자원의 처리   M A I N                            */
/*                                                               */
/*****************************************************************/
int		main (int argc, char **argv, char** envp)
{
char	szAcptNo              [dfAcptNo]; /* eCAMS Log 접수번호  */
char	szRstCond            [dfRstCode]; /* 처리 결과 받을 변수 */
char	SysCmd                     [256];
char	szJobID               [dfPrcSys];
int		nPid                            ;


    if ( argc < 2 ) {
        printf ("usage : %s <신청번호>\n", argv[0]);
        exit (0);
	}
	
	memset(szAcptNo , 0x00, sizeof(szAcptNo ));
    memset(szRstCond, 0x00, sizeof(szRstCond));

	/*-----------------------------------------------------------*/
	/* 로그 파일 Set	        	  		                     */
	/*-----------------------------------------------------------*/
	Get_Sys_Date(gszLogFile);
	strcat(gszLogFile,".log");
	strcpy(gszLogPath,"LogMessage/");

	/*-----------------------------------------------------------*/
	/* 	신청번호 , 시리얼번호 초기화	          			     */
	/*-----------------------------------------------------------*/
	sprintf(szAcptNo   , "%s", argv[1]);     /* 접수번호         */
	gEnvp = envp;				         /*### gEnvp = 환경변수  */

	if (argc > 2) {
		sprintf(szJobID, "%s", argv[2]);		
	}
	NotUseDataTruncate (szJobID, 0x20);

	/*-----------------------------------------------------------*/
    /*   Signal Define			                                 */
    /*-----------------------------------------------------------*/
    DefineSignal ();

    /*-----------------------------------------------------------*/
    /*   eCAMS  DB Server  Connect                               */
    /*-----------------------------------------------------------*/
	if (ConnectDB() == FALSE)
		exit(1);

	/*-----------------------------------------------------------*/
    /*   Set Temp Directory                                      */
    /*-----------------------------------------------------------*/
	SetTempDir("99", gszTempPath);

	/*-----------------------------------------------------------*/
    /*   소스백업 디렉토리                                       */
    /*-----------------------------------------------------------*/
	SetTempDir("93", gszBackPath);

	/*-----------------------------------------------------------*/
	/*	ResultFile Dir 체크                                      */
	/*-----------------------------------------------------------*/
	SetTempDir("11", gszRsultPath);
	Local_Dir_Make(gszRsultPath );

	nPid = getpid ();


	/*-----------------------------------------------------------*/
	/*	신청내역테이블에 처리 프로세스ID SET                     */
	/*-----------------------------------------------------------*/
	EXEC SQL
		UPDATE  CMR1010
	       SET  CR_PID    = :nPid
         WHERE  CR_ACPTNO = :szAcptNo;

	EXEC SQL COMMIT;

	
	/*-----------------------------------------------------------*/
    /*	시스템처리 완료되었으면 신청파일의 버전파일작성          */
    /*-----------------------------------------------------------*/
	if (cmp_mid_char(szAcptNo, 5, 2, "04") == 0 ||
		cmp_mid_char(szAcptNo, 5, 2, "06") == 0 ||
		cmp_mid_char(szAcptNo, 5, 2, "16") == 0 ) {
		Process_VerFile(szAcptNo, szRstCond);
		sprintf(gszLogMsg,"[%s] 버전파일 작성 완료 [%s]", szAcptNo, szRstCond);
		eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);

		if (strlen(szJobID) > 0 && strcmp(szRstCond, "0000") == 0) {
			EXEC SQL EXECUTE
			     BEGIN
			        CMR9900_STR(:szAcptNo, :szJobID, 'eCAMS 자동처리', '9', '', '1');
			     END;
			END-EXEC;
	
			/*LOG*/sprintf(gszLogMsg,"[%s] <%s>결재 처리 EDCB[%s]", szAcptNo, szJobID, szRstCond);
			eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);
		
			EXEC SQL
				UPDATE  CMR1010
				   SET  CR_PID     = NULL
				      , CR_PUTCODE = NULL
				 WHERE  CR_ACPTNO  = :szAcptNo;
		
			if (sqlca.sqlcode != 0) {
				EXEC SQL ROLLBACK WORK RELEASE;
				exit(1);
			}
			sprintf(gszLogMsg,"시스템별 배포를 위한 CR_PUTCODE ,CR_PID 초기화 : [%s]", szAcptNo);
			eCAMS_Log(gszLogPath, gszLogFile, gszLogMsg);
		}	
	}
			
	EXEC SQL COMMIT WORK RELEASE;

	exit(0);
}


/*---------------------------------------------------------------*/
/*             E N D    O F    P R O G R A M                     */
/*---------------------------------------------------------------*/
