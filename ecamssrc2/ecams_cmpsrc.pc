/*-----------------------------------------------------------------
 ┌──────┬───────────────────────┐
 │ 프로그램명 │ ecams_cmpsrc.pc                              │
 ├──────┼───────────────────────┤
 │ 기      능 │ File Compare (diff)                          │
 ├──────┼───────────────────────┤
 │ 작  성  일 │ 2010. 01. 19                                 │
 ├──────┼───────────────────────┤
 │ 작  성  자 │ 최   병   남                                 │
 └──────┴───────────────────────┘
-----------------------------------------------------------------*/

#define		dfMain		1


/*---------------------------------------------------------------*/
/*     Header files                                              */
/*---------------------------------------------------------------*/
#include 	<ecamsapi.h>
#include 	<ecams_util.h>

EXEC SQL INCLUDE "ecams_acct.h";


/*---------------------------------------------------------------*/
/*       INTERNAL  FUNCTION  DEFINE                              */
/*---------------------------------------------------------------*/
int  	Make_DiffFile 		();


/*---------------------------------------------------------------*/
/*    User Work 변수                                             */
/*---------------------------------------------------------------*/
char	SysCmd                    [1024]; /* 시스템 명령문       */
static
char	dummy                   [409600]; /* Read Buffer         */
static
char	dummy1                  [409600]; /* Read Buffer         */
char	devFile             [dfFullPath]; /* Local File SaveFile */
int 	nRet1                           ; /* Char Find Work      */
int 	CurrCnt                         ; /* Source Line Count   */

char   **gEnvp                          ;
extern    int    errno                  ;


/*---------------------------------------------------------------*/
/*	Function  : Make_DiffFile                                    */
/*	Function  : 변경전/변경후 파일 작성                          */
/*	Parameter : RsrcFile  : 원시파일                             */
/*              DiffFile  : 비교파일                             */
/*              RstFile   : 변경전/변경후 결과 파일              */
/*              diffcode  : 변경전/변경후 구분코드               */
/*	Return    : 결과코드                                         */
/*---------------------------------------------------------------*/
int 	Make_DiffFile	( char *RsrcFile
						, char *DiffFile
						, char *RstFile
						, int   diffcode
						)
{
FILE	*OLDPtr                         ;
FILE	*DiffPtr                        ;
FILE	*RstPtr                         ;
char	LeftStr                     [20];
char	RightStr                    [20];
char	DiffCmd                      [5];
int 	Line1                           ;
int 	Line2                           ;
int 	Line3                           ;
int 	Line4                           ;
int 	i                               ;
char	szCntWK                    [256];


    /*-----------------------------------------------------------*/
 	/*   File Open (Diff File)                                   */
    /*-----------------------------------------------------------*/
    if ((DiffPtr = fopen(DiffFile,"r")) == (FILE *) NULL) {
    	printf("FILE OPEN ERROR 1 %s\n", DiffFile);
        return (-1);
    }

    /*-----------------------------------------------------------*/
 	/*   File Open (OLD/NEW File)                                */
    /*-----------------------------------------------------------*/
    if ((OLDPtr = fopen(RsrcFile,"r")) == (FILE *) NULL) {
    	printf("FILE OPEN ERROR 2 %s\n", RsrcFile);
    	fclose (DiffPtr);
        return (-1);
    }

    /*-----------------------------------------------------------*/
 	/*   File Open (Result File)                                 */
    /*-----------------------------------------------------------*/
    if ((RstPtr = fopen(RstFile,"w")) == (FILE *) NULL) {
    	printf("FILE OPEN ERROR 3 %s\n", RstFile);
    	fclose (DiffPtr);
    	fclose (OLDPtr);
        return (-1);
    }

    CurrCnt = 0;
    while (fgets(dummy, 409600, DiffPtr) != (char *) NULL) {
        /*-------------------------------------------------------*/
    	/* Return Valure Truncate                                */
        /*-------------------------------------------------------*/
        sprintf(dummy, "%s", rep_char(dummy,"\r\n",""));
        sprintf(dummy, "%s", rep_char(dummy,"\r",""));
        sprintf(dummy, "%s", rep_char(dummy,"\n",""));

        /*-------------------------------------------------------*/
    	/*    변경기록 Line 추출                                 */
        /*-------------------------------------------------------*/
        if (memcmp(dummy,"0",1) >= 0 &&
            memcmp(dummy,"9",1) <= 0 ) {
           nRet1 = Char_Check(dummy, "d");
           if (nRet1 < 0) {
              nRet1 = Char_Check(dummy, "a");
              if (nRet1 < 0) {
                 nRet1 = Char_Check(dummy, "c");
                 if (nRet1 < 0) {
                     printf("DIFF Check Error  %s\n", dummy);
                 }
              }
           }

           /*----------------------------------------------------*/
           /*   변경 Line 계산                                   */
           /*     OLD (From/TO),  TO (From/TO)                   */
           /*----------------------------------------------------*/
           if (nRet1 >= 0) {
              memset(LeftStr, 0x00, sizeof(LeftStr));
              memset(RightStr, 0x00, sizeof(RightStr));
              memset(DiffCmd, 0x00, sizeof(DiffCmd));

              memcpy(LeftStr, dummy, nRet1);
              memcpy(RightStr, &dummy[nRet1+1], strlen(dummy)-nRet1);
              memcpy(DiffCmd, &dummy[nRet1], 1);

              nRet1 = Char_Check(LeftStr, ",");
              if (nRet1 < 0) {
              	 Line1 = atoi(LeftStr);
              	 Line2 = atoi(LeftStr);
              }
              else {
				memset(szCntWK, 0x00, sizeof(szCntWK));
				sprintf(szCntWK, "%s", left_char(LeftStr, nRet1));
				Line1 = atoi(szCntWK);

				memset(szCntWK, 0x00, sizeof(szCntWK));
				sprintf(szCntWK, "%s", right_char(LeftStr, strlen(LeftStr)-nRet1-1));
				Line2 = atoi(szCntWK);
              }

              nRet1 = Char_Check(RightStr, ",");
              if (nRet1 < 0) {
              	 Line3 = atoi(RightStr);
              	 Line4 = atoi(RightStr);
              }
              else {
				memset(szCntWK, 0x00, sizeof(szCntWK));
				sprintf(szCntWK, "%s", left_char(RightStr, nRet1));
				Line3 = atoi(szCntWK);

				memset(szCntWK, 0x00, sizeof(szCntWK));
				sprintf(szCntWK, "%s", right_char(RightStr, strlen(RightStr)-nRet1-1));
				Line4 = atoi(szCntWK);
              }
           }

           /*----------------------------------------------------*/
    	   /*    변경전 파일 작성                                */
           /*----------------------------------------------------*/
           if (diffcode == 1) {
              /*-------------------------------------------------*/
    	      /*    Delete Line 작성                             */
              /*-------------------------------------------------*/
              if (memcmp(DiffCmd, "d", 1) == 0) {
                 while (1) {
                    if (fgets(dummy, 409600, OLDPtr) == (char *) NULL) break;

			        sprintf(dummy, "%s", rep_char(dummy,"\r\n",""));
			        sprintf(dummy, "%s", rep_char(dummy,"\r",""));
			        sprintf(dummy, "%s", rep_char(dummy,"\n",""));

                    CurrCnt++;
                    if (CurrCnt < Line1)
                       fprintf(RstPtr, "  %s\r\n", dummy);
                    else if (CurrCnt <= Line2)
                       fprintf(RstPtr, "D %s\r\n", dummy);

                    if (CurrCnt == Line2) break;
                 }
              }

              /*-------------------------------------------------*/
              /*    Insert Line 작성                             */
              /*-------------------------------------------------*/
              else if (memcmp(DiffCmd, "a", 1) == 0) {
				 if (Line2 == 0) {
					for (i = Line3; i <= Line4; i++) {
						fprintf(RstPtr, "  \r\n");
					}
					continue;
				 }

                 while (1) {
                    if (fgets(dummy, 409600, OLDPtr) == (char *) NULL) break;

			        sprintf(dummy, "%s", rep_char(dummy,"\r\n",""));
			        sprintf(dummy, "%s", rep_char(dummy,"\r",""));
			        sprintf(dummy, "%s", rep_char(dummy,"\n",""));

                    CurrCnt++;
                    if (CurrCnt < Line1)
                       fprintf(RstPtr, "  %s\r\n", dummy);
                    else if (CurrCnt == Line2) {
                       fprintf(RstPtr, "  %s\r\n", dummy);

                       for (i = Line3; i <= Line4; i++) {
                       	   fprintf(RstPtr, "  \r\n");
                       }
                    }

                    if (CurrCnt == Line2) break;
                 }
              }


              /*-------------------------------------------------*/
              /*    Change Line 작성                             */
              /*-------------------------------------------------*/
              else if (memcmp(DiffCmd, "c", 1) == 0) {
                 while (1) {
                    if (fgets(dummy, 409600, OLDPtr) == (char *) NULL) break;

			        sprintf(dummy, "%s", rep_char(dummy,"\r\n",""));
			        sprintf(dummy, "%s", rep_char(dummy,"\r",""));
			        sprintf(dummy, "%s", rep_char(dummy,"\n",""));

                    CurrCnt++;
                    if (CurrCnt < Line1)
                       fprintf(RstPtr, "  %s\r\n", dummy);
                    else if (CurrCnt <= Line2) {
                       fprintf(RstPtr, "RO%s\r\n", dummy);
                    }

                    if (CurrCnt == Line2) {
                       if (Line4-Line3 > Line2-Line1) {
                          for (i = 1; i <= (Line4-Line3) - (Line2-Line1); i++) {
                       	      fprintf(RstPtr, "  \r\n");
                          }
                       }
                       break;
                    }
                 }
              }
           }

           /*----------------------------------------------------*/
    	   /*    변경후 파일 작성                                */
           /*----------------------------------------------------*/
           else {
              /*-------------------------------------------------*/
              /*    Insert Line 작성                             */
              /*-------------------------------------------------*/
              if (memcmp(DiffCmd, "a", 1) == 0) {
                 while (1) {
                    if (fgets(dummy, 409600, OLDPtr) == (char *) NULL) break;

			        sprintf(dummy, "%s", rep_char(dummy,"\r\n",""));
			        sprintf(dummy, "%s", rep_char(dummy,"\r",""));
			        sprintf(dummy, "%s", rep_char(dummy,"\n",""));

                    CurrCnt++;
                    if (CurrCnt < Line3)
                       fprintf(RstPtr, "  %s\r\n", dummy);
                    else if (CurrCnt <= Line4)
                       fprintf(RstPtr, "I %s\r\n", dummy);

                    if (CurrCnt == Line4) break;
                 }
              }

              /*-------------------------------------------------*/
    	      /*    Delete Line 작성                             */
              /*-------------------------------------------------*/
              else if (memcmp(DiffCmd, "d", 1) == 0) {
                 while (1) {
                    if (CurrCnt < Line3) {
                       	if (fgets(dummy, 409600, OLDPtr) == (char *) NULL) break;

				        sprintf(dummy, "%s", rep_char(dummy,"\r\n",""));
				        sprintf(dummy, "%s", rep_char(dummy,"\r",""));
				        sprintf(dummy, "%s", rep_char(dummy,"\n",""));


						CurrCnt++;
						fprintf(RstPtr, "  %s\r\n", dummy);
                    }

                    else if (CurrCnt == Line3) {
                       for (i = Line1; i <= Line2; i++) {
                       	   fprintf(RstPtr, "D \r\n");
                       }

                       break;
                    }
                 }
              }


              /*-------------------------------------------------*/
              /*    Change Line 작성                             */
              /*-------------------------------------------------*/
              else if (memcmp(DiffCmd, "c", 1) == 0) {
                 while (1) {
					if (fgets(dummy, 409600, OLDPtr) == (char *) NULL) break;

			        sprintf(dummy, "%s", rep_char(dummy,"\r\n",""));
			        sprintf(dummy, "%s", rep_char(dummy,"\r",""));
			        sprintf(dummy, "%s", rep_char(dummy,"\n",""));


                    CurrCnt++;
                    if (CurrCnt < Line3)
                       fprintf(RstPtr, "  %s\r\n", dummy);
                    else if (CurrCnt <= Line4) {
						if (CurrCnt <= (Line2 - Line1 + Line3))
                       		fprintf(RstPtr, "RN%s\r\n", dummy);
                       	else
                       		fprintf(RstPtr, "I %s\r\n", dummy);
                    }

                    if (CurrCnt == Line4) {
                       if (Line2-Line1 > Line4-Line3) {
                          for (i = 1; i <= (Line2-Line1) - (Line4-Line3); i++) {
                       	      fprintf(RstPtr, "RN\r\n");
                          }
                       }
                       break;
                    }
                 }
              }
           }
       }
    }

	while (1) {
       	if (fgets(dummy, 409600, OLDPtr) == (char *) NULL) break;

        sprintf(dummy, "%s", rep_char(dummy,"\r\n",""));
        sprintf(dummy, "%s", rep_char(dummy,"\r",""));
        sprintf(dummy, "%s", rep_char(dummy,"\n",""));

		CurrCnt++;
		fprintf(RstPtr, "  %s \r\n", dummy);
	}
    fclose (DiffPtr);
    fclose (OLDPtr);
    fclose (RstPtr);

    return 1;
}


/*---------------------------------------------------------------*/
/*	Function  : MakeFileWithVer                                  */
/*	Function  : 버전파일 작성                                    */
/*	Parameter : pItemCD : 프로그램등록번호                       */
/*              pLocal  : 로컬파일명                             */
/*              gVer    : 작성버전                               */
/*	Return    : NONE                                             */
/*---------------------------------------------------------------*/
void	MakeFileWithVer	( char *pItemCD
						, char *pLocal
						, char *gVer
)
{
int 	i                               ;
int 	nVersion                        ;
char 	gDVServerIP                 [20];
char 	SvrPath                  [dfDir];
char 	Dev_ProgPath             [dfDir];
int  	dfSendPort                      ;
char 	szSysCD                [dfSysCD];
char 	szRsrcCD              [dfRsrcCD];
char 	szStatus                     [2];
char 	gRsrcName           [dfPhysName];
int	 	szSvrSeq                        ;
char 	iconvFileName       [dfFullPath];
char 	szOzRsrc              [dfRsrcCD];
int  	mRet                            ;
int  	nNewVer                         ;

CMD_INFO	CmdInfo                     ;


    /*-----------------------------------------------------------*/
    /*   소켓 STRUCTURE 초기화                                   */
    /*-----------------------------------------------------------*/
	InitCmdInfo(&CmdInfo);

	memset(szOzRsrc, 0x00, sizeof(szOzRsrc));
	memset(szStatus, 0x00, sizeof(szStatus));

    /*-----------------------------------------------------------*/
    /*   자원정보 조회                                           */
    /*-----------------------------------------------------------*/
	EXEC SQL
		SELECT  CR_RSRCCD
		      , CR_LSTVER
		      , CR_STATUS
		  INTO  :szOzRsrc
		  	  , :nNewVer
		  	  , :szStatus
		  FROM  CMR0020
		 WHERE  CR_ITEMID = :pItemCD;

	if (sqlca.sqlcode != 0) {
		memset(szOzRsrc, 0x00, sizeof(szOzRsrc));
	}

	NotUseDataTruncate(szOzRsrc, 0x20);
	NotUseDataTruncate(szStatus, 0x20);

	/*-----------------------------------------------------------*/
	/*	버젼에 접수번호가 들어왔을 경우 체크인 중인 파일과 비교  */
	/*-----------------------------------------------------------*/
	if (strlen(gVer) > 5) {
		if (strcmp(szStatus,"0") != 0 && strcmp(szStatus,"5") != 0) {
			sprintf(SysCmd,"FileRead_cmr0027 '%s' '%s' '%s'",gVer, pItemCD, pLocal);
			system(SysCmd);
			
			File_Encoding(pLocal);
			return ;
		}
		else {
			gVer = "NEW";
		}
	}

    /*-----------------------------------------------------------*/
	/*   개발서버에서 가져와 비교                                */
    /*-----------------------------------------------------------*/
	if (strcmp(gVer, "T") == 0) {
		EXEC SQL
			SELECT  DISTINCT
			        A.CM_SVRIP
			      , A.CM_PORTNO
			      , A.CM_SEQNO
			      , C.CR_RSRCCD
			      , C.CR_SYSCD
			      , C.CR_RSRCNAME
			      , D.CM_DIRPATH
			  INTO	:gDVServerIP
			  	  , :dfSendPort
			  	  , :szSvrSeq
			  	  , :szRsrcCD
			  	  , :szSysCD
			  	  , :gRsrcName
			  	  , :SvrPath
			  FROM  CMM0031 A
			      , CMM0038 B
			      , CMR0020 C
			      , CMM0070 D
			 WHERE  C.CR_ITEMID = :pItemCD
			   AND  A.CM_SVRCD  = '01'
			   AND  C.CR_SYSCD  = A.CM_SYSCD
			   AND  C.CR_RSRCCD = B.CM_RSRCCD
			   AND  A.CM_SYSCD  = B.CM_SYSCD
			   AND  A.CM_SVRCD  = B.CM_SVRCD
			   AND  A.CM_SEQNO  = B.CM_SEQNO
			   AND  C.CR_SYSCD  = D.CM_SYSCD
			   AND  C.CR_DSNCD  = D.CM_DSNCD;

	    if (sqlca.sqlcode != 0) {
		    printf("SQLErrCheck 3: TEST Server 정보 오류 [%s] 01 [%d] [%s]\n", pItemCD, sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
		    exit (4);
	    }

	    NotUseDataTruncate(gDVServerIP, 0x20);
	    NotUseDataTruncate(szRsrcCD   , 0x20);
	    NotUseDataTruncate(szSysCD    , 0x20);
	    NotUseDataTruncate(SvrPath    , 0x20);
	    NotUseDataTruncate(gRsrcName  , 0x20);

		/*-------------------------------------------------------*/
		/*	소켓 버퍼사이즈 SET                                  */
		/*-------------------------------------------------------*/
		if (Server_Buff_Size(szSysCD, "01", szSvrSeq) == FALSE) {
			printf("serverinfo(Buffer Size) Get Err [%s][%d]", szSysCD, szSvrSeq);
			return;
		}
	

	    ChangeVolPath(szSysCD , "01", szRsrcCD, szSvrSeq, SvrPath, Dev_ProgPath);

	    sprintf(CmdInfo.szJobGub, "G");
		sprintf(CmdInfo.szServerIP, "%s" , gDVServerIP);
		CmdInfo.nPort = dfSendPort;
		sprintf(CmdInfo.szRemote , "%s/%s" , Dev_ProgPath, gRsrcName);
		sprintf(CmdInfo.szLocal  , "%s" , pLocal);
	  	Server_Cmd_JOB(&CmdInfo);
		/*LookCMD_INFO(&CmdInfo);*/
		
		File_Encoding(pLocal);
		return;
	}
	
	/*-----------------------------------------------------------*/
	/*   로컬파일을 형상관리에 저장(이클립스에서 저장) 후 비교   */
    /*-----------------------------------------------------------*/
	if (strcmp(gVer, "D") == 0) {
		printf("local file name [%s][%s]\n", devFile,pLocal);
		sprintf(SysCmd,"cp '%s' '%s' ",devFile,pLocal);
		mRet = system(SysCmd)/256;
		if (mRet == 0) {
			File_Encoding(pLocal);
		}
		else {
			remove(pLocal);
		}
		
		return;
	}
  	if (strcmp(gVer,"NEW") == 0)
    	nVersion = nNewVer;
	else
		nVersion = atoi(gVer);

	if (nVersion == 0) {
		sprintf(SysCmd, "touch %s", pLocal);
		system (SysCmd);
		return;
	}
	
	sprintf(SysCmd,"FileRead_cmr0025 '%s' '%s' '%d'",pItemCD,pLocal,nVersion);
	system(SysCmd);

	File_Encoding(pLocal);
}



/*****************************************************************/
/*                                                               */
/*       File  Compare    처리  M A I N                          */
/*                                                               */
/*   Parameter  :                                                */
/*      1. BackUp Directory                                      */
/*      2. OLD Sorc Name                                         */
/*      3. NEW Sorc Name                                         */
/*      4. UserID                                                */
/*      5. 개발서버 주소                                         */
/*      6. 개발서버 파일위치                                     */
/*****************************************************************/
int  main(int argc, char **argv, char **envp)
{

char	DiffFile            [dfFullPath]; /* diff 결과 파일      */
char	RstOLDFile          [dfFullPath]; /* 변경전파일          */
char	RstNEWFile          [dfFullPath]; /* 변경후파일          */
char	DiffSorc1           [dfFullPath]; /* 변경전파일          */
char	DiffSorc2           [dfFullPath]; /* 변경후파일          */
char	sysgb	                     [3]; /* 시스템 구분         */
char	sSysUp                       [3]; /* 시스템 OS 구분      */
char	sDown                        [3]; /* DOWN 여부           */
char	tmpDir                   [dfDir];

    if (argc < 6) {
		printf ("usage : %s <ITEMID1> <BEF_VER> <ITEMID2> <AFT_VER> <OUTFILE>\n", argv[0]);
        exit (1);
    }

	#if defined(__linux__)
		setenv("MALLOC_CHECK_", "0", 1);
	#endif

    memset(SysCmd    , 0x00, sizeof(SysCmd    ));
    memset(DiffFile  , 0x00, sizeof(DiffFile  ));
    memset(RstOLDFile, 0x00, sizeof(RstOLDFile));
    memset(RstNEWFile, 0x00, sizeof(RstNEWFile));
    memset(DiffSorc1 , 0x00, sizeof(DiffSorc1 ));
    memset(DiffSorc2 , 0x00, sizeof(DiffSorc2 ));
    memset(devFile   , 0x00, sizeof(devFile   ));

    /*-----------------------------------------------------------*/
    /*   eCAMS  DB Server  Connect                               */
    /*-----------------------------------------------------------*/
	if (ConnectDB() == FALSE)
		exit(2);


    /*-----------------------------------------------------------*/
    /*   Temp 디렉토리명 조회                                    */
    /*-----------------------------------------------------------*/
    SetTempDir("99", tmpDir);

    sprintf(RstOLDFile, "%s/%s.1", tmpDir, argv[5]);
    sprintf(RstNEWFile, "%s/%s.2", tmpDir, argv[5]);
    remove (RstOLDFile);
    remove (RstNEWFile);

    /*-----------------------------------------------------------*/
    /*   로컬파일명 조립                                         */
    /*-----------------------------------------------------------*/
	sprintf(DiffSorc1, "%s/%s_old", tmpDir, argv[5]);
	sprintf(DiffSorc2, "%s/%s_new", tmpDir, argv[5]);
	sprintf(devFile, "%s/%s", tmpDir, argv[3]);
	sprintf(DiffFile, "%s/%s", tmpDir, argv[5]);

    /*-----------------------------------------------------------*/
    /*   버전파일 작성                                           */
    /*-----------------------------------------------------------*/
	MakeFileWithVer(argv[1], DiffSorc1 , argv[2]);
	sprintf(SysCmd, "ecams_fileconv %s 1", DiffSorc1);
	system (SysCmd);

	MakeFileWithVer(argv[3], DiffSorc2 , argv[4]);
	sprintf(SysCmd, "ecams_fileconv %s 1", DiffSorc2);
	system (SysCmd);

    /*-----------------------------------------------------------*/
    /*     OLD File VS New File 비교실행                         */
    /*-----------------------------------------------------------*/
    sprintf(SysCmd, "diff %s %s > %s", DiffSorc1, DiffSorc2, DiffFile);
    system(SysCmd);
    
    sprintf(SysCmd, "chmod 777 %s", DiffFile);
		system (SysCmd);

    /*-----------------------------------------------------------*/
    /*     OLD File 작성                                         */
    /*-----------------------------------------------------------*/
    Make_DiffFile (DiffSorc1, DiffFile, RstOLDFile, 1);  
    
    sprintf(SysCmd, "chmod 777 %s", RstOLDFile);
		system (SysCmd);
    /*-----------------------------------------------------------*/
    /*     NEW File 작성                                         */
    /*-----------------------------------------------------------*/
	if (Make_DiffFile (DiffSorc2, DiffFile, RstNEWFile, 2) < 0) {
       exit (3);
    }
    sprintf(SysCmd, "chmod 777 %s", RstNEWFile);
		system (SysCmd);

    remove (DiffFile);
    remove (DiffSorc1);
    remove (DiffSorc2);

    exit (0);
}



/*---------------------------------------------------------------*/
/*             E N D    O F    P R O G R A M                     */
/*---------------------------------------------------------------*/
