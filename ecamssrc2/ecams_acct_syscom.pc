/*-----------------------------------------------------------------
 ┌──────┬───────────────────────┐
 │ 프로그램명 │ ecams_acct_syscom.pc                         │
 ├──────┼───────────────────────┤
 │ 기      능 │ CheckIn 처리 공통                            │
 ├──────┼───────────────────────┤
 │ 작  성  일 │ 2011. 07. 11                                 │
 ├──────┼───────────────────────┤
 │ 작  성  자 │ 최   병   남                                 │
 └──────┴───────────────────────┘
-----------------------------------------------------------------*/

/*---------------------------------------------------------------*/
/*     Header files                                              */
/*---------------------------------------------------------------*/
#include <ecams_util.h>
#include <ecamsapi.h>

EXEC SQL INCLUDE "ecams_acct.h";



/*---------------------------------------------------------------*/
/*       INTERNAL  FUNCTION  DEFINE                              */
/*---------------------------------------------------------------*/
int 	DeclareSyscomRsrcCursor	(char *pAcptNo, char *pPrcSys);
int 	RunSyscomRsrcScript		(char *pAcptNo, char *pPrcSys, char *pRstCond);
int 	UploadSyscomRsrc		(char *pAcptNo, char *pPrcSys, char *pRstCond);


/*---------------------------------------------------------------*/
/*    User Work 변수                                             */
/*---------------------------------------------------------------*/
#define DEBUG 	1
char	gSpoolGB                     [2];



/*---------------------------------------------------------------*/
/*	Function  : DeclareSyscomRsrcCursor                          */
/*	Action    : 컴파일/배포 대상 목록 작성                       */
/*	Parameter :	pAcptNo   : 신청번호                             */
/*	            pPrcSys   : 처리단계                             */
/*	Return    : 0 : 정상, 1 : 처리대상없슴                       */
/*---------------------------------------------------------------*/
int 	DeclareSyscomRsrcCursor	( char *pAcptNo
								, char *pPrcSys
								)
{
char	szSysCD                [dfSysCD];
char	szDsnCD                [dfDsnCD];
char	szRsrcName          [dfRsrcName];
char	szRsrcCD              [dfRsrcCD];
int		szVersion                       ;
int		szBefVer                        ;
char	szEditor              [dfEditor];
int		szSerNo                         ;
char	szSrcChg                   [1+1];
int		szPri                           ;
char	szAplyDate                [14+1];
char	szItemID              [dfItemID];
char	szReqCD                [dfReqCD];
char	szBaseItem            [dfItemID];
char	szConfNo              [dfAcptNo];
char	szQryCD                [dfReqCD];
char	szSysGB                    [1+1];
char	szSvrIP                [dfSvrIP];
int		szPortNo                        ;
char	szSvrCD                [dfSvrCD];
char	szSvrName              [dfSvrNM];
char	szDir                    [dfDir];
char	szVolPath                [dfDir];
char	szSysOS                [dfSysOS];
int		szSvrSeq                        ;
char	szInfo                  [dfInfo];
char	szDirPath                [dfDir];
char	szJobCD                [dfJobCD];
char	szSvrInfo            [dfSvrInfo];
int 	checkCnt                        ;
int 	tag                             ;
int		szSysStep                       ;


	EXEC SQL DECLARE SYSCOM_Rsrc1 CURSOR FOR
		SELECT  DISTINCT
		        A.CR_SYSCD
		      , A.CR_DSNCD
		      , A.CR_RSRCCD
		      , A.CR_RSRCNAME
		      , A.CR_JOBCD
		      , A.CR_VERSION
		      , A.CR_BEFVER
		      , A.CR_EDITOR
		      , A.CR_SERNO
		      , A.CR_PRIORITY
		      , A.CR_SRCCHG
		      , NVL(A.CR_APLYDATE,'0')
		      , A.CR_ITEMID
		      , A.CR_QRYCD
		      , A.CR_CONFNO
		      , A.CR_BASEITEM
		      , B.CR_QRYCD
		      , B.CR_SYSGB
		      , C.CM_SVRIP
		      , C.CM_PORTNO
		      , C.CM_SVRCD
		      , C.CM_SVRNAME
		      , C.CM_DIR
		      , C.CM_VOLPATH
		      , C.CM_SYSOS
		      , C.CM_SEQNO
		      , C.CM_SVRUSE
		      , D.CM_INFO
		      , F.CM_DIRPATH
		  FROM  CMR1000 B
		      , CMR1010 A
		      , CMM0031 C
		      , CMM0036 D
		      , CMM0038 E
		      , CMM0070 F
		 WHERE  A.CR_ACPTNO = :pAcptNo
		   AND  NVL(A.CR_SYSSTEP,0) = :szSysStep
		   AND  A.CR_PRCDATE IS NULL
		   AND  B.CR_ACPTNO = A.CR_ACPTNO
		   AND  A.CR_SYSCD  = C.CM_SYSCD
		   AND  (    (     B.CR_QRYCD  = '04' 
		              AND  INSTR(DECODE(:pPrcSys, 'SYSTCB', '13'
		                     	                          , '03,55'
		                   	           ), C.CM_SVRCD
		                   	    ) > 0
		   	         )
		         OR  (     B.CR_QRYCD IN ('03','16') 
		              AND  C.CM_SVRCD  IN ('13','53')
		             )
		         OR  (     B.CR_QRYCD  = '06' 
		              AND  INSTR(DECODE(:pPrcSys, 'SYSTCB', '13'
		                   	                              , '03,55'
		                   	           ), C.CM_SVRCD
		                   	    ) > 0
		   	         )
		        )
		   AND  C.CM_CLOSEDT    IS NULL
		   AND  C.CM_SVRSTOP = 'N'
		   AND  D.CM_CLOSEDT    IS NULL
		   AND  A.CR_SYSCD  = D.CM_SYSCD
		   AND  A.CR_RSRCCD = D.CM_RSRCCD
		   AND  SUBSTR(D.CM_INFO,13,1) = '1'
		   AND  A.CR_SYSCD  = E.CM_SYSCD
		   AND  A.CR_RSRCCD = E.CM_RSRCCD
		   AND  C.CM_SVRCD  = E.CM_SVRCD
		   AND  C.CM_SEQNO  = E.CM_SEQNO
		   AND  A.CR_SYSCD  = F.CM_SYSCD
		   AND  A.CR_DSNCD  = F.CM_DSNCD
		   AND  (    A.CR_PID IS NULL
		         OR  NVL(A.CR_PUTCODE,'RTRY') = 'RTRY'
		        );

	szSysStep = 0;
	checkCnt  = 0;
	tag	= 0;
	EXEC SQL open  SYSCOM_Rsrc1;
    while (1) {
		EXEC SQL fetch SYSCOM_Rsrc1
			INTO  :szSysCD
			    , :szDsnCD
			    , :szRsrcCD
			    , :szRsrcName
			    , :szJobCD
			    , :szVersion
			    , :szBefVer
			    , :szEditor
			    , :szSerNo
			    , :szPri
			    , :szSrcChg
			    , :szAplyDate
			    , :szItemID
			    , :szReqCD
			    , :szConfNo
			    , :szBaseItem
			    , :szQryCD
			    , :szSysGB
			    , :szSvrIP
			    , :szPortNo
			    , :szSvrCD
			    , :szSvrName
			    , :szDir
			    , :szVolPath
			    , :szSysOS
			    , :szSvrSeq
			    , :szSvrInfo
			    , :szInfo
			    , :szDirPath;

		if (checkCnt == 0 && sqlca.sqlcode == 1403) {
			checkCnt++ ;
			tag = 0 ;
			break;
		}
		else {
			tag = 1 ;
			break;
		}
	}
	EXEC SQL close SYSCOM_Rsrc1;

	return (tag);

}


/*---------------------------------------------------------------*/
/*	Function  : Process_SYSCOM                                   */
/*	Action    : 컴파일/배포 처리                                 */
/*	Parameter :	pAcptNo   : 신청번호                             */
/*	            pPrcSys   : 처리단계                             */
/*	            pRstCond  : 처리결과                             */
/*	Return    : NONE                                             */
/*---------------------------------------------------------------*/
void	Process_SYSCOM	( char *pAcptNo
						, char *pPrcSys
						, char *pRstCond
						)
{
int		errRtCode                       ;


	sprintf(gSpoolGB, "%s", "1");
	memset(pRstCond, 0x00, sizeof(pRstCond));

	/*LOG*/sprintf(gszLogMsg,"[%s]<%s>처리시작",pAcptNo,pPrcSys);
	eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);

	/*-----------------------------------------------------------*/
	/*	SYSCOM 작업에 필요한 자원 정보 조회 쿼리 선언	         */
	/*-----------------------------------------------------------*/
	/*LOG*/sprintf(gszLogMsg,"[%s][%s] DeclareSyscomRsrcCursor Start",pAcptNo, pPrcSys);
	eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);

	errRtCode = 0;
	errRtCode = DeclareSyscomRsrcCursor(pAcptNo, pPrcSys);

	/*LOG*/sprintf(gszLogMsg,"[%s][%s] DeclareSyscomRsrcCursor returned[%d]",pAcptNo, pPrcSys,errRtCode);
	eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);

	#if 0
	if (errRtCode == 0 ) {
		strcpy(pRstCond, "9999");
		return ;
	}
	#endif
	

	/*-----------------------------------------------------------*/
	/*   신청 자원을 생성하여 대상 Server에 Upload 하고 오류가   */
	/*   있을 경우 오류건수를 리턴                               */
	/*-----------------------------------------------------------*/
	/*LOG*/sprintf(gszLogMsg,"[%s][%s] UploadSyscomRsrc  start", pAcptNo, pPrcSys);
	eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);

	errRtCode = 0;
	errRtCode = UploadSyscomRsrc(pAcptNo,pPrcSys,pRstCond );

	/*LOG*/sprintf(gszLogMsg,"[%s][%s] UploadSyscomRsrc returned [%s][%d]",pAcptNo, pPrcSys,pRstCond,errRtCode);
	eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);

	if (errRtCode != 0 ) {
		strcpy(pRstCond, "EROR");
		return ;
	}

	/*-----------------------------------------------------------*/
	/* 대상 서버에 올라간 자원에 대한 script 실행	  	         */
	/*-----------------------------------------------------------*/
	/*LOG*/sprintf(gszLogMsg,"[%s][%s] RunSyscomRsrcScript  start",pAcptNo, pPrcSys);
	eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);

	errRtCode = 0;
	errRtCode = RunSyscomRsrcScript(pAcptNo,pPrcSys,pRstCond);

	/*LOG*/sprintf(gszLogMsg,"[%s][%s] RunSyscomRsrcScript returned [%s][%d]",pAcptNo, pPrcSys,pRstCond,errRtCode);
	eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);

	if (errRtCode != 0 ) {
		strcpy(pRstCond, "EROR");
		return ;
	}

	/*LOG*/sprintf(gszLogMsg,"[%s][%s] 처리완료  [%s]",pAcptNo, pPrcSys,pRstCond);
	eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);
}



/*---------------------------------------------------------------*/
/*	Function  : UploadSyscomRsrc                                 */
/*	Action    : 신청자원 서버로 전송                             */
/*	Parameter :	pAcptNo   : 신청번호                             */
/*	            pPrcSys   : 처리단계                             */
/*	            pRstCond  : 처리결과                             */
/*	Return    : 오류건수                                         */
/*---------------------------------------------------------------*/
int 	UploadSyscomRsrc	( char *pAcptNo
							, char *pPrcSys
							, char *pRstCond
)
{
char	szSysCD                [dfSysCD];
char	szDsnCD                [dfDsnCD];
char	szRsrcName          [dfRsrcName];
char	szRsrcCD              [dfRsrcCD];
int		szVersion                       ;
int		szBefVer                        ;
char	szEditor              [dfEditor];
int		szSerNo                         ;
char	szSrcChg                   [1+1];
int		szPri                           ;
char	szAplyDate                [14+1];
char	szItemID              [dfItemID];
char	szBaseItem            [dfItemID];
char	szReqCD                [dfReqCD];
char	szConfNo              [dfAcptNo];
char	szQryCD                [dfReqCD];
char	szSysGB                    [1+1];
char	szSvrIP                [dfSvrIP];
int		szPortNo                        ;
char	szSvrCD                [dfSvrCD];
char	szSvrName              [dfSvrNM];
char	szDir                    [dfDir];
char	szVolPath                [dfDir];
char	szSysOS                [dfSysOS];
int		szSvrSeq                        ;
char	szInfo                  [dfInfo];
char	szDirPath                [dfDir];
char	szchmod                      [6];
char	szchown                     [21];
char	szchgrp                     [21];
char	szJobCD                [dfJobCD];
char	szSvrInfo            [dfSvrInfo];
char	szReqPath                [dfDir];
char	szRstFile           [dfFullPath];
char	szBKRsrcName        [dfRsrcName];
char	szChangDirPath           [dfDir];
char	szChangDirPathTmp        [dfDir];
char	szRemoteFileName    [dfFullPath];
char	szLocalFileName     [dfFullPath];
char	szBackFileName      [dfRsrcName];
char	szRemote            [dfFullPath];
char	szLocal             [dfFullPath];
char	szCommand           [dfFullPath];
char	idxFileName         [dfFullPath];
char	szFileDate                [14+1];
int		idxcnt                          ;
int		nRst                            ;
int		nPutErrCnt                      ;
int		szSysStep                       ;
struct 	stat f_st                       ;
long	lFileSize                       ;
int		nRet                            ;
CMD_INFO	  CmdInfo                   ;


	memset(szReqPath, 0x00, sizeof(szReqPath));

	/*-----------------------------------------------------------*/
	/*	파일 생성시 파일이 저장될 경로 설정및 생성               */
	/*-----------------------------------------------------------*/
	SetTempDir("77",szReqPath);
	strcat(szReqPath,pAcptNo);
	if (access(szReqPath,F_OK) != 0)
		Local_Dir_Make(szReqPath);

	/*-----------------------------------------------------------*/
	/*	소켓 명령 변수 초기화                                    */
	/*-----------------------------------------------------------*/
	InitCmdInfo(&CmdInfo);
	strcpy(CmdInfo.szAcptNo,pAcptNo);
	sprintf(CmdInfo.szLogFile,"%sTransList.%s",gszLogPath,gszLogFile);

	/*-----------------------------------------------------------*/
	/*	Tar Index 파일 생성 초기화                               */
	/*-----------------------------------------------------------*/
	tar_index_init(pAcptNo,szReqPath);
	idxcnt = 0 ;
	szSysStep = 0;

	EXEC SQL open  SYSCOM_Rsrc1;
    while (1) {
		EXEC SQL FETCH  SYSCOM_Rsrc1
			INTO  :szSysCD
			    , :szDsnCD
			    , :szRsrcCD
			    , :szRsrcName
			    , :szJobCD
			    , :szVersion
			    , :szBefVer
			    , :szEditor
			    , :szSerNo
			    , :szPri
			    , :szSrcChg
			    , :szAplyDate
			    , :szItemID
			    , :szReqCD
			    , :szConfNo
			    , :szBaseItem
			    , :szQryCD
			    , :szSysGB
			    , :szSvrIP
			    , :szPortNo
			    , :szSvrCD
			    , :szSvrName
			    , :szDir
			    , :szVolPath
			    , :szSysOS
			    , :szSvrSeq
			    , :szSvrInfo
			    , :szInfo
			    , :szDirPath;

		if (sqlca.sqlcode == 1403)	break;
		if (sqlca.sqlcode != 0 && sqlca.sqlcode != -1405) {
			sprintf(gszLogMsg,"UploadSyscomRsrc DB FETCH ERROR : [%s] [%d] [%d] [%s]", pAcptNo, szSerNo, sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
			eCAMS_Log(gszLogPath, gszLogFile, gszLogMsg);
			break;
		}

		NotUseDataTruncate (szSysCD   ,	0x20);
		NotUseDataTruncate (szDsnCD   ,	0x20);
		NotUseDataTruncate (szRsrcCD  ,	0x20);
		NotUseDataTruncate (szJobCD   ,	0x20);
		NotUseDataTruncate (szEditor  ,	0x20);
		NotUseDataTruncate (szSrcChg  ,	0x20);
		NotUseDataTruncate (szAplyDate,	0x20);
		NotUseDataTruncate (szItemID  ,	0x20);
		NotUseDataTruncate (szReqCD   ,	0x20);
		NotUseDataTruncate (szConfNo  ,	0x20);
		NotUseDataTruncate (szBaseItem,	0x20);
		NotUseDataTruncate (szQryCD   ,	0x20);
		NotUseDataTruncate (szSysGB   ,	0x20);
		NotUseDataTruncate (szSvrIP   ,	0x20);
		NotUseDataTruncate (szSvrCD   ,	0x20);
		NotUseDataTruncate (szSvrName ,	0x20);
		NotUseDataTruncate (szDir     ,	0x20);
		NotUseDataTruncate (szVolPath ,	0x20);
		NotUseDataTruncate (szSysOS   ,	0x20);
		NotUseDataTruncate (szInfo    ,	0x20);
		NotUseDataTruncate (szSvrInfo ,	0x20);

		sprintf(szRsrcName, "%s", trunc_char(szRsrcName));
		sprintf(szDirPath , "%s", trunc_char(szDirPath ));

		strcpy(szBKRsrcName, szRsrcName);
		ChangeVolPath_NEW(pAcptNo, szSysCD , szSvrCD, szRsrcCD, szSvrSeq, szDirPath, szChangDirPathTmp);

		/*-------------------------------------------------------*/
		/*	임시영역 컴파일                                      */
		/*-------------------------------------------------------*/
		if (cmp_mid_char(szInfo,19,1, "1") == 0) {
			EXEC SQL
				SELECT  CM_VOLPATH
				  INTO  :szChangDirPath
				  FROM  CMM0038
				 WHERE  CM_SysCD  = :szSysCD
				   AND  CM_SEQNO  = :szSvrSeq
				   AND  CM_SvrCD  = :szSvrCD
				   AND  CM_RsrcCD = :szRsrcCD;

			if (sqlca.sqlcode != 0) {
				sprintf(gszLogMsg, "SQLErrCheck 2: REAL Server 정보 오류 syscd[%s]rsrccd[%s]svrcd[%s]szSeqNo[%d] [%d] [%s]", szSysCD,szRsrcCD,szSvrCD,szSvrSeq,sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
				eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);
				exit (1);
			}
			NotUseDataTruncate (szChangDirPath, 0x20);
			sprintf(szChangDirPathTmp, "%s/%s/%s", szChangDirPath,pAcptNo, right_char(szChangDirPathTmp, strlen(szChangDirPathTmp) - strlen(szChangDirPath)));
			
			sprintf(CmdInfo.szJobGub, "I");
			if (strcmp(szSysOS, dfWINDOWS) == 0) {
				sprintf(CmdInfo.szCommand, "%s\\%s", szChangDirPath, pAcptNo);
			}
			else {
				sprintf(CmdInfo.szCommand, "%s/%s", szChangDirPath, pAcptNo);
			}
			Server_Cmd_JOB(&CmdInfo);

			if (strcmp(CmdInfo.szRstCond, "0000") == 0) {
				sprintf(CmdInfo.szJobGub, "S");
				if (strcmp(szSysOS, dfWINDOWS) == 0) {
					sprintf(CmdInfo.szCommand, "DEL /F %s\\%s", szChangDirPath, pAcptNo);
				}
				else {
					sprintf(CmdInfo.szCommand, "rm -rf %s/%s", szChangDirPath, pAcptNo);
				}
				Server_Cmd_JOB(&CmdInfo);
			}
		}

		if (cmp_right_char(szChangDirPathTmp, 1, "/") == 0) {
			sprintf(szChangDirPathTmp, "%s", left_char(szChangDirPathTmp, strlen(szChangDirPathTmp) - 1));
		}

		/*-------------------------------------------------------*/
		/*	OS종류별 디렉토리명 변환                             */
		/*-------------------------------------------------------*/
		Convert_WinDirPath (szSysOS, szChangDirPathTmp, szChangDirPath);

		/*-------------------------------------------------------*/
		/*	결과파일명                                           */
		/*-------------------------------------------------------*/
		sprintf(szRstFile,"%s/%s.%d.%s.%d.result", gszTempPath, pAcptNo, szSerNo,szSvrIP,szSvrSeq);

		/*-------------------------------------------------------*/
		/*	개발서버에 파일저장 경로+파일명                      */
		/*-------------------------------------------------------*/
		strcpy(szRemoteFileName,szRsrcName);

		sprintf(szLocalFileName,"%s.%s.%d",szRsrcName, pAcptNo, szSerNo);
		memset(szBackFileName, 0x00, sizeof(szBackFileName));
		sprintf(szLocal,"%s/%s",szReqPath,szLocalFileName);

		if ( (strcmp(szReqCD ,"09") == 0        &&
			  cmp_mid_char(szInfo,32,1,"1") != 0)  ||
			 (strncmp(szReqCD,"05",2) == 0) ) {
			/*LOG*/sprintf(gszLogMsg,"[%s][%d][SYSCB]ECAMS_ACCT1 무수정/폐기/배포안함 : 자원생성 SKIP [%s]\n", pAcptNo,szSerNo,szRsrcName);
	    	eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);

			strcpy(pRstCond,"0000");
			Result_Make(szRstFile,"폐기 작업-자원생성 처리안함",szSvrIP,"SYSCB",pRstCond);
			CMR1011_Make (szSysCD, szSvrIP, pAcptNo, szSerNo, szRstFile, 0, pRstCond, szSvrName, "SYSCB",szSvrCD,szSvrSeq);
			continue;
		}

		if (access(szLocal,F_OK) != 0) {
			if (strcmp(szReqCD,"09") == 0 && cmp_mid_char(szInfo,32,1,"1") == 0) {
				sprintf(szCommand, "procck FileRead_cmr0025");
				while (1) {
					nRst = system(szCommand) / 256;
					if (nRst <= 20)	break;
					usleep (300000);
				}
				sprintf(szCommand,"FileRead_cmr0025 '%s' '%s' '%d'",szItemID, szLocal,szBefVer);
				nRst = system(szCommand) / 256;
				if (nRst != 0) {
					/*LOG*/sprintf(gszLogMsg,"[%s][%d] SYSCB 무수정파일 생성 실패 FileRead_cmr0025 [%s]",pAcptNo,szSerNo,szCommand);
					eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);
					strcpy(pRstCond,"FMER");
					Result_Make(szRstFile,"SYSCB 무수정파일 생성 실패",szSvrIP,"SYSCB","0025");
					CMR1011_Make (szSysCD, szSvrIP, pAcptNo, szSerNo, szRstFile, szSysStep, "0025", szSvrName, "SYSCB",szSvrCD,szSvrSeq);
					continue;
				}

				stat(szLocal, &f_st);
				lFileSize = f_st.st_size;

				/*LOG*/sprintf(gszLogMsg,"[%s][%d][SYSCB] ECAMS_ACCT1	Server로 전송할 파일 생성[%s] 사이즈[%ld]",pAcptNo,szSerNo,szLocal,lFileSize);
				eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);		
			}
			else {
				sprintf(szCommand, "procck FileRead_cmr0027");
				while (1) {
					nRst = system(szCommand) / 256;
					if (nRst <= 20)	break;
					usleep (300000);
				}

				sprintf(szCommand,"FileRead_cmr0027 '%s' '%s' '%s' ",pAcptNo, szItemID ,szLocal);
				nRst = system(szCommand) / 256;
				if (nRst != 0) {
					/*LOG*/sprintf(gszLogMsg,"[%s][%d]ECAMS_ACCT1 Server로 전송할 파일 생성 실패 FileRead_cmr0027 [%s]",pAcptNo,szSerNo,szCommand);
					eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);

					strcpy(pRstCond,"FMER");
					Result_Make(szRstFile,"Server로 전송할 파일 생성 실패",szSvrIP,"SYSCB",pRstCond);
					CMR1011_Make (szSysCD, szSvrIP, pAcptNo, szSerNo, szRstFile, 0, pRstCond, szSvrName, "SYSCB",szSvrCD,szSvrSeq);
					continue;
				}

				stat(szLocal, &f_st);
				lFileSize = f_st.st_size;

				/*LOG*/sprintf(gszLogMsg,"[%s][%d][SYSCB] ECAMS_ACCT1	Server로 전송할 파일 생성[%s] 사이즈[%ld]",pAcptNo,szSerNo,szLocal,lFileSize);
				eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);		
			}
		}
		else {
			stat(szLocal, &f_st);
			lFileSize = f_st.st_size;

			if (lFileSize <= 0) {
				if (strcmp(szReqCD,"09") == 0 && cmp_mid_char(szInfo,32,1,"1") == 0) {
					sprintf(szCommand, "procck FileRead_cmr0025");
					while (1) {
						nRst = system(szCommand) / 256;
						if (nRst <= 20)	break;
						usleep (300000);
					}
					sprintf(szCommand,"FileRead_cmr0025 '%s' '%s' '%d'",szItemID, szLocal,szBefVer);
					nRst = system(szCommand) / 256;
					if (nRst != 0) {
						/*LOG*/sprintf(gszLogMsg,"[%s][%d] SYSCB 무수정파일 생성 실패 FileRead_cmr0025 [%s]",pAcptNo,szSerNo,szCommand);
						eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);
						strcpy(pRstCond,"FMER");
						Result_Make(szRstFile,"SYSCB 무수정파일 생성 실패",szSvrIP,"SYSCB","0025");
						CMR1011_Make (szSysCD, szSvrIP, pAcptNo, szSerNo, szRstFile, szSysStep, "0025", szSvrName, "SYSCB",szSvrCD,szSvrSeq);
						continue;
					}
	
					stat(szLocal, &f_st);
					lFileSize = f_st.st_size;

					/*LOG*/sprintf(gszLogMsg,"[%s][%d][SYSCB] ECAMS_ACCT1	Server로 전송할 파일 생성[%s] 사이즈[%ld]",pAcptNo,szSerNo,szLocal,lFileSize);
					eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);		
				}
				else {
					sprintf(szCommand, "procck FileRead_cmr0027");
					while (1) {
						nRst = system(szCommand) / 256;
						if (nRst <= 20)	break;
						usleep (300000);
					}

					sprintf(szCommand,"FileRead_cmr0027 '%s' '%s' '%s' ",pAcptNo, szItemID ,szLocal);
					nRst = system(szCommand) / 256;
					if (nRst != 0) {
						/*LOG*/sprintf(gszLogMsg,"[%s][%d]ECAMS_ACCT1 Server로 전송할 파일 생성 실패 FileRead_cmr0027 [%s]",pAcptNo,szSerNo,szCommand);
						eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);

						strcpy(pRstCond,"FMER");
						Result_Make(szRstFile,"Server로 전송할 파일 생성 실패",szSvrIP,"SYSCB",pRstCond);
						CMR1011_Make (szSysCD, szSvrIP, pAcptNo, szSerNo, szRstFile, 0, pRstCond, szSvrName, "SYSCB",szSvrCD,szSvrSeq);
						continue;
					}
	
					stat(szLocal, &f_st);
					lFileSize = f_st.st_size;

					/*LOG*/sprintf(gszLogMsg,"[%s][%d][SYSCB] ECAMS_ACCT1	Server로 전송할 파일 생성[%s] 사이즈[%ld]",pAcptNo,szSerNo,szLocal,lFileSize);
					eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);		
				}
			}
		}
		stat(szLocal, &f_st);
		lFileSize = f_st.st_size;

		memset(szchmod, 0x00, sizeof(szchmod));
		memset(szchown, 0x00, sizeof(szchown));
		memset(szchgrp, 0x00, sizeof(szchgrp));

		/*-------------------------------------------------------*/
		/*	파일 소유자,그룹정보, 권한정보 조회                  */
		/*-------------------------------------------------------*/
		if (memcmp(szSvrInfo,"1",1) == 0) {
			EXEC SQL
				SELECT  a.CM_OWNER
				      , a.CM_GRPID
				      , a.CM_PERMISSION
				  INTO  :szchown
				  	  , :szchgrp
				  	  , :szchmod
				  FROM  CMM0035 a
				      , CMM0030 b
				 WHERE  a.CM_SYSCD = :szSysCD
				   AND  a.CM_SVRCD = :szSvrCD
				   AND  a.CM_SEQNO = :szSvrSeq
				   AND  a.CM_SYSCD = b.CM_SYSCD
				   AND  a.CM_JOBCD = DECODE(SUBSTR(b.CM_SYSINFO, 9, 1), '1', :szJobCD, '****');

			if (sqlca.sqlcode != 0) {
				/*LOG*/sprintf(gszLogMsg,"[%s][%d][SYSCB] 서버 정보 없음 (USER,GROUP,PERMISSION) [%s][%s][%d][%s] ",pAcptNo,szSerNo,szSysCD,szSvrCD,szSvrSeq,szJobCD);
				eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);
				strcpy(pRstCond,"SIER");

				/*-----------------------------------------------*/
				/* 자원 전송 결과 작성  	                     */
				/*-----------------------------------------------*/
				Result_Make(szRstFile,"서버 정보 없음 (USER,GROUP,PERMISSION)",szSvrIP,"SYSCB",pRstCond);
				CMR1011_Make (szSysCD, szSvrIP, pAcptNo, szSerNo, szRstFile, szSysStep, pRstCond, szSvrName, "SYSCB",szSvrCD,szSvrSeq);
				continue;
			}

			NotUseDataTruncate(szchmod, 0x20);
			NotUseDataTruncate(szchown, 0x20);
			NotUseDataTruncate(szchgrp, 0x20);
		}

		nRst = tar_index_insert_Z(pAcptNo,szReqPath,szSvrIP,szSvrSeq,szLocalFileName,szRemoteFileName,szChangDirPath,szchmod,szchown,szchgrp,"",szBackFileName);
		if (nRst != 0){
			/*LOG*/sprintf(gszLogMsg,"[%s][%d] 파일 생성 후 Tar Idx 추가 실패 szLocal [%s]",pAcptNo,szSerNo,szLocal);
			eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);

			strcpy(pRstCond,"TARE");

			Result_Make(szRstFile,"파일 생성 후 Tar Idx 추가 실패",szSvrIP,"SYSCB",pRstCond);
			CMR1011_Make (szSysCD, szSvrIP, pAcptNo, szSerNo, szRstFile, 0, pRstCond, szSvrName, "SYSCB",szSvrCD,szSvrSeq);
			continue;
		}

		idxcnt++;
		/*LOG*/sprintf(gszLogMsg,"[%s][%d][SYSCB] 파일생성 및 Tar 파일 Idx 추가 \n",pAcptNo,szSerNo);
		eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);
	}
    EXEC SQL close SYSCOM_Rsrc1;

	nPutErrCnt = 0;

	/*-----------------------------------------------------------*/
	/*	파일 전송 오류건수 조회                                  */
	/*-----------------------------------------------------------*/
	EXEC SQL
		SELECT  COUNT(a.CR_SEQNO)
		  INTO  :nPutErrCnt
		  FROM  CMR1011 a
		      , CMR1010 b
		 WHERE  a.CR_AcptNo = :pAcptNo
		   AND  b.CR_PRCDATE IS NULL
		   AND  a.CR_ACPTNO = b.CR_ACPTNO
		   AND  a.CR_SERNO  = b.CR_SERNO
		   AND  b.CR_STATUS <> '3'
		   AND  a.CR_PRCSYS = :pPrcSys
		   AND  NVL(a.CR_PUTCODE, 'N/A') != '0000';


	/*-----------------------------------------------------------*/
	/*	파일전송 결과 변경                                       */
	/*-----------------------------------------------------------*/
	EXEC SQL
		UPDATE  CMR1010
		   SET  CR_SYSSTEP = DECODE(NVL(CR_PUTCODE, '0000'), '0000', 1   , 0         )
			  , CR_PUTCODE = DECODE(NVL(CR_PUTCODE, '0000'), '0000', NULL, CR_PUTCODE)
		 WHERE  CR_ACPTNO = :pAcptNo
		   AND  CR_PRCDATE IS NULL
		   AND  NVL(CR_SYSSTEP,0) <= 0;

	if (sqlca.sqlcode != 0 && sqlca.sqlcode != 1403) {
		sprintf(gszLogMsg,"Step Update Err!!! : [%s] [%d] [%s]", pAcptNo, sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
		eCAMS_Log(gszLogPath, gszLogFile, gszLogMsg);
		strcpy(pRstCond,"EROR");
		return sqlca.sqlcode;
	}

	/*-----------------------------------------------------------*/
	/*	처리단계 변경                                            */
	/*-----------------------------------------------------------*/
	EXEC SQL EXECUTE
    	BEGIN
	        UPDATE_1000STEP(:pAcptNo,:szSysStep);
        END;
    END-EXEC;

	if (sqlca.sqlcode != 0) {
		/*LOG*/sprintf(gszLogMsg,"[%s] CMR1000 SYSSTEP UPDATE ERROR [%d] [%s]", pAcptNo,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);
		strcpy(pRstCond,"EROR");
		return sqlca.sqlcode;
	}
	EXEC SQL COMMIT;

	if (nPutErrCnt != 0) {
		strcpy(pRstCond,"EROR");
		return nPutErrCnt;
	}
	strcpy(pRstCond,"0000");
	szSysStep = 1;

	/*-----------------------------------------------------------*/
	/*	대상서버별 전송                                          */
	/*-----------------------------------------------------------*/
	if (idxcnt> 0) {
		EXEC SQL declare SYSCOM_Rsrc2 cursor for
			SELECT 	DISTINCT
			        B.CM_SYSCD
			      ,	B.CM_SVRCD
			      , B.CM_SVRNAME
			      , B.CM_SVRIP
			      , B.CM_PORTNO
			      , B.CM_DIR
			      , B.CM_SEQNO
			  FROM  CMR1010 A
			      , CMM0031 B
			      , CMM0036 C
			      , CMM0038 D
			      , CMR1000 E
			 WHERE  A.CR_ACPTNO = :pAcptNo
			   AND  A.CR_PRCDATE IS NULL
			   AND  E.CR_ACPTNO = A.CR_ACPTNO
			   AND  NVL(A.CR_SYSSTEP,0) = :szSysStep
			   AND  SUBSTR(C.CM_INFO,13,1) = '1'

		       AND  (    (     E.CR_QRYCD  = '04' 
		                  AND  INSTR(DECODE(:pPrcSys, 'SYSTCB', '13'
		                          	                          , '03, 55'
		                        	       ), B.CM_SVRCD
		                        	) > 0
		   	             )
		   	         OR  (     E.CR_QRYCD IN ('03','16') 
		   	              AND  B.CM_SVRCD  IN ('13','53')
		   	             )
		             OR  (     E.CR_QRYCD  = '06' 
		                  AND  INSTR(DECODE(:pPrcSys, 'SYSTCB', '13'
		                     	                              , '03, 55'
		                   	               ), B.CM_SVRCD
		                   	    ) > 0
		   	             )
		            )
			   AND  B.CM_CLOSEDT IS NULL
			   AND  B.CM_SVRSTOP = 'N'
			   AND  A.CR_SYSCD	= B.CM_SYSCD
			   AND  A.CR_SYSCD  = C.CM_SYSCD
			   AND  A.CR_RSRCCD = C.CM_RSRCCD
			   AND  A.CR_SYSCD  = D.CM_SYSCD
			   AND  A.CR_RSRCCD	= D.CM_RSRCCD
			   AND  B.CM_SVRCD	= D.CM_SVRCD
			   AND  B.CM_SEQNO	= D.CM_SEQNO
			   AND  (    A.CR_PID IS NULL
			         OR  NVL(A.CR_PUTCODE,'RTRY') = 'RTRY'
			        );

		EXEC SQL open  SYSCOM_Rsrc2;
		while(1) {
			EXEC SQL fetch SYSCOM_Rsrc2
				INTO  :szSysCD
					, :szSvrCD
					, :szSvrName
					, :szSvrIP
					, :szPortNo
					, :szDir
					, :szSvrSeq;

			if (sqlca.sqlcode == 1403)	break;
			if (sqlca.sqlcode != 0 && sqlca.sqlcode != -1405) {
				sprintf(gszLogMsg,"SYSCOM_Rsrc2 DB FETCH ERROR : [%s] [%d] [%s]", pAcptNo, sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
				eCAMS_Log(gszLogPath, gszLogFile, gszLogMsg);
				break;
			}

			NotUseDataTruncate (szSysCD  , 0x20);
			NotUseDataTruncate (szSvrCD  , 0x20);
			NotUseDataTruncate (szSvrName, 0x20);
			NotUseDataTruncate (szSvrIP  , 0x20);
			NotUseDataTruncate (szDir    , 0x20);

			eCAMS_ACComp_Fork ("SYSTPT", pAcptNo, 1, szSvrIP, szSysCD, "", "", "1","", pPrcSys, ""
			                  ,"", szPortNo, "", szSvrCD , szSvrSeq,1);
		}
		EXEC SQL close SYSCOM_Rsrc2;
	}
	
	/*-----------------------------------------------------------*/
	/*	처리완료 여부 체크                                       */
	/*-----------------------------------------------------------*/
	wait_Accomp_Fork("SYSTPT",pAcptNo);


	nPutErrCnt = 0;
	/*-----------------------------------------------------------*/
	/*	파일 전송 오류건수 조회                                  */
	/*-----------------------------------------------------------*/
	EXEC SQL
		SELECT  COUNT(a.CR_SEQNO)
		  INTO  :nPutErrCnt
		  FROM  CMR1011 a
		      , CMR1010 b
		 WHERE  a.CR_ACPTNO  = :pAcptNo
		   AND  b.CR_PRCDATE IS NULL
		   AND  a.CR_ACPTNO  = b.CR_ACPTNO
		   AND  a.CR_SERNO   = b.CR_SERNO
		   AND  b.CR_STATUS != '3'
		   AND  a.CR_PRCSYS  = :pPrcSys
		   AND  NVL(a.CR_PUTCODE, 'N/A') != '0000';

	/*-----------------------------------------------------------*/
	/*	파일전송 결과 변경                                       */
	/*-----------------------------------------------------------*/
	EXEC SQL
		UPDATE  CMR1010
		   SET  CR_SYSSTEP = DECODE(NVL(CR_PUTCODE, '0000'), '0000',    2
		                                                           , 0         
		                           )
		      , CR_PUTCODE = DECODE(NVL(CR_PUTCODE, '0000'), '0000', NULL
		                                                           , CR_PUTCODE
		                           )
		 WHERE  CR_ACPTNO = :pAcptNo
		   AND  CR_PRCDATE IS NULL
		   AND  NVL(CR_SYSSTEP,0) <= 1;


	if (sqlca.sqlcode != 0 && sqlca.sqlcode != 1403) {
		sprintf(gszLogMsg,"Step Update Err!!! : [%s] [%d] [%s]", pAcptNo, sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
		eCAMS_Log(gszLogPath, gszLogFile, gszLogMsg);
		strcpy(pRstCond,"EROR");
		return sqlca.sqlcode;
	}

	/*-----------------------------------------------------------*/
	/*	처리단계 변경                                            */
	/*-----------------------------------------------------------*/
	EXEC SQL EXECUTE
    	BEGIN
	        UPDATE_1000STEP(:pAcptNo,:szSysStep);
        END;
    END-EXEC;

	if (sqlca.sqlcode != 0) {
		/*LOG*/sprintf(gszLogMsg,"[%s] CMR1000 SYSSTEP UPDATE ERROR [%d] [%s]", pAcptNo,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);
		strcpy(pRstCond,"EROR");
		return sqlca.sqlcode;
	}
	EXEC SQL COMMIT;

	if(nPutErrCnt != 0)	{
		strcpy(pRstCond,"EROR");
		return nPutErrCnt;
	}
	strcpy(pRstCond,"0000");

	return nPutErrCnt;

}


/*---------------------------------------------------------------*/
/*	Function  : RunSyscomRsrcScript                              */
/*	Action    : 컴파일/배포 목록 작성                            */
/*	Parameter :	pAcptNo   : 신청번호                             */
/*	            pPrcSys   : 처리단계                             */
/*	            pRstCond  : 처리결과                             */
/*	Return    : 오류건수                                         */
/*---------------------------------------------------------------*/
int 	RunSyscomRsrcScript	( char *pAcptNo
							, char *pPrcSys
							, char *pRstCond
							)
{
char	szSysCD                [dfSysCD];
char	szDsnCD                [dfDsnCD];
char	szRsrcName          [dfRsrcName];
char	szRsrcCD              [dfRsrcCD];
int		szVersion                       ;
int		szBefVer                        ;
char	szEditor              [dfEditor];
int		szSerNo                         ;
char	szSrcChg                   [1+1];
char	szPri                       [10];
char	szPrePri                    [10];
char	szAplyDate                [14+1];
char	szItemID              [dfItemID];
char	szBaseItem            [dfItemID];
char	szReqCD                [dfReqCD];
char	szConfNo              [dfAcptNo];
char	szQryCD                [dfReqCD];
char	szSysGB                    [1+1];
char	szSvrIP                [dfSvrIP];
int		szPortNo                        ;
char	szSvrCD                [dfSvrCD];
char	szSvrName              [dfSvrNM];
char	szDir                    [dfDir];
char	szVolPath                [dfDir];
char	szSysOS                [dfSysOS];
int		szSvrSeq                        ;
char	szInfo                  [dfInfo];
char	szDirPath                [dfDir];
char	szchmod                      [6];
char	szchown                     [21];
char	szchgrp                     [21];
char	szJobCD                [dfJobCD];
char	szSvrInfo            [dfSvrInfo];
char	szReqPath                [dfDir];
char	szRstFile           [dfFullPath];
char	szBKRsrcName        [dfRsrcName];
char	szChangDirPath           [dfDir];
char	szChangDirPathTmp        [dfDir];
char	szRemoteFileName    [dfFullPath];
char	szLocalFileName     [dfFullPath];
char	szBackFileName      [dfRsrcName];
char	szRemote            [dfFullPath];
char	szLocal             [dfFullPath];
char	szCommand           [dfFullPath];
char	idxFileName         [dfFullPath];
char	szFileDate                [14+1];
char	szSubSysOs             [dfSysCD];
int		szSubPortNo                     ;
char	szSubSvrIP             [dfSvrIP];
int		szSubSvrSeq                     ;
int		idxcnt                          ;
int		nRst                            ;
int		nComErrCnt                      ;
int		szSysStep                       ;
struct 	stat f_st                       ;
long	lFileSize                       ;
int		nRet                            ;
int 	nCnt                            ;
CMD_INFO	  CmdInfo                   ;


	memset(szPrePri , 0x00, sizeof(szPrePri ));
	memset(szReqPath, 0x00, sizeof(szReqPath));

	/*-----------------------------------------------------------*/
	/*	파일 생성시 파일이 저장될 경로 설정및 생성               */
	/*-----------------------------------------------------------*/
	SetTempDir("77",szReqPath);
	strcat(szReqPath,pAcptNo);
	if (access(szReqPath,F_OK) != 0)
		Local_Dir_Make(szReqPath);

	/*-----------------------------------------------------------*/
	/*	소켓 명령 변수 초기화                                    */
	/*-----------------------------------------------------------*/
	InitCmdInfo(&CmdInfo);
	strcpy(CmdInfo.szAcptNo,pAcptNo);
	sprintf(CmdInfo.szLogFile,"%sTransList.%s",gszLogPath,gszLogFile);

	EXEC SQL DECLARE SYSCOM_Rsrc3 CURSOR FOR
		SELECT  DISTINCT
		        A.CR_SYSCD
		      , A.CR_DSNCD
		      , A.CR_RSRCCD
		      , A.CR_JOBCD
		      , A.CR_RSRCNAME
		      , A.CR_VERSION
		      , A.CR_BEFVER
		      , A.CR_EDITOR
		      , A.CR_SERNO
		      , A.CR_PRIORITY
		      , A.CR_SRCCHG
		      , NVL(A.CR_APLYDATE, '0')
		      , A.CR_ITEMID
		      , A.CR_QRYCD
		      , A.CR_CONFNO
		      , A.CR_BASEITEM
		      , B.CR_QRYCD
		      , B.CR_SYSGB
		      , C.CM_SVRIP
		      , C.CM_PORTNO
		      , C.CM_SVRCD
		      , C.CM_SVRNAME
		      , C.CM_DIR
		      , C.CM_VOLPATH
		      , C.CM_SYSOS
		      , C.CM_SEQNO
		      , D.CM_INFO
		      , F.CM_DIRPATH
		  FROM  CMR1000 B
		      , CMR1010 A
		      , CMM0031 C
		      , CMM0036 D
		      , CMM0038 E
		      , CMM0070 F
		 WHERE  A.CR_ACPTNO = :pAcptNo
		   AND  NVL(A.CR_SYSSTEP,0) = :szSysStep
		   AND  A.CR_SRCCMP = 'Y'
		   AND  A.CR_PRCDATE IS NULL
		   AND  B.CR_ACPTNO = A.CR_ACPTNO
		   AND  A.CR_SYSCD  = C.CM_SYSCD
	       AND  (    (     B.CR_QRYCD  = '04' 
	                  AND  INSTR(DECODE(:pPrcSys, 'SYSTCB', '13'
	                          	                          , '03'
	                        	       ), C.CM_SVRCD
	                        	) > 0
	   	             )
	   	         OR  (     B.CR_QRYCD IN ('03','16') 
	   	              AND  C.CM_SVRCD = '13'
	   	             )
	             OR  (     B.CR_QRYCD  = '06' 
	                  AND  INSTR(DECODE(:pPrcSys, 'SYSTCB', '13'
	                     	                              , '03'
	                   	               ), C.CM_SVRCD
	                   	    ) > 0
	   	             )
	            )
		   AND  C.CM_CLOSEDT    IS NULL
		   AND  C.CM_SVRSTOP = 'N'
		   AND  D.CM_CLOSEDT    IS NULL
		   AND  A.CR_SYSCD  = D.CM_SYSCD
		   AND  A.CR_RSRCCD = D.CM_RSRCCD
		   AND  (    (     A.CR_QRYCD != '05' 
		              AND  SUBSTR(D.CM_INFO, 1, 1)  = '1' 
		              AND  SUBSTR(D.CM_INFO, 64,1) != '1'
		             )
		         OR  (     A.CR_QRYCD  = '05' 
		              AND  SUBSTR(D.CM_INFO,18,1) = '1'
		             )
		        )
		   AND  A.CR_SYSCD  = E.CM_SYSCD
		   AND  A.CR_RSRCCD = E.CM_RSRCCD
		   AND  C.CM_SVRCD  = E.CM_SVRCD
		   AND  C.CM_SEQNO  = E.CM_SEQNO
		   AND  A.CR_SYSCD  = F.CM_SYSCD
		   AND  A.CR_DSNCD  = F.CM_DSNCD
		   AND  (    A.CR_PID IS NULL
		         OR  NVL(A.CR_PUTCODE,'RTRY') = 'RTRY'
		        )
		 ORDER  BY  A.CR_PRIORITY, A.CR_SERNO;


	EXEC SQL DECLARE SYSCOM_Rsrc3_sub CURSOR FOR
		SELECT  A.CM_SYSOS
		      , A.CM_SEQNO
		      , A.CM_SVRIP
		      , A.CM_PORTNO
		  FROM  CMM0031 A
		      , CMM0038 B
		 WHERE  A.CM_SYSCD = :szSysCD
		   AND  A.CM_SVRCD = :szSvrCD
		   AND  A.CM_CLOSEDT IS NULL
		   AND  A.CM_SVRSTOP = 'N'
		   AND  A.CM_SYSCD = B.CM_SYSCD
		   AND  A.CM_SVRCD = B.CM_SVRCD
		   AND  A.CM_SEQNO = B.CM_SEQNO
		   AND  B.CM_RSRCCD = :szRsrcCD;

	szSysStep = 2;
	EXEC SQL open  SYSCOM_Rsrc3;
    while (1) {
		EXEC SQL fetch SYSCOM_Rsrc3
			into  :szSysCD
			    , :szDsnCD
			    , :szRsrcCD
			    , :szJobCD
			    , :szRsrcName
			    , :szVersion
			    , :szBefVer
			    , :szEditor
			    , :szSerNo
			    , :szPri
			    , :szSrcChg
			    , :szAplyDate
			    , :szItemID
			    , :szReqCD
			    , :szConfNo
			    , :szBaseItem
			    , :szQryCD
			    , :szSysGB
			    , :szSvrIP
			    , :szPortNo
			    , :szSvrCD
			    , :szSvrName
			    , :szDir
			    , :szVolPath
			    , :szSysOS
			    , :szSvrSeq
			    , :szInfo
			    , :szDirPath;

		if (sqlca.sqlcode == 1403) 	break;
		if (sqlca.sqlcode != 0 && sqlca.sqlcode != -1405) {
			sprintf(gszLogMsg,"RunSyscomRsrcScript DB FETCH ERROR : [%s] [%d] [%d] [%s]", pAcptNo, szSerNo, sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
			eCAMS_Log(gszLogPath, gszLogFile, gszLogMsg);
			break;
		}

		NotUseDataTruncate (szSysCD   , 0x20);
		NotUseDataTruncate (szDsnCD   , 0x20);
		NotUseDataTruncate (szRsrcCD  , 0x20);
		NotUseDataTruncate (szEditor  , 0x20);
		NotUseDataTruncate (szSrcChg  , 0x20);
		NotUseDataTruncate (szAplyDate, 0x20);
		NotUseDataTruncate (szItemID  , 0x20);
		NotUseDataTruncate (szReqCD   , 0x20);
		NotUseDataTruncate (szConfNo  ,	0x20);
		NotUseDataTruncate (szBaseItem,	0x20);
		NotUseDataTruncate (szQryCD   , 0x20);
		NotUseDataTruncate (szSysGB   , 0x20);
		NotUseDataTruncate (szSvrIP   , 0x20);
		NotUseDataTruncate (szSvrCD   , 0x20);
		NotUseDataTruncate (szSvrName , 0x20);
		NotUseDataTruncate (szDir     , 0x20);
		NotUseDataTruncate (szVolPath , 0x20);
		NotUseDataTruncate (szSysOS   , 0x20);
		NotUseDataTruncate (szInfo    , 0x20);
		NotUseDataTruncate (szPri     , 0x20);
		NotUseDataTruncate (szJobCD   , 0x20);

		sprintf(szRsrcName, "%s", trunc_char(szRsrcName));
		sprintf(szDirPath , "%s", trunc_char(szDirPath ));
		strcpy(szBKRsrcName,szRsrcName);

		ChangeVolPath(szSysCD , szSvrCD, szRsrcCD, szSvrSeq, szDirPath, szChangDirPathTmp);

		if (cmp_mid_char(szInfo,19,1,"1") == 0) {
			EXEC SQL
				SELECT  CM_VOLPATH
				  INTO  :szChangDirPath
				  FROM  CMM0038
				 WHERE  CM_SYSCD  = :szSysCD
				   AND  CM_SEQNO  = :szSvrSeq
				   AND  CM_SVRCD  = :szSvrCD
				   AND  CM_RSRCCD = :szRsrcCD;

			if (sqlca.sqlcode != 0) {
				sprintf(gszLogMsg, "SQLErrCheck 2: REAL Server 정보 오류 syscd[%s]rsrccd[%s]svrcd[%s]szSeqNo[%d] [%d] [%s]", szSysCD,szRsrcCD,szSvrCD,szSvrSeq,sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
				eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);
				exit (1);
			}

			NotUseDataTruncate (szChangDirPath, 0x20);
			sprintf(szChangDirPathTmp, "%s/%s/%s", szChangDirPath,pAcptNo, right_char(szChangDirPathTmp, strlen(szChangDirPathTmp) - strlen(szChangDirPath)));
		}

		if (cmp_right_char(szChangDirPathTmp, 1, "/") == 0){
			sprintf(szChangDirPathTmp, "%s", left_char(szChangDirPathTmp, strlen(szChangDirPathTmp) - 1));
		}

		/*-------------------------------------------------------*/
		/* 	OS 별 디렉토리 변환                                  */
		/*-------------------------------------------------------*/
		Convert_WinDirPath (szSysOS, szChangDirPathTmp, szChangDirPath);

		/*-------------------------------------------------------*/
		/*	결과파일명                                           */
		/*-------------------------------------------------------*/
		sprintf(szRstFile,"%s/%s.%d.%s.%d.result", gszTempPath, pAcptNo, szSerNo,szSvrIP,szSvrSeq);

		/*-------------------------------------------------------*/
		/*	개발서버에 파일저장 경로+파일명                      */
		/*-------------------------------------------------------*/
		strcpy(szRemoteFileName,szRsrcName);
		sprintf(szLocalFileName,"%s.%s.%d",szRsrcName, pAcptNo, szSerNo);
		sprintf(szLocal,"%s/%s",szReqPath,szLocalFileName);

		Result_Make(szRstFile,"컴파일전 CMR1011 생성",szSvrIP,"SYSCB","0000");
		CMR1011_Make (szSysCD, szSvrIP, pAcptNo, szSerNo, szRstFile, 2, "0000", szSvrName, "SYSCB",szSvrCD,szSvrSeq);

		/*-------------------------------------------------------*/
		/*	처리결과 코드 초기화                                 */
		/*-------------------------------------------------------*/
		EXEC SQL
			UPDATE  CMR1011
			   SET  CR_PRCRST  = NULL
			      , CR_PUTCODE = NULL
			 WHERE  CR_ACPTNO = :pAcptNo
			   AND  CR_PRCSYS = :pPrcSys
			   AND  CR_SERNO  = :szSerNo
  		       AND  CR_SVRSEQ = :szSvrSeq
  		       AND  CR_IPADDR = :szSvrIP
			   AND  CR_SVRCD  = :szSvrCD;

		if (sqlca.sqlcode != 0 && sqlca.sqlcode != 1403) {
			sprintf(gszLogMsg,"cr_prcrst update Err!!! : [%s] [%d] [%s]", pAcptNo, sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
			eCAMS_Log(gszLogPath, gszLogFile, gszLogMsg);
			strcpy(pRstCond,"EROR");
			return 1;
		}
		EXEC SQL COMMIT;


		EXEC SQL
			UPDATE  CMR1010
			   SET  CR_PUTCODE = NULL
			 WHERE  CR_ACPTNO = :pAcptNo
			   AND  CR_SERNO  = :szSerNo;

		if (sqlca.sqlcode != 0 && sqlca.sqlcode != 1403) {
			sprintf(gszLogMsg,"cr_putcode clear Err!!! : [%s] [%d] [%s]", pAcptNo, sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
			eCAMS_Log(gszLogPath, gszLogFile, gszLogMsg);
			strcpy(pRstCond,"EROR");
			return 1;
		}
		EXEC SQL COMMIT;

		if (strcmp(pPrcSys,"SYSCB" ) == 0 ||
			strcmp(pPrcSys,"SYSTCB") == 0 ) {
			if (strlen(szPrePri) == 0) {
				strcpy(szPrePri, szPri);
			}

			if (strcmp(szPrePri, szPri) != 0) {
				/*LOG*/sprintf(gszLogMsg,"ECAMS_ACCT1	Process_SYSCOM(<%s><%s>) [%s][%s]순위 처리 시작 \n",pAcptNo,pPrcSys,szPri,szPrePri);
				eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);

				do {
					/*-------------------------------------------*/
					/* 현재 우선처리 순위중 처리미완료건 조회    */
					/*-------------------------------------------*/
					EXEC SQL
						SELECT  COUNT(*)
						  INTO  :nCnt
						  FROM  CMR1010 a
						      , CMR1011 b
						      , CMM0036 c
						 WHERE  a.CR_ACPTNO   = :pAcptNo
						   AND  a.CR_PRIORITY = :szPrePri
						   AND  a.CR_ACPTNO   = b.CR_ACPTNO
						   AND  a.CR_SERNO    = b.CR_SERNO
						   AND  b.CR_PRCSYS   = :pPrcSys
						   AND	a.CR_SYSCD	  = c.CM_SYSCD
						   AND  a.CR_RSRCCD   = c.CM_RSRCCD
						   AND  (    (     a.CR_QRYCD != '05' 
						              AND  SUBSTR(c.CM_INFO, 1, 1)  = '1'  
						              AND  SUBSTR(c.CM_INFO, 64,1) != '1'
						             )
						         OR  (     a.CR_QRYCD  = '05' 
						              AND  SUBSTR(c.CM_INFO,18,1) = '1'
						             )
						        )
						   AND  b.CR_PRCRST IS NULL;

					if (sqlca.sqlcode != 0) {
						nCnt = 0;
					}
					sleep(1);
				} while(nCnt != 0);

				do {
					/*-----------------------------------------------*/
				    /*	해당 순위가 완료 되었으면 처리된 건에 오류   */
				    /*  결과가 있는지 조회                           */
				    /*-----------------------------------------------*/
					EXEC SQL
						SELECT  COUNT(*)
						  INTO  :nCnt
						  FROM  CMR1010 a
						      , CMR1011 b
						      , CMM0036 c
						 WHERE  a.CR_ACPTNO   = :pAcptNo
						   AND  a.CR_PRIORITY = :szPrePri
						   AND  a.CR_ACPTNO   = b.CR_ACPTNO
						   AND  a.CR_SERNO    = b.CR_SERNO
						   AND  b.CR_PRCSYS   = :pPrcSys
						   AND	a.CR_SYSCD	  = c.CM_SYSCD
						   AND  a.CR_RSRCCD   = c.CM_RSRCCD
						   AND  a.CR_PRCDATE IS NULL
						   AND  (    (     a.CR_QRYCD != '05' 
						              AND  SUBSTR(c.CM_INFO, 1, 1)  = '1' 
						              AND  SUBSTR(c.CM_INFO, 64,1) != '1'
						             )
						         OR  (     a.CR_QRYCD  = '05' 
						              AND  SUBSTR(c.CM_INFO,18,1) = '1'
						             )
						        )
						   AND  b.CR_PRCRST   != '0000';

					if (nCnt != 0) {
						/*LOG*/sprintf(gszLogMsg, "ECAMS_ACCT1	Process_SYSCOM(<%s><%s>) 상위 우선순위 오류처리 대기[%s] \n",pAcptNo,pPrcSys,szPrePri);
						eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);

						EXEC SQL
							DELETE  CMR1011
							 WHERE  CR_ACPTNO = :pAcptNo
							   AND  CR_SERNO  = :szSerNo
							   AND  CR_SVRSEQ = :szSvrSeq
							   AND  CR_PRCSYS = :pPrcSys
							   AND  CR_SVRCD  = :szSvrCD;

						EXEC SQL COMMIT;
						exit (1);
					}
					sleep(1);
				} while( nCnt != 0);
				strcpy(szPrePri, szPri);


				/*-----------------------------------------------*/
				/*	신청건 일괄컴파일에 대한 처리                */
				/*-----------------------------------------------*/
				if (cmp_mid_char(szInfo,16,1,"1") == 0) {
					EXEC SQL OPEN SYSCOM_Rsrc3_sub;
					while (1) {
				        EXEC SQL fetch SYSCOM_Rsrc3_sub
				        	INTO  :szSubSysOs
				        		, :szSubSvrSeq
				        		, :szSubSvrIP
				        		, :szSubPortNo;

						if (sqlca.sqlcode == 1403)	break;

						NotUseDataTruncate (szSubSysOs, 0x20);
						NotUseDataTruncate (szSubSvrIP, 0x20);

						ChangeVolPath(szSysCD , szSvrCD, szRsrcCD, szSubSvrSeq, szDirPath, szChangDirPathTmp);

						if (cmp_mid_char(szInfo,19,1,"1") == 0) {
							EXEC SQL
								SELECT  CM_VOLPATH
								  INTO  :szChangDirPath
								  FROM  CMM0038
								 WHERE  CM_SysCD  = :szSysCD
								   AND  CM_SEQNO  = :szSubSvrSeq
								   AND  CM_SvrCD  = :szSvrCD
								   AND  CM_RsrcCD = :szRsrcCD;

						    if (sqlca.sqlcode != 0) {
							   sprintf(gszLogMsg, "SQLErrCheck 2: REAL Server 정보 오류 syscd[%s]rsrccd[%s]svrcd[%s]szSeqNo[%d] [%d] [%s]", szSysCD,szRsrcCD,szSvrCD,szSubSvrSeq,sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
							   eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);
							   exit (1);
						    }
							NotUseDataTruncate (szChangDirPath, 0x20);
							sprintf(szChangDirPathTmp, "%s/%s/%s", szChangDirPath,pAcptNo, right_char(szChangDirPathTmp, strlen(szChangDirPathTmp) - strlen(szChangDirPath)));
						}

						if (memcmp(right_char(szChangDirPathTmp, 1), "/", 1) == 0) {
							sprintf(szChangDirPathTmp, "%s", left_char(szChangDirPathTmp, strlen(szChangDirPathTmp) - 1));
						}

						/*---------------------------------------*/
						/* 	OS 별 디렉토리 변환                  */
						/*---------------------------------------*/
						Convert_WinDirPath (szSubSysOs, szChangDirPathTmp, szChangDirPath);

						/*---------------------------------------*/
						/*	결과파일명                           */
						/*---------------------------------------*/
						sprintf(szRstFile,"%s/%s.%d.%s.%d.result", gszTempPath, pAcptNo, szSerNo,szSvrIP,szSubSvrSeq);

						/*---------------------------------------*/
						/*	개발서버에 파일저장 경로+파일명      */
						/*---------------------------------------*/
						strcpy(szRemoteFileName,szRsrcName);
						sprintf(szLocalFileName,"%s.%s.%d",szRsrcName, pAcptNo, szSerNo);
						sprintf(szLocal,"%s/%s",szReqPath,szLocalFileName);

						if (eCAMS_ACComp_Fork("SYSCOM",pAcptNo, szSerNo, szSubSvrIP,
								    	szSysCD, szRsrcCD, szDsnCD, "2" ,szReqCD,pPrcSys,szChangDirPath,
										szRemoteFileName, szSubPortNo, "000001", szSvrCD, szSubSvrSeq,1) != 0) {
							/*LOG*/sprintf(gszLogMsg, "ECAMS_ACCT1	[%s][%s][%d] eCAMS_ACComp_Fork Fail \n",pAcptNo,pPrcSys,szSerNo);
							eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);

							strcpy(pRstCond,"9999");
							Result_Make(szRstFile,"eCAMS_ACComp_Fork 처리중 오류 [오류건재처리요망]",szSubSvrIP,"SYSCB",pRstCond);
							CMR1011_Make (szSysCD, szSubSvrIP, pAcptNo, szSerNo, szRstFile, 2, pRstCond, szSvrName, "SYSCB",szSvrCD,szSubSvrSeq);
							exit(1);
						}
					}
					EXEC SQL close SYSCOM_Rsrc3_sub;

					EXEC SQL
						UPDATE  CMR1010
						   SET  CR_SRCCMP = 'N'
						 WHERE  CR_ACPTNO = :pAcptNo;

					EXEC SQL COMMIT;
					EXEC SQL close SYSCOM_Rsrc3;
					EXEC SQL open  SYSCOM_Rsrc3;
				}
				else {
					eCAMS_ACComp_Fork("SYSCOM",pAcptNo, szSerNo, szSvrIP,
							    	szSysCD, szRsrcCD, szDsnCD, "2" ,szReqCD,pPrcSys,szChangDirPath,
									szRemoteFileName, szPortNo, "000001", szSvrCD, szSvrSeq,1);
				}
			}/*end if우선 순위가 틀리다면 */

			else {
				strcpy(szPrePri,szPri);

				/*-----------------------------------------------*/
				/*	신청건 일괄컴파일에 대한 처리                */
				/*-----------------------------------------------*/
				if (cmp_mid_char(szInfo,16,1,"1") == 0) {
					EXEC SQL OPEN SYSCOM_Rsrc3_sub;
					while (1) {
				        EXEC SQL fetch SYSCOM_Rsrc3_sub
				        	INTO  :szSubSysOs
				        		, :szSubSvrSeq
				        		, :szSubSvrIP
				        		, :szSubPortNo;

						if (sqlca.sqlcode == 1403)	break;

						NotUseDataTruncate (szSubSysOs, 0x20);
						NotUseDataTruncate (szSubSvrIP, 0x20);

						ChangeVolPath(szSysCD , szSvrCD, szRsrcCD, szSubSvrSeq, szDirPath, szChangDirPathTmp);

						if (cmp_mid_char(szInfo,19,1,"1") == 0) {
							EXEC SQL
								SELECT  CM_VOLPATH
								  INTO  :szChangDirPath
								  FROM  CMM0038
								 WHERE	CM_SysCD  = :szSysCD
								   AND  CM_SEQNO  = :szSubSvrSeq
								   AND  CM_SvrCD  = :szSvrCD
								   AND  CM_RsrcCD = :szRsrcCD;

						    if (sqlca.sqlcode != 0) {
								sprintf(gszLogMsg, "SQLErrCheck 2: REAL Server 정보 오류 syscd[%s]rsrccd[%s]svrcd[%s]szSeqNo[%d] [%d] [%s]", szSysCD,szRsrcCD,szSvrCD,szSubSvrSeq,sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
								eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);
								exit (1);
						    }
							NotUseDataTruncate (szChangDirPath, 0x20);
							sprintf(szChangDirPathTmp, "%s/%s/%s", szChangDirPath,pAcptNo, right_char(szChangDirPathTmp, strlen(szChangDirPathTmp) - strlen(szChangDirPath)));
						}

						if (cmp_right_char(szChangDirPathTmp, 1, "/") == 0) {
							sprintf(szChangDirPathTmp, "%s", left_char(szChangDirPathTmp, strlen(szChangDirPathTmp) - 1));
						}

						/*---------------------------------------*/
						/*	OS별 디렉토리 변환                   */
						/*---------------------------------------*/
						Convert_WinDirPath (szSubSysOs, szChangDirPathTmp, szChangDirPath);

						/*---------------------------------------*/
						/*	결과파일명                           */
						/*---------------------------------------*/
						sprintf(szRstFile,"%s/%s.%d.%s.%d.result", gszTempPath, pAcptNo, szSerNo,szSvrIP,szSubSvrSeq);

						/*---------------------------------------*/
						/*	개발서버에 파일저장 경로+파일명      */
						/*---------------------------------------*/
						strcpy(szRemoteFileName, szRsrcName);
						sprintf(szLocalFileName,"%s.%s.%d",szRsrcName, pAcptNo, szSerNo);
						sprintf(szLocal,"%s/%s",szReqPath,szLocalFileName);

						eCAMS_ACComp_Fork("SYSCOM",pAcptNo, szSerNo, szSubSvrIP,
								    	szSysCD, szRsrcCD, szDsnCD, "2" ,szReqCD,pPrcSys,szChangDirPath,
										szRemoteFileName, szSubPortNo, "000001", szSvrCD, szSubSvrSeq,1);
					}
					EXEC SQL close SYSCOM_Rsrc3_sub;

					EXEC SQL
						UPDATE  CMR1010
						   SET  CR_SRCCMP = 'N'
						 WHERE  CR_ACPTNO = :pAcptNo;

					EXEC SQL COMMIT;
					EXEC SQL close SYSCOM_Rsrc3;
					EXEC SQL open  SYSCOM_Rsrc3;
				}
				else {
					if (cmp_mid_char(szInfo,30,1,"1") == 0) {
						eCAMS_ACComp_Fork("SYSCOM",pAcptNo, szSerNo, szSvrIP,
								    	szSysCD, szRsrcCD, szDsnCD, "2" ,szReqCD,pPrcSys,szChangDirPath,
										szRemoteFileName, szPortNo, "000001", szSvrCD, szSvrSeq,0);
					}
					else{
						eCAMS_ACComp_Fork("SYSCOM",pAcptNo, szSerNo, szSvrIP,
								    	szSysCD, szRsrcCD, szDsnCD, "2" ,szReqCD,pPrcSys,szChangDirPath,
										szRemoteFileName, szPortNo, "000001", szSvrCD, szSvrSeq,1);
					}
				}
			}
		} /* end if컴파일일 경우 */
	}
    EXEC SQL close SYSCOM_Rsrc3;
	
	/*-----------------------------------------------------------*/
	/*	처리완료 여부 체크                                       */
	/*-----------------------------------------------------------*/
	wait_Accomp_Fork("SYSCOM",pAcptNo);
	nComErrCnt = 0;

	/*-----------------------------------------------------------*/
	/*	처리결과 오류건수 조회                                   */
	/*-----------------------------------------------------------*/
	EXEC SQL
		SELECT  COUNT(a.CR_SEQNO)
		  INTO  :nComErrCnt
		  FROM  CMR1011 a
		      , CMR1010 b
		 WHERE  a.CR_ACPTNO  = :pAcptNo
		   AND  b.CR_PRCDATE IS NULL
		   AND  a.CR_ACPTNO  = b.CR_ACPTNO
		   AND  a.CR_SERNO   = b.CR_SERNO
		   AND  b.CR_STATUS != '3'
		   AND  a.CR_PRCSYS  = :pPrcSys
		   AND  NVL(a.CR_PUTCODE,'NA') != '0000';

	/*-----------------------------------------------------------*/
	/*	처리단계 변경                                            */
	/*-----------------------------------------------------------*/
	EXEC SQL
		UPDATE  CMR1010
		   SET  CR_SYSSTEP = DECODE(NVL(CR_PUTCODE,'0000'),'0000', 3   , 2         )
		      , CR_PUTCODE = DECODE(NVL(CR_PUTCODE,'0000'),'0000', NULL, CR_PUTCODE)
		 WHERE  CR_ACPTNO  = :pAcptNo
		   AND  CR_PRCDATE IS NULL
		   AND  NVL(CR_SYSSTEP,0) <= 2;

	if (sqlca.sqlcode != 0 && sqlca.sqlcode != 1403) {
		sprintf(gszLogMsg,"Step Update Err!!! : [%s] [%d] [%s]", pAcptNo, sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
		eCAMS_Log(gszLogPath, gszLogFile, gszLogMsg);
		strcpy(pRstCond,"EROR");
		return sqlca.sqlcode;
	}


	EXEC SQL EXECUTE
    	BEGIN
	        UPDATE_1000STEP(:pAcptNo,:szSysStep);
        END;
    END-EXEC;

	if (sqlca.sqlcode != 0) {
		/*LOG*/sprintf(gszLogMsg,"[%s] CMR1000 SYSSTEP UPDATE ERROR [%d] [%s]", pAcptNo,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);
		strcpy(pRstCond,"EROR");
		return sqlca.sqlcode;
	}
	EXEC SQL COMMIT;

	if (nComErrCnt != 0) {
		strcpy(pRstCond,"EROR");
		return nComErrCnt;
	}
	strcpy(pRstCond, "0000");

	szSysStep = 3;

	/*-----------------------------------------------------------*/
	/*	미처리 대상 재 확인하여 미처리이면 처리로직 수행         */
	/*-----------------------------------------------------------*/
	EXEC SQL DECLARE SYSCOM_Rsrc3_c CURSOR FOR
		SELECT  DISTINCT
		        A.CR_SYSCD
		      , A.CR_DSNCD
		      , A.CR_RSRCCD
		      , A.CR_JOBCD
		      , A.CR_RSRCNAME
		      , A.CR_VERSION
		      , A.CR_BEFVER
		      , A.CR_EDITOR
		      , A.CR_SERNO
		      , A.CR_PRIORITY
		      , A.CR_SRCCHG
		      , NVL(A.CR_APLYDATE, '0')
		      , A.CR_ITEMID
		      , A.CR_QRYCD
		      , A.CR_CONFNO
		      , A.CR_BASEITEM
		      , B.CR_QRYCD
		      , B.CR_SYSGB
		      , C.CM_SVRIP
		      , C.CM_PORTNO
		      , C.CM_SVRCD
		      , C.CM_SVRNAME
		      , C.CM_DIR
		      , C.CM_VOLPATH
		      , C.CM_SYSOS
		      , C.CM_SEQNO
		      , D.CM_INFO
		      , F.CM_DIRPATH
		  FROM  CMR1000 B
		      , CMR1010 A
		      , CMM0031 C
		      , CMM0036 D
		      , CMM0038 E
		      , CMM0070 F
		 WHERE  A.CR_ACPTNO = :pAcptNo
		   AND  NVL(A.CR_SYSSTEP,0) = :szSysStep
		   AND  A.CR_SRCCMP = 'Y'
		   AND  A.CR_PRCDATE IS NULL
		   AND  B.CR_ACPTNO = A.CR_ACPTNO
		   AND  A.CR_SYSCD  = C.CM_SYSCD
	       AND  (    (     B.CR_QRYCD  = '04' 
	                  AND  INSTR(DECODE(:pPrcSys, 'SYSTCB', '13'
	                          	                          , '03'
	                        	       ), C.CM_SVRCD
	                        	) > 0
	   	             )
	   	         OR  (     B.CR_QRYCD IN ('03','16') 
	   	              AND  C.CM_SVRCD = '13'
	   	             )
	             OR  (     B.CR_QRYCD  = '06' 
	                  AND  INSTR(DECODE(:pPrcSys, 'SYSTCB', '13'
	                     	                              , '03'
	                   	               ), C.CM_SVRCD
	                   	    ) > 0
	   	             )
	            )
		   AND  C.CM_CLOSEDT    IS NULL
		   AND  C.CM_SVRSTOP = 'N'
		   AND  D.CM_CLOSEDT    IS NULL
		   AND  A.CR_SYSCD  = D.CM_SYSCD
		   AND  A.CR_RSRCCD = D.CM_RSRCCD
		   AND  (    (     A.CR_QRYCD <> '05' 
		              AND  SUBSTR(D.CM_INFO, 1, 1)  = '1' 
		              AND  SUBSTR(D.CM_INFO, 64,1) != '1'
		             )
		         OR  (     A.CR_QRYCD = '05' 
		              AND  SUBSTR(D.CM_INFO,18,1) = '1'
		             )
		        )
		   AND  A.CR_SYSCD  = E.CM_SYSCD
		   AND  A.CR_RSRCCD = E.CM_RSRCCD
		   AND  C.CM_SVRCD  = E.CM_SVRCD
		   AND  C.CM_SEQNO  = E.CM_SEQNO
		   AND  A.CR_SYSCD  = F.CM_SYSCD
		   AND  A.CR_DSNCD  = F.CM_DSNCD
		   AND  NOT EXISTS (SELECT  'X'
			                  FROM  CMR1011
			                 WHERE  CR_ACPTNO = A.CR_ACPTNO
			                   AND  CR_SERNO  = A.CR_SERNO
			                   AND  CR_PRCSYS = :pPrcSys
			                   AND  NVL(CR_PRCRST, 'NPRO') = '0000'
			               )
		   AND  (    A.CR_PID IS NULL
		         OR  NVL(A.CR_PUTCODE,'RTRY') = 'RTRY'
		        )
		 ORDER  BY  A.CR_PRIORITY, A.CR_SERNO;


	EXEC SQL DECLARE SYSCOM_Rsrc3_c_sub CURSOR FOR
		SELECT  A.CM_SYSOS
		      , A.CM_SEQNO
		      , A.CM_SVRIP
		      , A.CM_PORTNO
		  FROM  CMM0031 A
		      , CMM0038 B
		 WHERE  A.CM_SYSCD = :szSysCD
		   AND  A.CM_SVRCD = :szSvrCD
		   AND  A.CM_CLOSEDT IS NULL
		   AND  A.CM_SVRSTOP = 'N'
		   AND  A.CM_SYSCD = B.CM_SYSCD
		   AND  A.CM_SVRCD = B.CM_SVRCD
		   AND  A.CM_SEQNO = B.CM_SEQNO
		   AND  B.CM_RSRCCD = :szRsrcCD;

	EXEC SQL open  SYSCOM_Rsrc3_c;
    while (1) {
		EXEC SQL FETCH SYSCOM_Rsrc3_c
			INTO  :szSysCD
			    , :szDsnCD
			    , :szRsrcCD
			    , :szJobCD
			    , :szRsrcName
			    , :szVersion
			    , :szBefVer
			    , :szEditor
			    , :szSerNo
			    , :szPri
			    , :szSrcChg
			    , :szAplyDate
			    , :szItemID
			    , :szReqCD
			    , :szConfNo
			    , :szBaseItem
			    , :szQryCD
			    , :szSysGB
			    , :szSvrIP
			    , :szPortNo
			    , :szSvrCD
			    , :szSvrName
			    , :szDir
			    , :szVolPath
			    , :szSysOS
			    , :szSvrSeq
			    , :szInfo
			    , :szDirPath;

		if (sqlca.sqlcode == 1403)	break;

		if (sqlca.sqlcode != 0 && sqlca.sqlcode != -1405) {
			sprintf(gszLogMsg,"UploadSyscomRsrc DB FETCH ERROR : [%s] [%d] [%d] [%s]", pAcptNo, szSerNo, sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
			eCAMS_Log(gszLogPath, gszLogFile, gszLogMsg);
			break;
		}

		NotUseDataTruncate (szSysCD   ,	0x20);
		NotUseDataTruncate (szDsnCD   ,	0x20);
		NotUseDataTruncate (szRsrcCD  ,	0x20);
		NotUseDataTruncate (szEditor  ,	0x20);
		NotUseDataTruncate (szSrcChg  ,	0x20);
		NotUseDataTruncate (szAplyDate,	0x20);
		NotUseDataTruncate (szItemID  ,	0x20);
		NotUseDataTruncate (szReqCD   ,	0x20);
		NotUseDataTruncate (szConfNo  ,	0x20);
		NotUseDataTruncate (szBaseItem,	0x20);
		NotUseDataTruncate (szQryCD   ,	0x20);
		NotUseDataTruncate (szSysGB   ,	0x20);
		NotUseDataTruncate (szSvrIP   ,	0x20);
		NotUseDataTruncate (szSvrCD   ,	0x20);
		NotUseDataTruncate (szSvrName ,	0x20);
		NotUseDataTruncate (szDir     ,	0x20);
		NotUseDataTruncate (szVolPath ,	0x20);
		NotUseDataTruncate (szSysOS   ,	0x20);
		NotUseDataTruncate (szInfo    ,	0x20);
		NotUseDataTruncate (szPri     ,	0x20);
		NotUseDataTruncate (szJobCD   ,	0x20);
		sprintf(szRsrcName, "%s", trunc_char(szRsrcName));
		sprintf(szDirPath, "%s" , trunc_char(szDirPath ));
		strcpy(szBKRsrcName,szRsrcName);

		ChangeVolPath(szSysCD , szSvrCD, szRsrcCD, szSvrSeq, szDirPath, szChangDirPathTmp);

		/*-------------------------------------------------------*/
		/*	임시영역 컴파일                                      */
		/*-------------------------------------------------------*/
		if (cmp_mid_char(szInfo,19,1,"1") == 0) {
			EXEC SQL
				SELECT  CM_VOLPATH
				  INTO  :szChangDirPath
				  FROM  CMM0038
				 WHERE  CM_SysCD  = :szSysCD
				   AND  CM_SEQNO  = :szSvrSeq
				   AND  CM_SvrCD  = :szSvrCD
				   AND  CM_RsrcCD = :szRsrcCD;

			if (sqlca.sqlcode != 0) {
				sprintf(gszLogMsg, "SQLErrCheck 2: REAL Server 정보 오류 syscd[%s]rsrccd[%s]svrcd[%s]szSeqNo[%d] [%d] [%s]", szSysCD,szRsrcCD,szSvrCD,szSvrSeq,sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
				eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);
				exit (1);
			}

			NotUseDataTruncate (szChangDirPath, 0x20);
			sprintf(szChangDirPathTmp, "%s/%s/%s", szChangDirPath,pAcptNo, right_char(szChangDirPathTmp, strlen(szChangDirPathTmp) - strlen(szChangDirPath)));
		}

		if (cmp_right_char(szChangDirPathTmp, 1, "/") == 0){
			sprintf(szChangDirPathTmp, "%s", left_char(szChangDirPathTmp, strlen(szChangDirPathTmp) - 1));
		}

		/*-------------------------------------------------------*/
		/*	OS별 디렉토리 변환                                   */
		/*-------------------------------------------------------*/
		Convert_WinDirPath (szSysOS, szChangDirPathTmp, szChangDirPath);

		/*-------------------------------------------------------*/
		/*	결과파일명                                           */
		/*-------------------------------------------------------*/
		sprintf(szRstFile,"%s/%s.%d.%s.%d.result", gszTempPath, pAcptNo, szSerNo,szSvrIP,szSvrSeq);

		/*-------------------------------------------------------*/
		/*	개발서버에 파일저장 경로+파일명                      */
		/*-------------------------------------------------------*/
		strcpy(szRemoteFileName,szRsrcName);
		sprintf(szLocalFileName,"%s.%s.%d",szRsrcName, pAcptNo, szSerNo);
		sprintf(szLocal,"%s/%s",szReqPath,szLocalFileName);

		do {
			WaitComplete(pAcptNo, szSerNo, szSvrIP, pPrcSys,"COM", pRstCond,szSvrCD,szSvrSeq);
			if (strcmp(pRstCond,"NPRO") == 0) {
				/*-----------------------------------------------*/
				/*	신청건별 일괄 컴파일                         */
				/*-----------------------------------------------*/
				if (cmp_mid_char(szInfo,16,1,"1") == 0) {
					EXEC SQL OPEN SYSCOM_Rsrc3_c_sub;
					while (1) {
				        EXEC SQL fetch SYSCOM_Rsrc3_c_sub
				        	INTO  :szSubSysOs
				        		, :szSubSvrSeq
				        		, :szSubSvrIP
				        		, :szSubPortNo;

						if (sqlca.sqlcode == 1403)	break;

						NotUseDataTruncate (szSubSysOs, 0x20);
						NotUseDataTruncate (szSubSvrIP, 0x20);

						ChangeVolPath(szSysCD , szSvrCD, szRsrcCD, szSubSvrSeq, szDirPath, szChangDirPathTmp);

						/*---------------------------------------*/
						/*	임시영역 컴파일                      */
						/*---------------------------------------*/
						if (cmp_mid_char(szInfo,19,1,"1") == 0) {
							EXEC SQL
								SELECT  CM_VOLPATH
								  INTO  :szChangDirPath
								  FROM  CMM0038
								 WHERE  CM_SysCD  = :szSysCD
								   AND  CM_SEQNO  = :szSubSvrSeq
								   AND  CM_SvrCD  = :szSvrCD
								   AND  CM_RsrcCD = :szRsrcCD;

						    if (sqlca.sqlcode != 0) {
							   sprintf(gszLogMsg, "SQLErrCheck 2: REAL Server 정보 오류 syscd[%s]rsrccd[%s]svrcd[%s]szSeqNo[%d] [%d] [%s]", szSysCD,szRsrcCD,szSvrCD,szSubSvrSeq,sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
							   eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);
							   exit (1);
						    }

							NotUseDataTruncate (szChangDirPath, 0x20);
							sprintf(szChangDirPathTmp, "%s/%s/%s", szChangDirPath,pAcptNo, right_char(szChangDirPathTmp, strlen(szChangDirPathTmp) - strlen(szChangDirPath)));
						}

						if (cmp_right_char(szChangDirPathTmp, 1, "/") == 0){
							sprintf(szChangDirPathTmp, "%s", left_char(szChangDirPathTmp, strlen(szChangDirPathTmp) - 1));
						}

						/*---------------------------------------*/
						/*	OS별 디렉토리 변환                   */
						/*---------------------------------------*/
						Convert_WinDirPath (szSubSysOs, szChangDirPathTmp, szChangDirPath);

						/*---------------------------------------*/
						/*	결과파일명                           */
						/*---------------------------------------*/
						sprintf(szRstFile,"%s/%s.%d.%s.%d.result", gszTempPath, pAcptNo, szSerNo,szSvrIP,szSubSvrSeq);

						/*---------------------------------------*/
						/*	개발서버에 파일저장 경로+파일명      */
						/*---------------------------------------*/
						strcpy(szRemoteFileName,szRsrcName);
						sprintf(szLocalFileName,"%s.%s.%d",szRsrcName, pAcptNo, szSerNo);
						sprintf(szLocal,"%s/%s",szReqPath,szLocalFileName);

						eCAMS_ACComp_Fork("SYSCOM",pAcptNo, szSerNo, szSubSvrIP,
								    	szSysCD, szRsrcCD, szDsnCD, "3" ,szReqCD,pPrcSys,szChangDirPath,
										szRemoteFileName, szSubPortNo, "000001", szSvrCD, szSubSvrSeq,0);
					}
					EXEC SQL close SYSCOM_Rsrc3_c_sub;

					EXEC SQL
						UPDATE  CMR1010
						   SET  CR_SRCCMP = 'N'
						 WHERE  CR_ACPTNO = :pAcptNo
						   AND  CR_RSRCCD = :szRsrcCD
						   AND  CR_JOBCD  = :szJobCD;

					EXEC SQL COMMIT;
					EXEC SQL close SYSCOM_Rsrc3_c;
					EXEC SQL open  SYSCOM_Rsrc3_c;
				}
				else {
					eCAMS_ACComp_Fork("SYSCOM",pAcptNo, szSerNo, szSvrIP,
							    	szSysCD, szRsrcCD, szDsnCD, "3" ,szReqCD,pPrcSys,szChangDirPath,
									szRemoteFileName, szPortNo, "000001", szSvrCD, szSvrSeq,1);
				}
			}
		} while (strcmp(pRstCond,"NPRO") == 0);
	}
    EXEC SQL close SYSCOM_Rsrc3_c;


 	nComErrCnt = 0;
	/*-----------------------------------------------------------*/
	/*	오류건수 조회                                            */
	/*-----------------------------------------------------------*/
	EXEC SQL
		SELECT  COUNT(a.CR_SEQNO)
		  INTO  :nComErrCnt
		  FROM  CMR1011 a
		      , CMR1010 b
		 WHERE  a.CR_ACPTNO  = :pAcptNo
		   AND  b.CR_PRCDATE IS NULL
		   AND  a.CR_ACPTNO  = b.CR_ACPTNO
		   and  a.CR_SERNO   = b.CR_SERNO
		   and  b.CR_STATUS != '3'
		   AND  a.CR_PRCSYS  = :pPrcSys
		   And  NVL(a.CR_PUTCODE, 'N/A') != '0000';

	/*-----------------------------------------------------------*/
	/*	처리단계 변경                                            */
	/*-----------------------------------------------------------*/
	EXEC SQL
		UPDATE  CMR1010
		   SET  CR_SYSSTEP = DECODE(NVL(CR_PUTCODE, '0000'), '0000', 4, 2)
		      , CR_PUTCODE = DECODE(NVL(CR_PUTCODE, '0000'), '0000', NULL, CR_PUTCODE)
		      , CR_SRCCMP  = DECODE(NVL(CR_PUTCODE, '0000'), '0000', 'Y' , CR_SRCCMP )
		 WHERE  CR_ACPTNO = :pAcptNo
		   AND  CR_PRCDATE IS NULL
		   AND  NVL(CR_SYSSTEP,0) <= 3;

	if (sqlca.sqlcode != 0 && sqlca.sqlcode != 1403) {
		sprintf(gszLogMsg,"Step Update Err!!! : [%s] [%d] [%s]", pAcptNo, sqlca.sqlcode, sqlca.sqlerrm.sqlerrmc);
		eCAMS_Log(gszLogPath, gszLogFile, gszLogMsg);
		strcpy(pRstCond,"EROR");
		return sqlca.sqlcode;
	}

	EXEC SQL EXECUTE
    	BEGIN
	        UPDATE_1000STEP(:pAcptNo,:szSysStep);
        END;
    END-EXEC;

	if (sqlca.sqlcode != 0) {
		/*LOG*/sprintf(gszLogMsg,"[%s] CMR1000 SYSSTEP UPDATE ERROR [%d] [%s]", pAcptNo,sqlca.sqlcode,sqlca.sqlerrm.sqlerrmc);
		eCAMS_Log(gszLogPath,gszLogFile,gszLogMsg);
		strcpy(pRstCond,"EROR");
		return sqlca.sqlcode;
	}
	EXEC SQL COMMIT;

	if(nComErrCnt != 0) {
		strcpy(pRstCond,"EROR");
		return nComErrCnt;
	}

	strcpy(pRstCond,"0000");
	return nComErrCnt;
}


/*---------------------------------------------------------------*/
/*             E N D    O F    P R O G R A M                     */
/*---------------------------------------------------------------*/
